
<!DOCTYPE html>
<html lang="zh-Hans" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2020周阳Spring Cloud完整版笔记--一 - 肖日宁的世界</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="Access-Control-Allow-Origin" content="*" />
    <meta name="keywords" content="肖日宁,君子兰,人工智能,AI,机器学习,博客,大数据,微服务,xiaorining,kingslanding,"> 
    <meta name="description" content="肖日宁,君子兰,人工智能,AI,机器学习,博客,大数据,微服务,xiaorining,kingslanding,微服务 的概念最早产生于Martin Fowler在2014年的一篇论文中。

微服务架构是一种架构模式，他提倡将单一应用程序划分成一组小的服务，服务与服务之间互相协调、相互配合，为用户提供最终价值,"> 
    <meta name="author" content="肖日宁"> 
    <link rel="alternative" href="atom.xml" title="肖日宁的世界" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
    
<link rel="stylesheet" href="/css/diaspora.css">
<link rel="stylesheet" href="/css/APlayer.min.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body class="loading">
    <span id="config-title" style="display:none">肖日宁的世界</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="https://kingslanding.cn"></a>
        <!-- page音乐插件 -->
        
    <h3 class="subtitle">2020周阳Spring Cloud完整版笔记--一</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">2020周阳Spring Cloud完整版笔记--一</h1>
        <div class="stuff">
            <span>九月 28, 2018</span>
            
  <ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1-Spring-Cloud/" rel="tag">微服务,Spring Cloud</a></li></ul>


        </div>
        <div class="content markdown">
            <p>微服务 的概念最早产生于Martin Fowler在2014年的一篇论文中。</p>
<blockquote>
<p>微服务架构是一种架构模式，他提倡将单一应用程序划分成一组小的服务，服务与服务之间互相协调、相互配合，为用户提供最终价值。每个服务运行在独立的进程中，服务与服务之间采用轻量级的通信机制相互合作（通常是基于HTTP协议的Restful API）。每个服务围绕具体业务进行构建，并且能够被独立的部署到生产环境、类生产环境等。另外，应当尽量避免同一的、集中式的服务管理机制，对具有的一个服务而言，应当根据业务上下文，选择合适的语言、工具对其进行构建。</p>
</blockquote>
<h2 id="Cloud组件停更"><a href="#Cloud组件停更" class="headerlink" title="Cloud组件停更"></a>Cloud组件停更</h2><p>被动修复bug，停更不停用，不再github上接收新的合并请求，不再发布新的版本。</p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci9pbWcvY2xvdWQlRTUlOEQlODclRTclQkElQTctMTU5NzkwMzcwOTM2MC5wbmc.png" alt="cloud升级"></p>
<p>RestTemplate提供了多种边界访问远程HTTP服务的方法，是一种简单便捷的访问restful服务模板类，是Spring提供的用于访问Rest服务的客户端模板工具集。</p>
<p>（URL，requestMap，ResponseBean.class）这三个参数分别代表REST请求地址，请求参数，HTTP响应转换的对象类型。</p>
<h2 id="服务注册中心"><a href="#服务注册中心" class="headerlink" title="服务注册中心"></a>服务注册中心</h2><h3 id="Eureka服务注册中心"><a href="#Eureka服务注册中心" class="headerlink" title="Eureka服务注册中心"></a>Eureka服务注册中心</h3><h4 id="什么是服务治理"><a href="#什么是服务治理" class="headerlink" title="什么是服务治理"></a>什么是服务治理</h4><p>SpringCloud封装了Netflix公司开发的Eureka模块来实现服务治理。</p>
<p>在传统的RPC远程调用框架中，管理每个服务于服务之间依赖关系比较复杂，管理比较复杂，所以需要使用服务治理来管理服务与服务之间的依赖关系，可以实现服务调用、负载均衡、容错等，实现服务发现与注册。</p>
<h4 id="服务注册与发现"><a href="#服务注册与发现" class="headerlink" title="服务注册与发现"></a>服务注册与发现</h4><p>Eureka采用来CS的设计架构，Eureka Server作为服务注册功能的服务器，他是服务注册中心。而系统中的其他微服务，使用Eureka客户端连接到Eureka Server并维持心跳链接。这样系统的维护人员可以通过Eureka Server来监控系统中各个微服务是否正常运行。</p>
<p>在服务注册与发现中，有一个注册中心，当服务器启动的时候，会把当前自己服务器的信息，比如服务地址，通讯地址等以别名的方式注册到注册中心中，另一方（其实也就是消费者或者服务提供者），以别名的方式去注册中心上获取实际的服务通信地址，然后在实现本地RPC调用。</p>
<p>RPC远程调用框架的思想在于：使用注册中心管理服务与服务之间的依赖关系。在任何RPC远程框架中都会有一个注册中心。</p>
<h3 id="Eureka-Server和Eureka-Client"><a href="#Eureka-Server和Eureka-Client" class="headerlink" title="Eureka Server和Eureka Client"></a>Eureka Server和Eureka Client</h3><p><strong>Eureka Server提供服务注册</strong></p>
<p>各个微服务节点通过配置启动后，会在Eureka Server中进行注册，这样Eureka Server中的服务注册表中将会存储所有可用的节点信息，服务节点信息可以在界面中直观看到。</p>
<p><strong>Eureka Client通过注册中心进行访问</strong></p>
<p>这个客户端是用来简化Eureka Server的交互，客户端同时具备一个内置的，使用轮询负载算法的负载均衡器。在应用启动后，将会向Eureka Server发送心跳（默认是30s一次），如果Serve在多个心跳周期内（默认90s）没有接收到某个节点的心跳，那就会被Server除名（从服务注册表中将节点移除）。</p>
<p>Eureka架构图与Dubbo对比</p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci90eXBvcmEtcGljdHVyZXMvaW1nL0wzQnliM2g1TDJoMGRIQnpMMmx0WnpJd01UZ3VZMjVpYkc5bmN5NWpiMjB2WW14dlp5OHhNVE16.png" alt="img"></p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci90eXBvcmEtcGljdHVyZXMvaW1nL0wzQnliM2g1TDJoMGRIQnpMMmx0WnpJd01UZ3VZMjVpYkc5bmN5NWpiMjB2WW14dlp5OHhNVE16TkRF.png" alt="img"></p>
<p>Eureka Server模块</p>
<p>1、创建模块</p>
<p>2、导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud2020<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xzq.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-eureka-server7001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xzq.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--eureka-server--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--boot web actuator--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--一般通用配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、编写配置文件</p>
<p> application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span> <span class="comment"># eureka服务端实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment"># 不向注册中心注册自己</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span> <span class="comment"># 表示自己就是注册中心，不必检索其他服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span> <span class="comment"># 设置与 Eureka Server 交互的地址，可用来查询注册的服务</span></span><br></pre></td></tr></table></figure>

<p>4、创建主类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaMain7001</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaMain7001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5、启动server,访问<a target="_blank" rel="noopener" href="http://localhost:7001/">http://localhost:7001</a></p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci90eXBvcmEtcGljdHVyZXMvaW1nL2ltYWdlLTIwMjAwOTAyMTgwMjIwMzcwLnBuZw.png" alt="image-20200902180220370"></p>
<h3 id="Eureka集群原理"><a href="#Eureka集群原理" class="headerlink" title="Eureka集群原理"></a>Eureka集群原理</h3><p>先启动Eureka注册中心，启动服务提供者，支付服务启动后会把自身信息以别名的方式注册进Eureka，消费者order服务在需要调用接口时，使用服务别名去注册中心获取实际的远程调用地址，消费者获取调用地址后，底层使用的是HTPPClient技术实现远程调用，消费者获得服务地址后会魂村到本地JVM内存中，默认每隔30s更新一次服务调用地址。</p>
<p><strong>要实现RPC远程调用服务最核心的是高可用，但是如何实现高可用？</strong></p>
<p>方法：搭建注册中心集群，实现负载均衡+故障容错。</p>
<p>服务注册中心搭建集群，集群中的所有服务都相互注册，例如server7001，server7002，7002的eureka.client.service-url.defaultZone=<a target="_blank" rel="noopener" href="http://eureka7001.com:7001/eureka%EF%BC%8C%E8%80%8C7001%E4%B8%AD%E7%9A%84Eureka%E9%85%8D%E7%BD%AE%E6%98%AFeureka.client.service-url.defaultZone=http://eureka7002.com:7002/eureka%E3%80%82%E5%9C%A8%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB%E4%B8%8A%E6%B7%BB%E5%8A%A0%60@EnableEurekaServer%60%E6%B3%A8%E8%A7%A3%EF%BC%8C%E5%85%88%E5%90%AF%E5%8A%A8%E8%BF%99%E4%BA%9B%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%86%8D%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%EF%BC%8C%E6%9C%80%E5%90%8E%E5%90%AF%E5%8A%A8%E6%B6%88%E8%B4%B9%E8%80%85%E3%80%82">http://eureka7001.com:7001/eureka，而7001中的Eureka配置是eureka.client.service-url.defaultZone=http://eureka7002.com:7002/eureka。在主启动类上添加`@EnableEurekaServer`注解，先启动这些注册中心服务，再启动服务提供者，最后启动消费者。</a></p>
<h3 id="服务发现Discovery"><a href="#服务发现Discovery" class="headerlink" title="服务发现Discovery"></a>服务发现Discovery</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/payment&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/discover&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">discovery</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;String&gt; services = discoClient.getServices();</span><br><span class="line">        <span class="keyword">for</span> (String service : services) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;service====&quot;</span>+service);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;ServiceInstance&gt; instances =  discoClient.getInstances(<span class="string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (ServiceInstance instance : instances) &#123;</span><br><span class="line">            log.info(instance.getInstanceId()+<span class="string">&quot;\t&quot;</span>+instance.getHost()+<span class="string">&quot;\t&quot;</span>+instance.getPort()+<span class="string">&quot;\t&quot;</span>+instance.getUri());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.discoClient;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在主启动类上添加<code>@EnableDiscoveryClient</code>注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Payment8002</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Payment8002.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过浏览器访问<code>localhost:8001/payment/discover</code></p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci90eXBvcmEtcGljdHVyZXMvaW1nL2ltYWdlLTIwMjAwOTAzMjEzNTA0Nzc3LnBuZw.png" alt="image-20200903213504777"></p>
<h3 id="Eureka的自我保护"><a href="#Eureka的自我保护" class="headerlink" title="Eureka的自我保护"></a>Eureka的自我保护</h3><p>所谓的保护模式就是用于一组客户端和Eureka Server之间存在网络分区场景下的保护。一旦进入保护模式，Eureka Server将会尝试保护其服务注册表中的信息，不再删除服务注册表中的数据，也就是不会注销任何微服务。</p>
<p>如果在Eureka Server的首页看到以下这段提示，则说明Eureka进入了保护模式：</p>
<p><strong>EMERGENCY! EUREKA MAY BE INCORRECTLY CLAIMING INSTANCES ARE UP WHEN THEY’RE NOT. RENEWALS ARE LESSER THAN THRESHOLD AND HENCE THE INSTANCES ARE NOT BEING EXPIRED JUST TO BE SAFE.</strong></p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci90eXBvcmEtcGljdHVyZXMvaW1nL2ltYWdlLTIwMjAwOTAzMjE0NTI2NzAxLnBuZw.png" alt="image-20200903214526701"></p>
<p>一句话：在某时刻一个微服务不可用，Eureka不会立刻清理，依旧会对改为服务的信息进行保护。</p>
<p>这是属于CAP里面的AP分支。</p>
<h3 id="怎样禁止自我保护？"><a href="#怎样禁止自我保护？" class="headerlink" title="怎样禁止自我保护？"></a>怎样禁止自我保护？</h3><p>在Eureka-server中，修改配置文件，添加</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001.com</span>  <span class="comment"># eureka服务端实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment"># 不向注册中心注册自己</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span> <span class="comment"># 表示自己就是注册中心，不必检索其他服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7002.com:7002/eureka/</span> <span class="comment"># 设置与 Eureka Server 交互的地址，可用来查询注册的服务</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001.com</span>  <span class="comment"># eureka服务端实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment"># 不向注册中心注册自己</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span> <span class="comment"># 表示自己就是注册中心，不必检索其他服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7002.com:7002/eureka/</span> <span class="comment"># 设置与 Eureka Server 交互的地址，可用来查询注册的服务</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span> <span class="comment"># 关闭自我检测</span></span><br><span class="line">    <span class="attr">eviction-interval-timer-in-ms:</span> <span class="number">2000</span> <span class="comment"># 修改检查心跳时间 默认是30s，现在改成2s。</span></span><br></pre></td></tr></table></figure>

<p>enable-self-preservation: false # 关闭自我检测，一旦关闭自我检测，其中有任何一台微服务宕机，Eureka就会立刻将他从注册中心除名。</p>
<p>将其中的一个服务提供者的配置也更改如下。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span> <span class="comment"># 默认是true表示将自己注册进服务中心</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span> <span class="comment"># 默认是true表示抓取已有的注册中心，如果是集群必须进行配置</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span> <span class="comment"># 单机版</span></span><br><span class="line">      <span class="comment">#defaultZone: http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8001</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment"># 代表路径可以显示IP地址信息</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">2</span> <span class="comment">#Eureka在收到最后一次心跳后，等待的时间默认是90s，如果超过等待时间，将会剔除服务</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">1</span> <span class="comment"># 客户端默认间隔30s 向服务端发送心跳，现在每间隔1s向服务端发送心跳。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.lease-expiration-duration-in-seconds&#x3D;2</span><br><span class="line">eureka.instance.lease-renewal-interval-in-seconds&#x3D;1</span><br></pre></td></tr></table></figure>

<p>客户端默认间隔是30s，向服务端发送心跳，改成每隔1s向服务端发送心跳。</p>
<p>启动服务后，访问<a target="_blank" rel="noopener" href="http://eureka7001.com:7001/">http://eureka7001.com:7001/</a></p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci90eXBvcmEtcGljdHVyZXMvaW1nL2ltYWdlLTIwMjAwOTA0MTExMjUxNTk5LnBuZw.png" alt="image-20200904111251599"></p>
<p>当关闭payment8001服务提供者后，实例立即消失。</p>
<p>使用zookeeper作服务发现与注册时，服务节点是临时节点。当服务关闭时，zookeeper会立即去除实例。</p>
<p>导入zookeeper相关的依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringBoot整合Web组件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xzq.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringBoot整合zookeeper客户端 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zookeeper-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--先排除自带的zookeeper3.5.3--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--添加zookeeper3.4.9版本--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">  port: 8004</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: cloud-provider-payment #微服务实例名</span><br><span class="line">  cloud:</span><br><span class="line">    zookeeper:</span><br><span class="line">      connect-string: localhost:2181 #zookeeper服务所在的IP地址，默认端口是2181</span><br></pre></td></tr></table></figure>

<p>之后启动zookeeper服务，并打开zkCli.sh，ls /services，会发现实例名成是cloud-provider-payment。</p>
<h3 id="Consul简介"><a href="#Consul简介" class="headerlink" title="Consul简介"></a>Consul简介</h3><p>官网地址:<a target="_blank" rel="noopener" href="https://www.consul.io/docs">https://www.consul.io/docs</a></p>
<p>Consul是一套开源的分布式服务发现和配置管理系统，有<code>HashiCorp</code>公司使用<code>Go</code>语言开发。</p>
<p>提供了微服务系统中的<strong>服务治理、配置中心、控制总线</strong>等功能。</p>
<p>这些功能中的每一个否可以根据自己的需要单独使用，也可以一起使用构成全方面的服务网格，总之Consul提供了一种完整的服务网格解决方案。</p>
<p>它具有很多优点。包括：基于raft协议，比较简洁；支持健康检查，同时支持HTTP和DNS协议支持扩数据中心的WAN集群，提供图形界面 扩平台支持，例如Linux，Mac，Windows。</p>
<h4 id="Consul安装与配置"><a href="#Consul安装与配置" class="headerlink" title="Consul安装与配置"></a>Consul安装与配置</h4><p>Consul下载地址： <a target="_blank" rel="noopener" href="https://www.consul.io/downloads">https://www.consul.io/downloads</a></p>
<p>选择你所对应的版本，下载压缩包后，直接解压。</p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci90eXBvcmEtcGljdHVyZXMvaW1nL2ltYWdlLTIwMjAwOTA1MTA1NTE4MzE2LnBuZw.png" alt="image-20200905105518316"></p>
<p>解压完成后，只有一个consul.exe文件，通过cmd窗口，输入<code>consul agent -dev</code> 启动，然后通过浏览器访问localhost:8500,得到以下界面，算是安装完成了。</p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci90eXBvcmEtcGljdHVyZXMvaW1nL2ltYWdlLTIwMjAwOTA1MTA1ODA0MjczLnBuZw.png" alt="image-20200905105804273"></p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci90eXBvcmEtcGljdHVyZXMvaW1nL2ltYWdlLTIwMjAwOTA1MTEwMDEzNzI5LnBuZw.png" alt="image-20200905110013729"></p>
<h3 id="CAP原则"><a href="#CAP原则" class="headerlink" title="CAP原则"></a>CAP原则</h3><p>最多只能同时满足两个。</p>
<p>CAP理论的核心就是：一个分布式系统不可能同时很好的满足一致性，可用性和分区容错性，这三个需求。</p>
<p>因此，根据CAP原理将NoSQL数据库分成了满足CA原则，满足CP原则和满足AP原则三大类。</p>
<p>CA-单点集群，满足一致性，可用性的系统，通常在可扩展性上不强大。</p>
<p>CP-满足一致性，分区容错性，通常性能上有所损失。（Zookeeper/Consul）</p>
<p>AP-满足可用性，分区容错性的系统，通常可能对一致性的要其余不是很严格。（Eureka）</p>
<table>
<thead>
<tr>
<th>组件名</th>
<th>语言</th>
<th>CAP</th>
<th>服务健康检测</th>
<th>对外暴露接口</th>
<th>SpringCloud集成</th>
</tr>
</thead>
<tbody><tr>
<td>Eureka</td>
<td>Java</td>
<td>AP</td>
<td>可配支持</td>
<td>HTTP</td>
<td>已集成</td>
</tr>
<tr>
<td>Consul</td>
<td>Go</td>
<td>CP</td>
<td>支持</td>
<td>HTTP/DNS</td>
<td>已集成</td>
</tr>
<tr>
<td>Zookeeper</td>
<td>Java</td>
<td>CP</td>
<td>支持</td>
<td>客户端</td>
<td>已集成</td>
</tr>
</tbody></table>
<h3 id="Ribbon简单概述"><a href="#Ribbon简单概述" class="headerlink" title="Ribbon简单概述"></a>Ribbon简单概述</h3><p>SpringCloud Ribbon是基于Netflix Ribbon实现的一套客户端。（负载均衡工具）</p>
<p>简单的说，Ribbon是Netflix发布的开源项目，主要功能是<strong>提供客户端的软件负载均衡算法和服务调用</strong>。Ribbon客户端主键提供一系列完善的配置项：如连接超时，重试等。简单的说，就是在配置文件中列出Load Blance后面的所有机器，Ribbon会自动帮助你基于某种规则去连接这些机器。我们很容易使用Ribbon实现自定义的负载均衡算法。</p>
<p>虽然现在Ribbon已经停止维护，但是还是有不少人使用。</p>
<p>主要的模块有Ribbon-HTTPClient，Ribbon-eureka，Ribbon-Loadbalance</p>
<h3 id="所谓的负载均衡是什么？"><a href="#所谓的负载均衡是什么？" class="headerlink" title="所谓的负载均衡是什么？"></a>所谓的负载均衡是什么？</h3><p>简单的说就是将用户的请求分发到多个服务上，从而达到系统的高可用。</p>
<p>常见的负载均衡有Nginx，LVS，硬件F5等。</p>
<h3 id="Ribbon本地负载均衡VS-Nginx服务端负载均衡"><a href="#Ribbon本地负载均衡VS-Nginx服务端负载均衡" class="headerlink" title="Ribbon本地负载均衡VS Nginx服务端负载均衡"></a><code>Ribbon</code>本地负载均衡VS <code>Nginx</code>服务端负载均衡</h3><p>Nginx是服务器负载均衡，客户端所有请求都会交给Nginx，然后由Nginx实现转发请求。即负载均衡是服务端实现的。</p>
<p>Ribbon是本地负载均衡，在调用微服务接口的时候，会在注册中心上获取注册信息，缓存到JVM本地，从而在本地实现RPC远程调用服务技术。</p>
<p>Ribbon负载均衡是客户端本地的负载均衡，分为集中式和进程内。</p>
<p><strong>集中式</strong></p>
<p>在服务的消费方和提供方之间使用独立的负载均衡设施(可以是硬件，如F5，也可以是软件，如Nginx),由该设施负责访问请求，通过某种策略转发到服务的提供方。</p>
<p><strong>进程式</strong></p>
<p>将负载均衡的逻辑集成到消费方，消费方从服务注册中心获知有哪些地址可用，然后自己再从这些地址中选择出一个合适的服务器。Ribbon属于进程内的负载均衡。他是一个类库，继承消费方进程，消费方通过它来获取到服务提供方的地址。</p>
<p>Ribbon是一个软负载均衡的客户端组件，它可以和其他所需请求的客户端结合使用，例如Eureka，RestTemplate等。</p>
<p>Ribbon的工作原理：第一步先选择EurekaServer，他会优先选择在同一个区域内负载均衡较少的Server。</p>
<p>第二步再根据用户指定的策略，从Server取到的服务注册列表中选择一个地址。</p>
<p>其中Ribbon提供了多种策略：比如轮询，随机，根据响应时间加权等。</p>
<p>Ribbon依赖如下。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-ribbon<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>默认情况下，Eureka-client依赖中包含有ribbon的依赖，不需要再次引入。</p>
<p>RestTemplate中的getForEntity方法返回的是对象，getForObject方法返回的是JSON串。</p>
<h3 id="Ribbon的核心组件IRule"><a href="#Ribbon的核心组件IRule" class="headerlink" title="Ribbon的核心组件IRule"></a>Ribbon的核心组件IRule</h3><p>Ribbon默认的负载均衡算法是轮询，而IRule是根据特定的算法中从服务列表中选取其中一个要访问的服务。</p>
<p>一共有7个方法。</p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci90eXBvcmEtcGljdHVyZXMvaW1nL2ltYWdlLTIwMjAwOTA1MTYzNzMyMjMyLnBuZw.png" alt="image-20200905163732232"></p>
<h3 id="修改负载均衡算法"><a href="#修改负载均衡算法" class="headerlink" title="修改负载均衡算法"></a>修改负载均衡算法</h3><p>将默认的轮询改为随机。</p>
<p>首先增加配置类，需要注意的是，自定义的配置类不能被@ComponentScan注解扫描到，所以自定义的IRule不要放在启动类的子目录，要与启动类隔离开。</p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci90eXBvcmEtcGljdHVyZXMvaW1nL2ltYWdlLTIwMjAwOTA1MTYyMDM3NTkwLnBuZw.png" alt="image-20200905162037590"></p>
<p>MySelfRule类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySelfRule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IRule <span class="title">getRule</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 负载均衡算法改为随机</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RandomRule();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二步，需要在主启动类上添加<code>@RibbonClient</code>注解。然后再启动。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@RibbonClient(name = &quot;CLOUD-PAYMENT-SERVICE&quot;,configuration = MySelfRule.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderMain80</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderMain80.class,args    );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动Eureka-server，启动服务提供者payment8001,payment8002，启动服务消费者consumer-order80.</p>
<p>访问<a target="_blank" rel="noopener" href="http://localhost/consumer/payment/getForEntity/1001%EF%BC%8C%E4%BC%9A%E5%8F%91%E7%8E%B0%E8%A2%AB%E8%AE%BF%E9%97%AE%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%E7%9A%84%E7%AB%AF%E5%8F%A3%E6%98%AF%E9%9A%8F%E6%9C%BA%E5%8F%98%E5%8C%96%E7%9A%84%EF%BC%8C%E5%9B%A0%E6%AD%A4%E9%80%89%E5%8F%96%E7%9A%84%E6%9C%8D%E5%8A%A1%E4%B9%9F%E6%98%AF%E9%9A%8F%E6%9C%BA%E7%9A%84%E3%80%82">http://localhost/consumer/payment/getForEntity/1001，会发现被访问的服务提供者的端口是随机变化的，因此选取的服务也是随机的。</a></p>
<h3 id="Ribbon负载均衡算法原理"><a href="#Ribbon负载均衡算法原理" class="headerlink" title="Ribbon负载均衡算法原理"></a>Ribbon负载均衡算法原理</h3><p>轮询方法：rest接口第几次请求数对服务集群总数量取余操作，得到结果就是实际调用服务器的下标，每次服务器重启后rest接口计数从1开始。</p>
<p>例如有两台服务提供者，instances[0] = 127.0.0.1:8001,instances[1] = 127.0.0.1:8002，两台实例作为两台机器，集群总数是2，按照轮询算法原理。</p>
<p>当第1请求时， 1%2 = 1，所以获取服务地址是127.0.0.1:8001；</p>
<p>当第2请求时， 2%2 = 0，所以获取服务地址是127.0.0.1:8002；</p>
<p>当第3请求时， 3%2 = 1，所以获取服务地址是127.0.0.1:8001；</p>
<p>当第4请求时， 4%2 = 0，所以获取服务地址是127.0.0.1:8002；</p>
<p>以此类推…</p>
<h3 id="手写轮询负载均衡算法"><a href="#手写轮询负载均衡算法" class="headerlink" title="手写轮询负载均衡算法"></a>手写轮询负载均衡算法</h3><p>首先创建一个MyLoadBalance接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyLoadBalance</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">     <span class="function">ServiceInstance <span class="title">instances</span><span class="params">(List&lt;ServiceInstance&gt; serviceInstances)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口的实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLoadBalanceImpl</span> <span class="keyword">implements</span> <span class="title">MyLoadBalance</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 原子操作类，底层使用的是CAS</span></span><br><span class="line">    <span class="keyword">private</span> AtomicInteger atomicInteger = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndIncrement</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> current = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> next;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            current = <span class="keyword">this</span>.atomicInteger.get();</span><br><span class="line">            next = current &gt; <span class="number">2147483647</span> ? <span class="number">0</span>: current+<span class="number">1</span>;</span><br><span class="line">            <span class="comment">//如果CAS自增操作成功，就会退出循环（当期望值是current时才会更改称为next，否则一直自旋）</span></span><br><span class="line">        &#125;<span class="keyword">while</span> (!<span class="keyword">this</span>.atomicInteger.compareAndSet(current,next));</span><br><span class="line">        log.info(<span class="string">&quot;next= &quot;</span>+next);</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServiceInstance <span class="title">instances</span><span class="params">(List&lt;ServiceInstance&gt; serviceInstances)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 服务提供者下标 = 自增的数据 % 服务提供者总数</span></span><br><span class="line">        <span class="keyword">int</span> index = getAndIncrement() % serviceInstances.size();</span><br><span class="line">        <span class="comment">// 选取成功后返回</span></span><br><span class="line">        <span class="keyword">return</span> serviceInstances.get(index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务消费者使用这种轮询方法，选取服务提供者。orderController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/consumer/payment/lb&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getPaymentUrl</span><span class="params">()</span></span>&#123;</span><br><span class="line">      String serviceID = <span class="string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>;</span><br><span class="line">      List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(serviceID);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (instances == <span class="keyword">null</span> || instances.size() &lt;=<span class="number">0</span>)&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      ServiceInstance instances1 = loadBalance.instances(instances);</span><br><span class="line">      URI uri = instances1.getUri();</span><br><span class="line">      log.info(<span class="string">&quot;url= &quot;</span>+uri);</span><br><span class="line">      <span class="keyword">return</span>  restTemplate.getForObject(uri+<span class="string">&quot;/payment/lb&quot;</span>,String.class);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="OpenFeign的基本概念"><a href="#OpenFeign的基本概念" class="headerlink" title="OpenFeign的基本概念"></a><code>OpenFeign</code>的基本概念</h3><p>Feign是一个声明式WebService客户端。使用Feign能让编写WebService客户端更加简单。</p>
<p>他的使用方法是：定义一个服务接口然后在上面添加注解。Feign也能支持可拔插式的编码器和解码器。Spring Cloud对Feign进行了封装，使其能够支持SpringMVC标准注解和HttpMessageConverters。Feign可以与Eureka和Ribbon组合使用完成负载均衡。</p>
<p>Feign旨在使Java Http客户端变得更加容易。</p>
<p>前面在使用Ribbon+RestTemplate时，利用RestTemplate对Http请求做封装处理，形成一套模板话的调用方法。但是在实际开发中，由于对服务依赖的调用可能不止一处，往往一个接口会被多处调用。所以，Feign在此基础上做了进一步的封装，由他来帮助我们定义和实现接口。在Feign的实现下，我们只需要使用注解配置接口，即可完成对服务提供方的接口绑定，简化了使用Spring Cloud Ribbon时，自己封装服务调用的工作量。</p>
<p>还有一点，默认Feign也已经集成了Ribbon。</p>
<h3 id="OpenFeign的使用"><a href="#OpenFeign的使用" class="headerlink" title="OpenFeign的使用"></a>OpenFeign的使用</h3><p>1、新建cloud-consumer-fegin-order80模块，</p>
<p>2、修改pom.xml</p>
<p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--entity--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xzq.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--openfeign--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--eureka client--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--web--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--一般基础通用配置--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、创建application.yml配置文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4、写主启动类</p>
<p>注意是@Feign注解生效，需要在主启动类上添加@EnableFeignClients。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenFeignMain80</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OpenFeignMain80.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、编写业务类</p>
<p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;CLOUD-PAYMENT-SERVICE&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentFeignService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">CommonResult&lt;Payment&gt; <span class="title">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderFeignController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentFeignService paymentFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>&#123;</span><br><span class="line">           <span class="keyword">return</span>  paymentFeignService.getPaymentById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6、测试feign功能</p>
<p>启动两个Eureka-server，启动payment-8001，payment-8002，然后再启动feign-order80.</p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci90eXBvcmEtcGljdHVyZXMvaW1nL2ltYWdlLTIwMjAwOTA1MjA0NjEyMDY3LnBuZw.png" alt="image-20200905204612067"></p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci90eXBvcmEtcGljdHVyZXMvaW1nL2ltYWdlLTIwMjAwOTA1MjA0NzM1MDMzLnBuZw.png" alt="image-20200905204735033"></p>
<h3 id="OpenFeign的超时控制"><a href="#OpenFeign的超时控制" class="headerlink" title="OpenFeign的超时控制"></a>OpenFeign的超时控制</h3><p>问题描述：在消费者向服务提供者发起请求到最后完成响应的过程中，如果服务提供者在处理过程中消耗的时间大于客户端消费者等待的时间，客户端就会<code>java.net.SocketTimeoutException: Read timed out</code>抛出异常。</p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci90eXBvcmEtcGljdHVyZXMvaW1nL2ltYWdlLTIwMjAwOTA1MjEwNzUxNjY4LnBuZw.png" alt="image-20200905210751668"></p>
<p>解决方法：在配置文件中，修改客户端读取时间和连接时间尽量让消费者等待的时间大于提供者处理的时间。这个也就是Feign的超时控制。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># s设置feign的超时时间，OpenFeign默认只此Ribbon</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="comment"># 在两端正常情况下，网络连接所用的时间</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">5000</span></span><br><span class="line"> <span class="comment"># 建立连接后从服务器读取到可用资源所用的时间</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>

<h3 id="OpenFeign的日志增强"><a href="#OpenFeign的日志增强" class="headerlink" title="OpenFeign的日志增强"></a>OpenFeign的日志增强</h3><p>支持的日志级别</p>
<ul>
<li>NONE：默认的，不显示任何日志</li>
<li>BASIC：仅仅记录请求方法、URL、响应状态码以及执行时间</li>
<li>HEADERS：除了BASIC中定义的信息之外，还有请求和响应的头信息</li>
<li>FULL：除了HEADERS中定义的信息之外，还有请求和响应的正文以及元数据。</li>
</ul>
<p>要想在控制台中查看详细日志，需要设置配置类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeginLogConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.<span class="function">Level <span class="title">feignLogger</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> feign.Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件中添加需要打印日志的请求方法路径。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">   <span class="attr">com.guigu.service.PaymentFeignService:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<p>启动服务后，向服务提供方发起请求，在控制台上可以看到以下日志。</p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci90eXBvcmEtcGljdHVyZXMvaW1nL2ltYWdlLTIwMjAwOTA1MjEyODA2MTkyLnBuZw.png" alt="image-20200905212806192"></p>
<p><img src="/../images/2020%E5%91%A8%E9%98%B3SpringCloud%E5%AE%8C%E6%95%B4%E7%89%88%E7%AC%94%E8%AE%B0--%E4%B8%80/aHR0cHM6Ly9naXRlZS5jb20vYmFpbGVmb2xlbi90eXBvcmEtcGljdHVyZXMvcmF3L21hc3Rlci90eXBvcmEtcGljdHVyZXMvaW1nL2ltYWdlLTIwMjAwOTA1MjEyODQ1NzQ3LnBuZw.png" alt="image-20200905212845747"></p>
<p>未完待续…<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43672652/article/details/108453456">下一篇：Hystrix</a></p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV18E411x7eT">https://www.bilibili.com/video/BV18E411x7eT</a></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
		data-enable='false'
        data-ae='false'
        data-ci=''
        data-cs=''
        data-r=''
        data-o=''
        data-a=''
        data-d='false'
    >查看评论</div>


    </div>
    
        <div class='side'>
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Cloud%E7%BB%84%E4%BB%B6%E5%81%9C%E6%9B%B4"><span class="toc-number">1.</span> <span class="toc-text">Cloud组件停更</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">2.</span> <span class="toc-text">服务注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">2.1.</span> <span class="toc-text">Eureka服务注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86"><span class="toc-number">2.1.1.</span> <span class="toc-text">什么是服务治理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="toc-number">2.1.2.</span> <span class="toc-text">服务注册与发现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka-Server%E5%92%8CEureka-Client"><span class="toc-number">2.2.</span> <span class="toc-text">Eureka Server和Eureka Client</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E9%9B%86%E7%BE%A4%E5%8E%9F%E7%90%86"><span class="toc-number">2.3.</span> <span class="toc-text">Eureka集群原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0Discovery"><span class="toc-number">2.4.</span> <span class="toc-text">服务发现Discovery</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E7%9A%84%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4"><span class="toc-number">2.5.</span> <span class="toc-text">Eureka的自我保护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%8E%E6%A0%B7%E7%A6%81%E6%AD%A2%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4%EF%BC%9F"><span class="toc-number">2.6.</span> <span class="toc-text">怎样禁止自我保护？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Consul%E7%AE%80%E4%BB%8B"><span class="toc-number">2.7.</span> <span class="toc-text">Consul简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Consul%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="toc-number">2.7.1.</span> <span class="toc-text">Consul安装与配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CAP%E5%8E%9F%E5%88%99"><span class="toc-number">2.8.</span> <span class="toc-text">CAP原则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ribbon%E7%AE%80%E5%8D%95%E6%A6%82%E8%BF%B0"><span class="toc-number">2.9.</span> <span class="toc-text">Ribbon简单概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E8%B0%93%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">2.10.</span> <span class="toc-text">所谓的负载均衡是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ribbon%E6%9C%AC%E5%9C%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1VS-Nginx%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">2.11.</span> <span class="toc-text">Ribbon本地负载均衡VS Nginx服务端负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ribbon%E7%9A%84%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6IRule"><span class="toc-number">2.12.</span> <span class="toc-text">Ribbon的核心组件IRule</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="toc-number">2.13.</span> <span class="toc-text">修改负载均衡算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%8E%9F%E7%90%86"><span class="toc-number">2.14.</span> <span class="toc-text">Ribbon负载均衡算法原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E5%86%99%E8%BD%AE%E8%AF%A2%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="toc-number">2.15.</span> <span class="toc-text">手写轮询负载均衡算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenFeign%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">2.16.</span> <span class="toc-text">OpenFeign的基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenFeign%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">2.17.</span> <span class="toc-text">OpenFeign的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenFeign%E7%9A%84%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6"><span class="toc-number">2.18.</span> <span class="toc-text">OpenFeign的超时控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenFeign%E7%9A%84%E6%97%A5%E5%BF%97%E5%A2%9E%E5%BC%BA"><span class="toc-number">2.19.</span> <span class="toc-text">OpenFeign的日志增强</span></a></li></ol></li></ol>	
        </div>
    
</div>


    </div>
</div>
</body>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>
<script src="//cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/meting@2.0.1/dist/Meting.min.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>




</html>
