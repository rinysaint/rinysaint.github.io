
<!DOCTYPE html>
<html lang="zh-Hans" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kubernetes(K8S)集群管理Docker容器（部署篇） - 萧日宁的世界</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="Access-Control-Allow-Origin" content="*" />
    <meta name="keywords" content="萧日宁,肖日宁,君子兰,人工智能,AI,机器学习,博客,大数据,微服务,xiaorining,kingslanding,docker,Kubernetes"> 
    <meta name="description" content="萧日宁,肖日宁,君子兰,人工智能,AI,机器学习,博客,大数据,微服务,xiaorining,kingslanding,今天这篇文章教给大家如何快速部署一套Kubernetes集群。K8S集群部署有几种方式：kubeadm、minikube和二进制包。前两者属于自动部署，简化部署操作，并且minikube只是单机测试,"> 
    <meta name="author" content="萧日宁"> 
    <link rel="alternative" href="atom.xml" title="萧日宁的世界" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
    
<link rel="stylesheet" href="/css/diaspora.css">
<link rel="stylesheet" href="/css/APlayer.min.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body class="loading">
    <span id="config-title" style="display:none">萧日宁的世界</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="https://www.aichn.cn"></a>
        <!-- page音乐插件 -->
        
    <h3 class="subtitle">Kubernetes(K8S)集群管理Docker容器（部署篇）</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">Kubernetes(K8S)集群管理Docker容器（部署篇）</h1>
        <div class="stuff">
            <span>十月 23, 2019</span>
            
  <ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/docker/" rel="tag">docker</a></li></ul>


        </div>
        <div class="content markdown">
            <p>今天这篇文章教给大家如何快速部署一套Kubernetes集群。K8S集群部署有几种方式：kubeadm、minikube和二进制包。前两者属于自动部署，简化部署操作，并且minikube只是单机测试，而kubeadm还是beta版，强烈推荐初学者使用二进制包部署，因为自动部署屏蔽了很多细节，使得对各个模块感知很少，非常不利用学习。</p>
<p>所以，这篇文章也是使用二进制包部署Kubernetes集群。</p>
<p><strong>本章目录</strong></p>
<p><a target="_blank" rel="noopener" href="https://s4.51cto.com/oss/201711/20/dfa248862503ddc2fef41329ff925866.png"><img src="/../images/Kubernetes(K8S)%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86Docker%E5%AE%B9%E5%99%A8%EF%BC%88%E9%83%A8%E7%BD%B2%E7%AF%87%EF%BC%89/dfa248862503ddc2fef41329ff925866.png" alt="Kubernetes(K8S)集群管理Docker容器（部署篇）_kubernetes"></a></p>
<p>一、架构拓扑图</p>
<p><a target="_blank" rel="noopener" href="https://s5.51cto.com/oss/201711/20/53e0a846f89d2cdcd6b194b90e852f76.png"><img src="/../images/Kubernetes(K8S)%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86Docker%E5%AE%B9%E5%99%A8%EF%BC%88%E9%83%A8%E7%BD%B2%E7%AF%87%EF%BC%89/53e0a846f89d2cdcd6b194b90e852f76.png" alt="Kubernetes(K8S)集群管理Docker容器（部署篇）_k8s_02"></a></p>
<p>二、环境规划</p>
<table>
<thead>
<tr>
<th><strong>角色</strong></th>
<th><strong>IP</strong></th>
<th><strong>组件</strong></th>
</tr>
</thead>
<tbody><tr>
<td>master</td>
<td>192.168.0.211</td>
<td>etcdkube-apiserverkube-controller-managerkube-scheduler</td>
</tr>
<tr>
<td>node01</td>
<td>192.168.0.212</td>
<td>kubeletkube-proxydocker</td>
</tr>
<tr>
<td>node02</td>
<td>192.168.0.213</td>
<td>kubeletkube-proxydocker</td>
</tr>
</tbody></table>
<p><strong>环境说明：</strong></p>
<p>操作系统：Ubuntu16.04 or CentOS7</p>
<p>Kubernetes版本：v1.8.3</p>
<p>Docker版本：v17.09-ce</p>
<p>均采用当前最新稳定版本。</p>
<p>关闭selinux。</p>
<p>三、部署集群</p>
<h2 id="3-1-下载二进制包"><a href="#3-1-下载二进制包" class="headerlink" title="3.1 下载二进制包"></a>3.1 下载二进制包</h2><p>打开下面网址，下载下面两个红色框框的包。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.8.md#v183"> https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.8.md#v183</a></p>
<p> <a target="_blank" rel="noopener" href="https://s5.51cto.com/oss/201711/20/1e610818c915f4f97dafc14a19aa94fc.png"><img src="/../images/Kubernetes(K8S)%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86Docker%E5%AE%B9%E5%99%A8%EF%BC%88%E9%83%A8%E7%BD%B2%E7%AF%87%EF%BC%89/1e610818c915f4f97dafc14a19aa94fc.png" alt="Kubernetes(K8S)集群管理Docker容器（部署篇）_k8s_03"></a></p>
<p><a target="_blank" rel="noopener" href="https://s2.51cto.com/oss/201711/20/27ff88ecd5201140479dda9b02033c83.png"><img src="/../images/Kubernetes(K8S)%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86Docker%E5%AE%B9%E5%99%A8%EF%BC%88%E9%83%A8%E7%BD%B2%E7%AF%87%EF%BC%89/27ff88ecd5201140479dda9b02033c83.png" alt="Kubernetes(K8S)集群管理Docker容器（部署篇）_k8s_04"></a></p>
<p>下载完成后，上传到服务器：</p>
<p>kubernetes-server-linux-amd64.tar.gz上传到master节点。</p>
<p>kubernetes-node-linux-amd64.tar.gz 上传到node节点。</p>
<h2 id="3-2-安装etcd3"><a href="#3-2-安装etcd3" class="headerlink" title="3.2  安装etcd3"></a>3.2  安装etcd3</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">k8s-master<span class="comment"># yum install etcd –y</span></span><br><span class="line">k8s-master<span class="comment"># vi /etc/etcd/etcd.conf </span></span><br><span class="line">ETCD_NAME=<span class="string">&quot;default&quot;</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/default&quot;</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;http://0.0.0.0:2379&quot;</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=http://0.0.0.0:2379</span><br><span class="line">k8s-master<span class="comment"># systemctl enable etcd</span></span><br><span class="line">k8s-master<span class="comment"># systemctl start etcd</span></span><br></pre></td></tr></table></figure>



<p>注意：Ubuntu系统etcd配置文件在/etc/default/etcd。</p>
<h2 id="3-3-运行Master节点组件"><a href="#3-3-运行Master节点组件" class="headerlink" title="3.3 运行Master节点组件"></a>3.3 运行Master节点组件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">k8s-master<span class="comment"># tar zxvf kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line">k8s-master<span class="comment"># mkdir -p /opt/kubernetes/&#123;bin,cfg&#125;</span></span><br><span class="line">k8s-master<span class="comment"># mv kubernetes/server/bin/&#123;kube-apiserver,kube-scheduler,kube-controller-manager,kubectl&#125; /opt/kubernetes/bin</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-1-apiserver"><a href="#3-3-1-apiserver" class="headerlink" title="3.3.1 apiserver"></a>3.3.1 apiserver</h3><p>创建配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /opt/kubernetes/cfg/kube-apiserver</span></span><br><span class="line"><span class="comment"># 启用日志标准错误</span></span><br><span class="line">KUBE_LOGTOSTDERR=<span class="string">&quot;--logtostderr=true&quot;</span></span><br><span class="line"><span class="comment"># 日志级别</span></span><br><span class="line">KUBE_LOG_LEVEL=<span class="string">&quot;--v=4&quot;</span></span><br><span class="line"><span class="comment"># Etcd服务地址</span></span><br><span class="line">KUBE_ETCD_SERVERS=<span class="string">&quot;--etcd-servers=http://192.168.0.211:2379&quot;</span></span><br><span class="line"><span class="comment"># API服务监听地址</span></span><br><span class="line">KUBE_API_ADDRESS=<span class="string">&quot;--insecure-bind-address=0.0.0.0&quot;</span></span><br><span class="line"><span class="comment"># API服务监听端口</span></span><br><span class="line">KUBE_API_PORT=<span class="string">&quot;--insecure-port=8080&quot;</span></span><br><span class="line"><span class="comment"># 对集群中成员提供API服务地址</span></span><br><span class="line">KUBE_ADVERTISE_ADDR=<span class="string">&quot;--advertise-address=192.168.0.211&quot;</span></span><br><span class="line"><span class="comment"># 允许容器请求特权模式，默认false</span></span><br><span class="line">KUBE_ALLOW_PRIV=<span class="string">&quot;--allow-privileged=false&quot;</span></span><br><span class="line"><span class="comment"># 集群分配的IP范围</span></span><br><span class="line">KUBE_SERVICE_ADDRESSES=<span class="string">&quot;--service-cluster-ip-range=10.10.10.0/24&quot;</span></span><br></pre></td></tr></table></figure>

<p>创建systemd服务文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /lib/systemd/system/kube-apiserver.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-apiserver</span><br><span class="line"><span class="comment">#ExecStart=/opt/kubernetes/bin/kube-apiserver $&#123;KUBE_APISERVER_OPTS&#125;</span></span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-apiserver \</span><br><span class="line"><span class="variable">$&#123;KUBE_LOGTOSTDERR&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_LOG_LEVEL&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_ETCD_SERVERS&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_API_ADDRESS&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_API_PORT&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_ADVERTISE_ADDR&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_ALLOW_PRIV&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_SERVICE_ADDRESSES&#125;</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>启动服务，并设置开机启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kube-apiserver</span></span><br><span class="line"><span class="comment"># systemctl restart kube-apiserver</span></span><br></pre></td></tr></table></figure>

<p>注意：apiserver默认支持etcd3，如果是etcd2，需启动时指定版本选项–storage-backend=etcd2</p>
<h3 id="3-3-2-scheduler"><a href="#3-3-2-scheduler" class="headerlink" title="3.3.2 scheduler"></a>3.3.2 scheduler</h3><p>创建配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /opt/kubernetes/cfg/kube-scheduler</span></span><br><span class="line">KUBE_LOGTOSTDERR=<span class="string">&quot;--logtostderr=true&quot;</span></span><br><span class="line">KUBE_LOG_LEVEL=<span class="string">&quot;--v=4&quot;</span></span><br><span class="line">KUBE_MASTER=<span class="string">&quot;--master=192.168.0.211:8080&quot;</span></span><br><span class="line">KUBE_LEADER_ELECT=<span class="string">&quot;--leader-elect&quot;</span></span><br></pre></td></tr></table></figure>

<p>创建systemd服务文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /lib/systemd/system/kube-scheduler.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-scheduler</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-scheduler \</span><br><span class="line"><span class="variable">$&#123;KUBE_LOGTOSTDERR&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_LOG_LEVEL&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_MASTER&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_LEADER_ELECT&#125;</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>启动服务，并设置开机启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kube-scheduler</span></span><br><span class="line"><span class="comment"># systemctl restart kube-scheduler</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-3-controller-manager"><a href="#3-3-3-controller-manager" class="headerlink" title="3.3.3 controller-manager"></a>3.3.3 controller-manager</h3><p>创建配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /opt/kubernetes/cfg/kube-controller-manager</span></span><br><span class="line">KUBE_LOGTOSTDERR=<span class="string">&quot;--logtostderr=true&quot;</span></span><br><span class="line">KUBE_LOG_LEVEL=<span class="string">&quot;--v=4&quot;</span></span><br><span class="line">KUBE_MASTER=<span class="string">&quot;--master=192.168.0.211:8080&quot;</span></span><br></pre></td></tr></table></figure>

<p>创建systemd服务文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /lib/systemd/system/kube-controller-manager.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-controller-manager</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-controller-manager \</span><br><span class="line"><span class="variable">$&#123;KUBE_LOGTOSTDERR&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_LOG_LEVEL&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_MASTER&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_LEADER_ELECT&#125;</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>启动服务，并设置开机启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kube-controller-manager</span></span><br><span class="line"><span class="comment"># systemctl restart kube-controller-manager</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-4-小结"><a href="#3-3-4-小结" class="headerlink" title="3.3.4 小结"></a>3.3.4 小结</h3><p>Master节点组件就全部启动了，需要注意的是服务启动顺序有依赖，先启动etcd，再启动apiserver，其他组件无顺序要求。</p>
<p>查看Master节点组件进程状态：</p>
<p><a target="_blank" rel="noopener" href="https://s4.51cto.com//oss/201711/20/0fd14ce58c9dfe66a4802e64e02aff8b.png"><img src="/../images/Kubernetes(K8S)%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86Docker%E5%AE%B9%E5%99%A8%EF%BC%88%E9%83%A8%E7%BD%B2%E7%AF%87%EF%BC%89/0fd14ce58c9dfe66a4802e64e02aff8b.png" alt="Kubernetes(K8S)集群管理Docker容器（部署篇）_k8s_05"></a></p>
<p>说明组件都在运行。</p>
<p>如果启动失败，请查看启动日志，例如：</p>
<p>#journalctl -u kube-apiserver</p>
<h2 id="3-4-运行Node节点组件"><a href="#3-4-运行Node节点组件" class="headerlink" title="3.4  运行Node节点组件"></a>3.4  运行Node节点组件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">k8s-node01<span class="comment"># tar zxvf kubernetes-node-linux-amd64.tar.gz</span></span><br><span class="line">k8s-node01<span class="comment"># mkdir -p /opt/kubernetes/&#123;bin,cfg&#125;</span></span><br><span class="line">k8s-node01<span class="comment"># mv kubernetes/node/bin/&#123;kubelet,kube-proxy&#125; /opt/kubernetes/bin/</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-1-kubelet"><a href="#3-4-1-kubelet" class="headerlink" title="3.4.1 kubelet"></a>3.4.1 kubelet</h3><p>创建kubeconfig配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /opt/kubernetes/cfg/kubelet.kubeconfig</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Config</span><br><span class="line">clusters:</span><br><span class="line">  - cluster:</span><br><span class="line">      server: http://192.168.0.211:8080</span><br><span class="line">    name: <span class="built_in">local</span></span><br><span class="line">contexts:</span><br><span class="line">  - context:</span><br><span class="line">      cluster: <span class="built_in">local</span></span><br><span class="line">    name: <span class="built_in">local</span></span><br><span class="line">current-context: <span class="built_in">local</span></span><br></pre></td></tr></table></figure>

<p>kubeconfig文件用于kubelet连接master apiserver。</p>
<p>创建配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /opt/kubernetes/cfg/kubelet            </span></span><br><span class="line"><span class="comment"># 启用日志标准错误</span></span><br><span class="line">KUBE_LOGTOSTDERR=<span class="string">&quot;--logtostderr=true&quot;</span></span><br><span class="line"><span class="comment"># 日志级别</span></span><br><span class="line">KUBE_LOG_LEVEL=<span class="string">&quot;--v=4&quot;</span></span><br><span class="line"><span class="comment"># Kubelet服务IP地址</span></span><br><span class="line">NODE_ADDRESS=<span class="string">&quot;--address=192.168.0.212&quot;</span></span><br><span class="line"><span class="comment"># Kubelet服务端口</span></span><br><span class="line">NODE_PORT=<span class="string">&quot;--port=10250&quot;</span></span><br><span class="line"><span class="comment"># 自定义节点名称</span></span><br><span class="line">NODE_HOSTNAME=<span class="string">&quot;--hostname-override=192.168.0.212&quot;</span></span><br><span class="line"><span class="comment"># kubeconfig路径，指定连接API服务器</span></span><br><span class="line">KUBELET_KUBECONFIG=<span class="string">&quot;--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig&quot;</span></span><br><span class="line"><span class="comment"># 允许容器请求特权模式，默认false</span></span><br><span class="line">KUBE_ALLOW_PRIV=<span class="string">&quot;--allow-privileged=false&quot;</span></span><br><span class="line"><span class="comment"># DNS信息</span></span><br><span class="line">KUBELET_DNS_IP=<span class="string">&quot;--cluster-dns=10.10.10.2&quot;</span></span><br><span class="line">KUBELET_DNS_DOMAIN=<span class="string">&quot;--cluster-domain=cluster.local&quot;</span></span><br><span class="line"><span class="comment"># 禁用使用Swap</span></span><br><span class="line">KUBELET_SWAP=<span class="string">&quot;--fail-swap-on=false&quot;</span></span><br></pre></td></tr></table></figure>

<p>创建systemd服务文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /lib/systemd/system/kubelet.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kubelet</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kubelet \</span><br><span class="line"><span class="variable">$&#123;KUBE_LOGTOSTDERR&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_LOG_LEVEL&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;NODE_ADDRESS&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;NODE_PORT&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;NODE_HOSTNAME&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBELET_KUBECONFIG&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_ALLOW_PRIV&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBELET_DNS_IP&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBELET_DNS_DOMAIN&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBELET_SWAP&#125;</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>启动服务，并设置开机启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kubelet</span></span><br><span class="line"><span class="comment"># systemctl restart kubelet</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-2-proxy"><a href="#3-4-2-proxy" class="headerlink" title="3.4.2 proxy"></a>3.4.2 proxy</h3><p>创建配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /opt/kubernetes/cfg/kube-proxy            </span></span><br><span class="line"><span class="comment"># 启用日志标准错误</span></span><br><span class="line">KUBE_LOGTOSTDERR=<span class="string">&quot;--logtostderr=true&quot;</span></span><br><span class="line"><span class="comment"># 日志级别</span></span><br><span class="line">KUBE_LOG_LEVEL=<span class="string">&quot;--v=4&quot;</span></span><br><span class="line"><span class="comment"># 自定义节点名称</span></span><br><span class="line">NODE_HOSTNAME=<span class="string">&quot;--hostname-override=192.168.0.212&quot;</span></span><br><span class="line"><span class="comment"># API服务地址</span></span><br><span class="line">KUBE_MASTER=<span class="string">&quot;--master=http://192.168.0.211:8080&quot;</span></span><br></pre></td></tr></table></figure>

<p>创建systemd服务文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /lib/systemd/system/kube-proxy.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-proxy</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-proxy \</span><br><span class="line"><span class="variable">$&#123;KUBE_LOGTOSTDERR&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_LOG_LEVEL&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;NODE_HOSTNAME&#125;</span> \</span><br><span class="line"><span class="variable">$&#123;KUBE_MASTER&#125;</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>启动服务，并设置开机启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kube-proxy</span></span><br><span class="line"><span class="comment"># systemctl restart kube-proxy</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-3-小结"><a href="#3-4-3-小结" class="headerlink" title="3.4.3 小结"></a>3.4.3 小结</h3><p>其他节点加入集群与node01方式相同，但需修改kubelet的–address和–hostname-override选项为本机IP。</p>
<p>查看Node节点组件进程状态：</p>
<p><a target="_blank" rel="noopener" href="https://s4.51cto.com//oss/201711/20/02979dd7adf52d863fbaaf356a421cdf.png"><img src="/../images/Kubernetes(K8S)%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86Docker%E5%AE%B9%E5%99%A8%EF%BC%88%E9%83%A8%E7%BD%B2%E7%AF%87%EF%BC%89/02979dd7adf52d863fbaaf356a421cdf.png" alt="Kubernetes(K8S)集群管理Docker容器（部署篇）_k8s_06"></a></p>
<p>说明组件都在运行。</p>
<p>如果启动失败，请查看启动日志，例如：</p>
<p>#journalctl -u kubelet</p>
<h2 id="3-5-验证集群是否部署成功"><a href="#3-5-验证集群是否部署成功" class="headerlink" title="3.5 验证集群是否部署成功"></a>3.5 验证集群是否部署成功</h2><p>设置可执行文件到系统变量，方便使用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># echo &quot;export PATH=$PATH:/opt/kubernetes/bin&quot; &gt;&gt; /etc/profile</span></span><br><span class="line"><span class="comment"># source /etc/profile</span></span><br></pre></td></tr></table></figure>

<p>查看集群节点状态：</p>
<p><img src="/../images/Kubernetes(K8S)%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86Docker%E5%AE%B9%E5%99%A8%EF%BC%88%E9%83%A8%E7%BD%B2%E7%AF%87%EF%BC%89/a0ff4d58486157275e9adf01a26d5f72.png" alt="Kubernetes(K8S)集群管理Docker容器（部署篇）_kubernetes_07"></p>
<p>两个节点都加入到了kubernetes集群，就此部署完成。</p>
<p>本章对应视频：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1L-FjASEK849y03cfOTlU_Q"> https://pan.baidu.com/s/1L-FjASEK849y03cfOTlU_Q</a></p>
<p>QQ技术群，有需要的朋友可以加下：</p>
<p>Docker技术交流群（<a target="_blank" rel="noopener" href="http://shang.qq.com/wpa/qunwpa?idkey=d1e58c192afbba1e295f4252b13ab2bf115f6d23536c0b56bf6944378bc608e7"> 719105297</a>）</p>
<p>Kubernetes技术交流群（<a target="_blank" rel="noopener" href="https://jq.qq.com/?_wv=1027&k=5KvVgL4"> 602965977</a>）</p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
		data-enable='false'
        data-ae='false'
        data-ci=''
        data-cs=''
        data-r=''
        data-o=''
        data-a=''
        data-d='false'
    >查看评论</div>


    </div>
    
        <div class='side'>
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E4%B8%8B%E8%BD%BD%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8C%85"><span class="toc-number">1.</span> <span class="toc-text">3.1 下载二进制包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E5%AE%89%E8%A3%85etcd3"><span class="toc-number">2.</span> <span class="toc-text">3.2  安装etcd3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E8%BF%90%E8%A1%8CMaster%E8%8A%82%E7%82%B9%E7%BB%84%E4%BB%B6"><span class="toc-number">3.</span> <span class="toc-text">3.3 运行Master节点组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-apiserver"><span class="toc-number">3.1.</span> <span class="toc-text">3.3.1 apiserver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-scheduler"><span class="toc-number">3.2.</span> <span class="toc-text">3.3.2 scheduler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-controller-manager"><span class="toc-number">3.3.</span> <span class="toc-text">3.3.3 controller-manager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-4-%E5%B0%8F%E7%BB%93"><span class="toc-number">3.4.</span> <span class="toc-text">3.3.4 小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E8%BF%90%E8%A1%8CNode%E8%8A%82%E7%82%B9%E7%BB%84%E4%BB%B6"><span class="toc-number">4.</span> <span class="toc-text">3.4  运行Node节点组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-kubelet"><span class="toc-number">4.1.</span> <span class="toc-text">3.4.1 kubelet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-proxy"><span class="toc-number">4.2.</span> <span class="toc-text">3.4.2 proxy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-%E5%B0%8F%E7%BB%93"><span class="toc-number">4.3.</span> <span class="toc-text">3.4.3 小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4%E6%98%AF%E5%90%A6%E9%83%A8%E7%BD%B2%E6%88%90%E5%8A%9F"><span class="toc-number">5.</span> <span class="toc-text">3.5 验证集群是否部署成功</span></a></li></ol>	
        </div>
    
</div>


    </div>
</div>
</body>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>




</html>
