
<!DOCTYPE html>
<html lang="zh-Hans" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spring-Cloud-Gateway 从升级到放弃 - 肖日宁的小站</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="keywords" content="肖日宁,"> 
    <meta name="description" content="肖日宁,xiaorining,1 为什么要升级为spring-cloud-gateway？Spring Cloud Gateway features:

Built on Spring Framework 5, Project ,"> 
    <meta name="author" content="肖日宁"> 
    <link rel="alternative" href="atom.xml" title="肖日宁的小站" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
    
<link rel="stylesheet" href="/css/diaspora.css">
<link rel="stylesheet" href="/css/APlayer.min.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body class="loading">
    <span id="config-title" style="display:none">肖日宁的小站</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="https://kingslanding.cn"></a>
        <!-- page音乐插件 -->
        
    <h3 class="subtitle">Spring-Cloud-Gateway 从升级到放弃</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">Spring-Cloud-Gateway 从升级到放弃</h1>
        <div class="stuff">
            <span>九月 28, 2019</span>
            
  <ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1-Spring-Cloud-gateway/" rel="tag">微服务,Spring Cloud,gateway</a></li></ul>


        </div>
        <div class="content markdown">
            <h1 id="1-为什么要升级为spring-cloud-gateway？"><a href="#1-为什么要升级为spring-cloud-gateway？" class="headerlink" title="1 为什么要升级为spring-cloud-gateway？"></a>1 为什么要升级为spring-cloud-gateway？</h1><p>Spring Cloud Gateway features:</p>
<ul>
<li>Built on Spring Framework 5, Project Reactor and Spring Boot 2.0</li>
<li>Able to match routes on any request attribute.</li>
<li>Predicates and filters are specific to routes.</li>
<li>Hystrix Circuit Breaker integration.</li>
<li>Spring Cloud DiscoveryClient integration</li>
<li>Easy to write Predicates and Filters</li>
<li>Request Rate Limiting</li>
<li>Path Rewriting</li>
</ul>
<p>这是官方说的，spring gateway相对spring zuul要新很多，应用也更加自由，开发体验更好。但是我在测试中发现，spring-cloud-gateway相对于zuul来说，更加出众的还是其性能，当然最后让我放弃的也是因为这一点。</p>
<p>网上的朋友也有做一些gateway和zuul的性能比较，大多的结论也是gateway要优于zuul，同时也更加稳定。</p>
<p>但是我们不能轻信，所以我也做了测试,这部分测试内容若不感兴趣可以跳过，zuul就不测试了。</p>
<h1 id="2-spring-cloud-gateway的初步测试"><a href="#2-spring-cloud-gateway的初步测试" class="headerlink" title="2.spring-cloud-gateway的初步测试"></a>2.spring-cloud-gateway的初步测试</h1><p>　　step.1：测试准备：</p>
<p>　　　　1.gateway版本：2.0.1</p>
<p>　　　　2.服务主机：10.1.4.32，16G内存，4核虚拟机</p>
<p>　　　　3.测试客户端：10.1.4.34，16G内存，4核虚拟机</p>
<p>　　　　4.测试工具wrk</p>
<p>　　step.2：建立gateway工程并写两个测试http接口，</p>
<p>　　　　1.<a target="_blank" rel="noopener" href="http://10.1.4.32:14077/hello">http://10.1.4.32:14077/hello</a> [POST]</p>
<p>　　　　2.<a target="_blank" rel="noopener" href="http://10.1.4.32:14077/test">http://10.1.4.32:14077/test</a> [GET]</p>
<p>　　step.3：开始测试</p>
<p>　　step.4：测试结果　　　</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[wrk@localhost wrk]$ .&#x2F;wrk  -t 15 -c500 -d 10 --latency  http:&#x2F;&#x2F;10.1.4.32:14077&#x2F;test</span><br><span class="line">Running 10s test @ http:&#x2F;&#x2F;10.1.4.32:14077&#x2F;test</span><br><span class="line">  15 threads and 500 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +&#x2F;- Stdev</span><br><span class="line">    Latency     3.38ms    3.26ms 113.45ms   95.76%</span><br><span class="line">    Req&#x2F;Sec    10.84k     1.44k   26.48k    89.50%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    2.79ms</span><br><span class="line">     75%    3.51ms</span><br><span class="line">     90%    4.21ms</span><br><span class="line">     99%   17.23ms</span><br><span class="line">  1625714 requests in 10.10s, 131.79MB read</span><br><span class="line">Requests&#x2F;sec: 160961.07</span><br><span class="line">Transfer&#x2F;sec:     13.05MB</span><br></pre></td></tr></table></figure>

<p>以及：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[wrk@localhost wrk]$ .&#x2F;wrk  -t 15 -c500 -d 10 --latency -s scripts&#x2F;gateway.lua  http:&#x2F;&#x2F;10.1.4.32:14077&#x2F;hello</span><br><span class="line">Running 10s test @ http:&#x2F;&#x2F;10.1.4.32:14077&#x2F;hello</span><br><span class="line">  15 threads and 500 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +&#x2F;- Stdev</span><br><span class="line">    Latency     5.21ms    3.96ms 255.59ms   96.75%</span><br><span class="line">    Req&#x2F;Sec     6.62k   604.79    13.72k    88.48%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    4.78ms</span><br><span class="line">     75%    5.55ms</span><br><span class="line">     90%    6.32ms</span><br><span class="line">     99%   14.87ms</span><br><span class="line">  994374 requests in 10.10s, 539.59MB read</span><br><span class="line">Requests&#x2F;sec:  98471.14</span><br><span class="line">Transfer&#x2F;sec:     53.43MB</span><br></pre></td></tr></table></figure>

<p>说明，如果测试结果差别较大可能是因为测试工具的问题。</p>
<p>结果显示，POST方法的性能TPS达到了10W/s,而GET方法的性能TPS达到了16W/s。</p>
<p>这看起来很不可思议，因为正常的微服务，能达到2W/s的性能已经是良好，达到10W实在是不可思议。但是前面说了spring-cloud-gateway引入了Spring Reactor反应式编程，应对的便是这种高并发需求。</p>
<p>当然，即便spring-cloud-gateway给了我们很大惊喜，但是如果因此就引入了spring-cloud-gateway，那还是会有些草率，毕竟gateway是用来干什么的？是路由和过滤。继续测试。</p>
<p>　　step.5：加上路由和过滤器,在配置文件中加入下面内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: test</span><br><span class="line">        uri: http:&#x2F;&#x2F;10.1.4.32:14077&#x2F;test</span><br><span class="line">        predicates:</span><br><span class="line">        - Path&#x3D;&#x2F;tt</span><br><span class="line">        filters:</span><br><span class="line">        - AddRequestParameter&#x3D;foo, bar</span><br></pre></td></tr></table></figure>

<p>表示，给test方法加入了路由，并且加入了官方提供的过滤器：AddRequestParameter=foo, bar</p>
<p>　　step.6：测试，并附测试结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[wrk@localhost wrk]$ .&#x2F;wrk  -t 15 -c500 -d 10 --latency  http:&#x2F;&#x2F;10.1.4.32:14077&#x2F;tt</span><br><span class="line">Running 10s test @ http:&#x2F;&#x2F;10.1.4.32:14077&#x2F;tt</span><br><span class="line">  15 threads and 500 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +&#x2F;- Stdev</span><br><span class="line">    Latency    18.99ms   12.15ms 122.69ms   70.84%</span><br><span class="line">    Req&#x2F;Sec     1.82k   155.77     2.36k    73.94%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%   17.03ms</span><br><span class="line">     75%   25.49ms</span><br><span class="line">     90%   35.02ms</span><br><span class="line">     99%   57.13ms</span><br><span class="line">  274529 requests in 10.10s, 22.25MB read</span><br><span class="line">Requests&#x2F;sec:  27182.88</span><br><span class="line">Transfer&#x2F;sec:      2.20MB</span><br></pre></td></tr></table></figure>

<p>性能只剩27000/s，貌似降低了很多，但是比起zuul仍然快了不少。因为在这台机器上，测试zuul或许都不能到达2W。</p>
<p>那么，是不是就应该使用spring-cloud-gateway了？</p>
<h1 id="3-开始使用spring-cloud-gateway"><a href="#3-开始使用spring-cloud-gateway" class="headerlink" title="3.开始使用spring-cloud-gateway"></a>3.开始使用spring-cloud-gateway</h1><p>在使用上spring-cluod-gateway之后，我开始编辑自己的过滤器，需求要求写两个过滤器，修改请求体和响应体。</p>
<p>因为需要对特定的请求使用过滤器，所以这里使用gateway-filter，有些代码官方有，有些网友提供，两个过滤器代码大致如下：</p>
<p>解密过滤器，pre：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">package com.newland.dc.ctid.fileter;</span><br><span class="line"></span><br><span class="line">import com.google.gson.Gson;</span><br><span class="line">import com.google.gson.GsonBuilder;</span><br><span class="line">import com.newland.dc.common.vo.RequestHeaderVo;</span><br><span class="line">import com.newland.dc.ctid.entity.dto.RequestDto;</span><br><span class="line">import io.netty.buffer.ByteBufAllocator;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import org.springframework.cloud.gateway.filter.GatewayFilter;</span><br><span class="line">import org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line">import org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;</span><br><span class="line">import org.springframework.core.Ordered;</span><br><span class="line">import org.springframework.core.io.buffer.DataBuffer;</span><br><span class="line">import org.springframework.core.io.buffer.DataBufferUtils;</span><br><span class="line">import org.springframework.core.io.buffer.NettyDataBufferFactory;</span><br><span class="line">import org.springframework.core.style.ToStringCreator;</span><br><span class="line">import org.springframework.http.MediaType;</span><br><span class="line">import org.springframework.http.server.reactive.ServerHttpRequest;</span><br><span class="line">import org.springframework.http.server.reactive.ServerHttpRequestDecorator;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.web.server.ServerWebExchange;</span><br><span class="line">import reactor.core.publisher.Flux;</span><br><span class="line">import reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">import java.nio.CharBuffer;</span><br><span class="line">import java.nio.charset.StandardCharsets;</span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * Created by garfield on 2019&#x2F;2&#x2F;26.</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Component</span><br><span class="line">public class DecryptGatewayFilterFactory extends AbstractGatewayFilterFactory&lt;DecryptGatewayFilterFactory.Config&gt;&#123;</span><br><span class="line"></span><br><span class="line">    private static Logger log &#x3D; LoggerFactory.getLogger(DecryptGatewayFilterFactory.class);</span><br><span class="line"></span><br><span class="line">    public static final String DECRYPT_HEADER &#x3D; &quot;decrypt_header&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public DecryptGatewayFilterFactory() &#123;</span><br><span class="line">        super(Config.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private Gson gson &#x3D; new GsonBuilder().serializeNulls().create();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public GatewayFilter apply(Config config) &#123;</span><br><span class="line">        return new DecryptGatewayFilter(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class DecryptGatewayFilter implements GatewayFilter, Ordered &#123;</span><br><span class="line">        Config config;</span><br><span class="line"></span><br><span class="line">        DecryptGatewayFilter(Config config) &#123;</span><br><span class="line">            this.config &#x3D; config;</span><br><span class="line">        &#125;</span><br><span class="line">        @Override</span><br><span class="line">        public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">                log.debug(config.toString());</span><br><span class="line">                ServerHttpRequest request &#x3D; exchange.getRequest();</span><br><span class="line">                MediaType contentType &#x3D; request.getHeaders().getContentType();</span><br><span class="line"></span><br><span class="line">                boolean postRequest &#x3D; &quot;POST&quot;.equalsIgnoreCase(request.getMethodValue()) &amp;&amp; !contentType.toString().contains(&quot;multipart&#x2F;form-data&quot;);</span><br><span class="line">                &#x2F;&#x2F;判断是否为POST请求</span><br><span class="line">                if (postRequest) &#123;</span><br><span class="line"></span><br><span class="line">                    Flux&lt;DataBuffer&gt; body &#x3D; request.getBody();</span><br><span class="line">                    AtomicReference&lt;String&gt; bodyRef &#x3D; new AtomicReference&lt;&gt;();&#x2F;&#x2F;缓存读取的request body信息</span><br><span class="line">                    body.subscribe(dataBuffer -&gt; &#123;</span><br><span class="line">                        CharBuffer charBuffer &#x3D; StandardCharsets.UTF_8.decode(dataBuffer.asByteBuffer());</span><br><span class="line">                        DataBufferUtils.release(dataBuffer);</span><br><span class="line">                        bodyRef.set(charBuffer.toString());</span><br><span class="line">                    &#125;);&#x2F;&#x2F;读取request body到缓存</span><br><span class="line">                    String bodyStr &#x3D; bodyRef.get();&#x2F;&#x2F;获取request body</span><br><span class="line">                    log.debug(bodyStr);&#x2F;&#x2F;这里是我们需要做的操作</span><br><span class="line">                    RequestDto requestDto &#x3D; gson.fromJson(bodyStr, RequestDto.class);</span><br><span class="line">                    log.debug(&quot;decrypt filter&quot;);</span><br><span class="line">                    &#x2F;&#x2F;save header to response header</span><br><span class="line">                    RequestHeaderVo headerVo &#x3D; requestDto.getHeader();</span><br><span class="line">                    headerVo.setAppVersion(&quot;1000&quot;);</span><br><span class="line">                    &#x2F;&#x2F;此处可以传递一些变量</span><br><span class="line">                    exchange.getResponse().getHeaders().add(DECRYPT_HEADER, gson.toJson(headerVo));</span><br><span class="line"></span><br><span class="line">                    DataBuffer bodyDataBuffer &#x3D; stringBuffer(bodyStr);</span><br><span class="line">                    Flux&lt;DataBuffer&gt; bodyFlux &#x3D; Flux.just(bodyDataBuffer);</span><br><span class="line"></span><br><span class="line">                    request &#x3D; new ServerHttpRequestDecorator(request)&#123;</span><br><span class="line">                        @Override</span><br><span class="line">                        public Flux&lt;DataBuffer&gt; getBody() &#123;</span><br><span class="line">                            return bodyFlux;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;&#x2F;&#x2F;封装我们的request</span><br><span class="line">                &#125;</span><br><span class="line">                return chain.filter(exchange.mutate().request(request.mutate().header(&quot;a&quot;,&quot;200&quot;).build()).build());</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public int getOrder() &#123;</span><br><span class="line">            return -10;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static DataBuffer stringBuffer(String value) &#123;</span><br><span class="line">        byte[] bytes &#x3D; value.getBytes(StandardCharsets.UTF_8);</span><br><span class="line"></span><br><span class="line">        NettyDataBufferFactory nettyDataBufferFactory &#x3D; new NettyDataBufferFactory(ByteBufAllocator.DEFAULT);</span><br><span class="line">        DataBuffer buffer &#x3D; nettyDataBufferFactory.allocateBuffer(bytes.length);</span><br><span class="line">        buffer.write(bytes);</span><br><span class="line">        return buffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ServerHttpRequest.Builder mutate(ServerHttpRequest request) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static class Config &#123;</span><br><span class="line">        private boolean decrypt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        public boolean isDecrypt() &#123;</span><br><span class="line">            return decrypt;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void setDecrypt(boolean decrypt) &#123;</span><br><span class="line">            this.decrypt &#x3D; decrypt;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public String toString() &#123;</span><br><span class="line">            return new ToStringCreator(this)</span><br><span class="line">                    .append(&quot;decrypt&quot;, decrypt)</span><br><span class="line">                    .toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;String&gt; shortcutFieldOrder() &#123;</span><br><span class="line">        return Arrays.asList(&quot;decrypt&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加密过滤器，使用源码的提供的修改方法，post：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">package com.newland.dc.ctid.fileter;</span><br><span class="line"></span><br><span class="line">import com.google.gson.Gson;</span><br><span class="line">import com.newland.dc.common.vo.RequestHeaderVo;</span><br><span class="line">import com.newland.dc.ctid.entity.dto.RequestDto;</span><br><span class="line">import org.springframework.cloud.gateway.filter.GatewayFilter;</span><br><span class="line">import org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;</span><br><span class="line">import org.springframework.cloud.gateway.filter.factory.rewrite.ModifyResponseBodyGatewayFilterFactory;</span><br><span class="line">import org.springframework.core.style.ToStringCreator;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.web.server.ServerWebExchange;</span><br><span class="line">import reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: garfield</span><br><span class="line"> * @Date: 2019&#x2F;3&#x2F;5 15:33</span><br><span class="line"> * @Description:</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Component</span><br><span class="line">public class AnGatewayFilterFactory extends AbstractGatewayFilterFactory&lt;AnGatewayFilterFactory.Config&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private Gson gson &#x3D; new Gson();</span><br><span class="line"></span><br><span class="line">    public AnGatewayFilterFactory() &#123;</span><br><span class="line">        super(Config.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public GatewayFilter apply(Config config) &#123;</span><br><span class="line"></span><br><span class="line">        ModifyResponseBodyGatewayFilterFactory m1 &#x3D; new ModifyResponseBodyGatewayFilterFactory(null);</span><br><span class="line">        ModifyResponseBodyGatewayFilterFactory.Config c1 &#x3D; new ModifyResponseBodyGatewayFilterFactory.Config();</span><br><span class="line">        c1.setInClass(String.class);</span><br><span class="line">        c1.setOutClass(String.class);</span><br><span class="line">        c1.setNewContentType(&quot;application&#x2F;json&quot;);</span><br><span class="line"></span><br><span class="line">        c1.setRewriteFunction((exchange, body) -&gt; &#123;</span><br><span class="line">            ServerWebExchange ex &#x3D; (ServerWebExchange) exchange;</span><br><span class="line">            &#x2F;&#x2F;此处更改响应体</span><br><span class="line">            RequestHeaderVo requestHeaderVo &#x3D; new RequestHeaderVo();</span><br><span class="line">            RequestDto requestDto &#x3D; gson.fromJson(body.toString(), RequestDto.class);</span><br><span class="line">            requestDto.setHeader(requestHeaderVo);</span><br><span class="line">            body &#x3D; gson.toJson(requestDto);</span><br><span class="line">            return Mono.just(body);</span><br><span class="line">        &#125;);</span><br><span class="line">        return m1.apply(c1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static class Config &#123;</span><br><span class="line">        private boolean decrypt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        public boolean isDecrypt() &#123;</span><br><span class="line">            return decrypt;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void setDecrypt(boolean decrypt) &#123;</span><br><span class="line">            this.decrypt &#x3D; decrypt;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public String toString() &#123;</span><br><span class="line">            return new ToStringCreator(this)</span><br><span class="line">                    .append(&quot;encrypt&quot;, decrypt)</span><br><span class="line">                    .toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;String&gt; shortcutFieldOrder() &#123;</span><br><span class="line">        return Arrays.asList(&quot;encrypt&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要转移一下话题，这个过滤器修改其实有几种方法，可以自己写，也可以应用源码提供的例子。上面的两种写法已经测试都能使用，其实我还有两种方式，大同小异就是了，但也准备贴出来，也记录一下问题：</p>
<p>下面这个其实就是源码中的例子，只不过不引用，自己写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line"></span><br><span class="line">            ServerHttpResponseDecorator responseDecorator &#x3D; new ServerHttpResponseDecorator(exchange.getResponse()) &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public Mono&lt;Void&gt; writeWith(Publisher&lt;? extends DataBuffer&gt; body) &#123;</span><br><span class="line">                    ServerHttpRequest request &#x3D; exchange.getRequest();</span><br><span class="line"></span><br><span class="line">                    MediaType originalResponseContentType &#x3D; exchange.getAttribute(ORIGINAL_RESPONSE_CONTENT_TYPE_ATTR);</span><br><span class="line">                    HttpHeaders httpHeaders &#x3D; new HttpHeaders();</span><br><span class="line">                    httpHeaders.setContentType(originalResponseContentType);</span><br><span class="line">                    ResponseAdapter responseAdapter &#x3D; new ResponseAdapter(body, httpHeaders);</span><br><span class="line">                    DefaultClientResponse clientResponse &#x3D; new DefaultClientResponse(responseAdapter, ExchangeStrategies.withDefaults());</span><br><span class="line"></span><br><span class="line">                    Mono&lt;DataBuffer&gt; modifiedBody &#x3D; clientResponse.bodyToMono(DataBuffer.class).map(encrypt(config, new RequestHeaderVo()));</span><br><span class="line"></span><br><span class="line">                    BodyInserter bodyInserter &#x3D; BodyInserters.fromPublisher(modifiedBody, DataBuffer.class);</span><br><span class="line">                    CachedBodyOutputMessage outputMessage &#x3D; new CachedBodyOutputMessage(exchange, exchange.getResponse().getHeaders());</span><br><span class="line">                    return bodyInserter.insert(outputMessage, new BodyInserterContext())</span><br><span class="line">                            .then(Mono.defer(() -&gt; &#123;</span><br><span class="line">                                Flux&lt;DataBuffer&gt; messageBody &#x3D; outputMessage.getBody();</span><br><span class="line">                                HttpHeaders headers &#x3D; getDelegate().getHeaders();</span><br><span class="line">                                if (headers.getContentLength() &lt; 0 &amp;&amp; !headers.containsKey(HttpHeaders.TRANSFER_ENCODING)) &#123;</span><br><span class="line">                                    messageBody &#x3D; messageBody.doOnNext(data -&gt; headers.setContentLength(data.readableByteCount()));</span><br><span class="line">                                &#125;</span><br><span class="line">                                return this.getDelegate().writeWith(messageBody);</span><br><span class="line">                            &#125;));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                public Mono&lt;Void&gt; writeAndFlushWith(Publisher&lt;? extends Publisher&lt;? extends DataBuffer&gt;&gt; body) &#123;</span><br><span class="line">                    return writeWith(Flux.from(body)</span><br><span class="line">                            .flatMapSequential(p -&gt; p));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            return chain.filter(exchange.mutate().response(responseDecorator).build());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public int getOrder() &#123;</span><br><span class="line">            return NettyWriteResponseFilter.WRITE_RESPONSE_FILTER_ORDER - 1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private Function&lt;DataBuffer, DataBuffer&gt; encrypt(Config config, RequestHeaderVo headerVo) &#123;</span><br><span class="line">        if (config.encrypt) &#123;</span><br><span class="line">            return (i) -&gt; &#123;</span><br><span class="line">                InputStream inputStream &#x3D; i.asInputStream();</span><br><span class="line"></span><br><span class="line">                byte[] bytes &#x3D; new byte[0];</span><br><span class="line">                try &#123;</span><br><span class="line">                    bytes &#x3D; new byte[inputStream.available()];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    inputStream.read(bytes);</span><br><span class="line">                &#125; catch (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                &#x2F;&#x2F;进行我们的操作</span><br><span class="line">                String body &#x3D; new String(bytes);</span><br><span class="line">                log.debug(&quot;this is response encrypt&quot;);</span><br><span class="line">                log.debug(body);</span><br><span class="line">                log.debug(headerVo.toString());</span><br><span class="line">&#x2F;&#x2F;                body &#x3D; encryptService.responseEncrypt(body, headerVo);</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F;进行我们的操作</span><br><span class="line">                return i.write(TokenGatewayFilterFactory.stringBuffer(body));</span><br><span class="line">&#x2F;&#x2F;                return i.write(new String(body).getBytes());</span><br><span class="line"></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return i -&gt; i;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这种例子中，发现修改response body的时候，会引起代码进入NioEventLoop类中的run方法，死循环无法退出，我也不清楚为什么，修改需谨慎。</p>
<p>另一种，跟这位网友写得差不多，只不过我没测试就是了：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9f00e0e1681c">https://www.jianshu.com/p/9f00e0e1681c</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">            return chain.filter(exchange.mutate().response(new ServerHttpResponseDecorator(exchange.getResponse()) &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public Mono&lt;Void&gt; writeWith(Publisher&lt;? extends DataBuffer&gt; body) &#123;</span><br><span class="line">                    DataBufferFactory bufferFactory &#x3D; exchange.getResponse().bufferFactory();</span><br><span class="line">                    if (getStatusCode().equals(HttpStatus.OK) &amp;&amp; body instanceof Flux) &#123;</span><br><span class="line">                        Flux&lt;? extends DataBuffer&gt; fluxBody &#x3D; Flux.first(body);</span><br><span class="line">                        return super.writeWith(fluxBody.map(dataBuffer -&gt; &#123;</span><br><span class="line">                            System.out.println(dataBuffer.readableByteCount());</span><br><span class="line"></span><br><span class="line">                            byte[] content &#x3D; new byte[dataBuffer.readableByteCount()];</span><br><span class="line">                            dataBuffer.read(content);</span><br><span class="line">                            &#x2F;&#x2F;释放掉内存</span><br><span class="line">                            DataBufferUtils.release(dataBuffer);</span><br><span class="line">                            &#x2F;&#x2F;responseData就是下游系统返回的内容,可以查看修改</span><br><span class="line">                            String responseData &#x3D; new String(content, Charset.forName(&quot;UTF-8&quot;));</span><br><span class="line"></span><br><span class="line">                            log.debug(&quot;响应内容:&#123;&#125;&quot;, responseData);</span><br><span class="line">                            log.debug(&quot;this is response encrypt&quot;);</span><br><span class="line">                            System.out.println(responseData);</span><br><span class="line"></span><br><span class="line">                            byte[] newContent &#x3D; responseData.getBytes();</span><br><span class="line">&#x2F;&#x2F;                body &#x3D; encryptService.responseEncrypt(body, headerVo);</span><br><span class="line">                            byte[] uppedContent &#x3D; new String(newContent, Charset.forName(&quot;UTF-8&quot;)).getBytes();</span><br><span class="line">                            return bufferFactory.wrap(uppedContent);</span><br><span class="line">                        &#125;));</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        log.error(&quot;响应code异常:&#123;&#125;&quot;, getStatusCode());</span><br><span class="line">                    &#125;</span><br><span class="line">                    return super.writeWith(body);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).build());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public int getOrder() &#123;</span><br><span class="line">            return NettyWriteResponseFilter.WRITE_RESPONSE_FILTER_ORDER - 1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个方法会出现问题，body的截取长度经常没有完全。</p>
<p>我本来是到这个网址下面寻找答案，作者是这样回复的：</p>
<p>　　上面只是简单的样例，FIux是发送多个数据的，当报文长时会拆分，处理一次只能拿到一部分报文，可以使用Flux.toArray方法将数据聚合后处理，也可以参照<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9b781fb1aaa0%E9%87%8C%E9%9D%A2%E7%9A%84%E5%93%8D%E5%BA%94%E5%A4%84%E7%90%86%E3%80%82">https://www.jianshu.com/p/9b781fb1aaa0里面的响应处理。</a></p>
<p>确实是这个问题，所以我们也可以仿照他的另外一个例子写，大家可以到他的简书博客中去看，值得提醒的是，他的例子中，版本也是2.0.1,若是版本改为2.1以上，就不能用哦！</p>
<p>这里蛮贴一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br></pre></td><td class="code"><pre><span class="line">package com.newland.dc.ctid.fileter;</span><br><span class="line"></span><br><span class="line">import com.google.gson.Gson;</span><br><span class="line">import com.newland.dc.common.vo.RequestHeaderVo;</span><br><span class="line">import com.newland.dc.ctid.service.SecurityService;</span><br><span class="line">import com.newland.dc.log.kafka.KafkaLog;</span><br><span class="line">import org.reactivestreams.Publisher;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.cloud.gateway.filter.GatewayFilter;</span><br><span class="line">import org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line">import org.springframework.cloud.gateway.filter.NettyWriteResponseFilter;</span><br><span class="line">import org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;</span><br><span class="line">import org.springframework.cloud.gateway.support.*;</span><br><span class="line">import org.springframework.core.Ordered;</span><br><span class="line">import org.springframework.core.io.buffer.DataBuffer;</span><br><span class="line">import org.springframework.core.style.ToStringCreator;</span><br><span class="line">import org.springframework.http.HttpHeaders;</span><br><span class="line">import org.springframework.http.HttpStatus;</span><br><span class="line">import org.springframework.http.MediaType;</span><br><span class="line">import org.springframework.http.ResponseCookie;</span><br><span class="line">import org.springframework.http.client.reactive.ClientHttpResponse;</span><br><span class="line">import org.springframework.http.server.reactive.ServerHttpRequest;</span><br><span class="line">import org.springframework.http.server.reactive.ServerHttpRequestDecorator;</span><br><span class="line">import org.springframework.http.server.reactive.ServerHttpResponse;</span><br><span class="line">import org.springframework.http.server.reactive.ServerHttpResponseDecorator;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.util.MultiValueMap;</span><br><span class="line">import org.springframework.web.reactive.function.client.ExchangeStrategies;</span><br><span class="line">import org.springframework.web.reactive.function.server.ServerRequest;</span><br><span class="line">import org.springframework.web.server.ServerWebExchange;</span><br><span class="line">import reactor.core.publisher.Flux;</span><br><span class="line">import reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.util.*;</span><br><span class="line">import java.util.function.BiFunction;</span><br><span class="line">import java.util.function.Function;</span><br><span class="line"></span><br><span class="line">import static org.springframework.cloud.gateway.support.ServerWebExchangeUtils.ORIGINAL_RESPONSE_CONTENT_TYPE_ATTR;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: garfield</span><br><span class="line"> * @Date: 2019&#x2F;2&#x2F;28 上午10:45</span><br><span class="line"> * @Description:</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Component</span><br><span class="line">public class EncryptGatewayFilterFactory extends AbstractGatewayFilterFactory&lt;EncryptGatewayFilterFactory.Config&gt; &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger log &#x3D; LoggerFactory.getLogger(EncryptGatewayFilterFactory.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private SecurityService encryptService;</span><br><span class="line"></span><br><span class="line">    public EncryptGatewayFilterFactory() &#123;</span><br><span class="line">        super(Config.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;    private Gson gson &#x3D; new GsonBuilder().serializeNulls().create();</span><br><span class="line">    private Gson gson &#x3D; new Gson();</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;server.host:10.10.10.10&#125;&quot;)</span><br><span class="line">    private String serverHost;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;server.port&#125;&quot;)</span><br><span class="line">    private String serverPort;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public GatewayFilter apply(Config config) &#123;</span><br><span class="line">        return new EncryptGatewayFilter(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ServerHttpRequest.Builder mutate(ServerHttpRequest request) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static class Config &#123;</span><br><span class="line"></span><br><span class="line">        private boolean encrypt;</span><br><span class="line"></span><br><span class="line">        public boolean isEncrypt() &#123;</span><br><span class="line">            return encrypt;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Config setEncrypt(boolean encrypt) &#123;</span><br><span class="line">            this.encrypt &#x3D; encrypt;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public String toString() &#123;</span><br><span class="line">            return new ToStringCreator(this)</span><br><span class="line">                    .append(&quot;encrypt&quot;, encrypt)</span><br><span class="line">                    .toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;String&gt; shortcutFieldOrder() &#123;</span><br><span class="line">        return Arrays.asList(&quot;encrypt&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class EncryptGatewayFilter implements GatewayFilter, Ordered &#123;</span><br><span class="line">        Config config;</span><br><span class="line"></span><br><span class="line">        EncryptGatewayFilter(Config config) &#123;</span><br><span class="line">            this.config &#x3D; config;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">            String trace &#x3D; exchange.getRequest().getHeaders().getFirst(&quot;trace&quot;);</span><br><span class="line">            ServerRequest serverRequest &#x3D; new DefaultServerRequest(exchange);</span><br><span class="line">            return serverRequest.bodyToMono(String.class).flatMap(reqBody -&gt; &#123;</span><br><span class="line">                &#x2F;&#x2F;重写原始请求</span><br><span class="line">                ServerHttpRequestDecorator decorator &#x3D; new ServerHttpRequestDecorator(exchange.getRequest()) &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public HttpHeaders getHeaders() &#123;</span><br><span class="line">                        HttpHeaders httpHeaders &#x3D; new HttpHeaders();</span><br><span class="line">                        httpHeaders.putAll(super.getHeaders());</span><br><span class="line">                        return httpHeaders;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    @Override</span><br><span class="line">                    public Flux&lt;DataBuffer&gt; getBody() &#123;</span><br><span class="line">                        &#x2F;&#x2F;打印原始请求日志</span><br><span class="line">                        log.info(&quot;[Trace:&#123;&#125;]-gateway request:headers&#x3D;[&#123;&#125;],body&#x3D;[&#123;&#125;]&quot;, trace, getHeaders(), reqBody);</span><br><span class="line">                        return Flux.just(reqBody).map(bx -&gt; exchange.getResponse().bufferFactory().wrap(bx.getBytes()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">                &#x2F;&#x2F;重写原始响应</span><br><span class="line">                BodyHandlerServerHttpResponseDecorator responseDecorator &#x3D; new BodyHandlerServerHttpResponseDecorator(</span><br><span class="line">                        initBodyHandler(exchange), exchange.getResponse());</span><br><span class="line"></span><br><span class="line">                return chain.filter(exchange.mutate().request(decorator).response(responseDecorator).build());</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public int getOrder() &#123;</span><br><span class="line">            return NettyWriteResponseFilter.WRITE_RESPONSE_FILTER_ORDER - 1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public interface BodyHandlerFunction</span><br><span class="line">            extends BiFunction&lt;ServerHttpResponse, Publisher&lt;? extends DataBuffer&gt;, Mono&lt;Void&gt;&gt; &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected BodyHandlerFunction initBodyHandler(ServerWebExchange exchange) &#123;</span><br><span class="line">        return (resp, body) -&gt; &#123;</span><br><span class="line">            &#x2F;&#x2F;拦截</span><br><span class="line">            MediaType originalResponseContentType &#x3D; exchange.getAttribute(ORIGINAL_RESPONSE_CONTENT_TYPE_ATTR);</span><br><span class="line">            HttpHeaders httpHeaders &#x3D; new HttpHeaders();</span><br><span class="line">            httpHeaders.setContentType(originalResponseContentType);</span><br><span class="line">            DefaultClientResponseAdapter clientResponseAdapter &#x3D; new DefaultClientResponseAdapter(body, httpHeaders);</span><br><span class="line">            Mono&lt;String&gt; bodyMono &#x3D; clientResponseAdapter.bodyToMono(String.class);</span><br><span class="line">            &#x2F;&#x2F;此处可以获得前面放置的参数</span><br><span class="line">            return bodyMono.flatMap((respBody) -&gt; &#123;</span><br><span class="line">&#x2F;&#x2F;                打印返回响应日志</span><br><span class="line">                System.out.println(respBody);</span><br><span class="line">                return resp.writeWith(Flux.just(respBody).map(bx -&gt; resp.bufferFactory().wrap(bx.getBytes())));</span><br><span class="line">            &#125;).then();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">    public static class DefaultClientResponseAdapter extends DefaultClientResponse &#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * @param body</span><br><span class="line">         * @param httpHeaders</span><br><span class="line">         *&#x2F;</span><br><span class="line">        public DefaultClientResponseAdapter(Publisher&lt;? extends DataBuffer&gt; body,</span><br><span class="line">                                            HttpHeaders httpHeaders) &#123;</span><br><span class="line">            this(new ResponseAdapter(body, httpHeaders),</span><br><span class="line">                    ExchangeStrategies.withDefaults());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * @param response</span><br><span class="line">         * @param strategies</span><br><span class="line">         *&#x2F;</span><br><span class="line">        public DefaultClientResponseAdapter(ClientHttpResponse response,</span><br><span class="line">                                            ExchangeStrategies strategies) &#123;</span><br><span class="line">            super(response, strategies);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * ClientHttpResponse 适配器</span><br><span class="line">         *&#x2F;</span><br><span class="line">        static class ResponseAdapter implements ClientHttpResponse &#123;</span><br><span class="line">            &#x2F;**</span><br><span class="line">             * 响应数据</span><br><span class="line">             *&#x2F;</span><br><span class="line">            private final Flux&lt;DataBuffer&gt; flux;</span><br><span class="line">            &#x2F;**</span><br><span class="line">             *</span><br><span class="line">             *&#x2F;</span><br><span class="line">            private final HttpHeaders headers;</span><br><span class="line"></span><br><span class="line">            public ResponseAdapter(Publisher&lt;? extends DataBuffer&gt; body,</span><br><span class="line">                                   HttpHeaders headers) &#123;</span><br><span class="line">                this.headers &#x3D; headers;</span><br><span class="line">                if (body instanceof Flux) &#123;</span><br><span class="line">                    flux &#x3D; (Flux) body;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    flux &#x3D; ((Mono) body).flux();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public Flux&lt;DataBuffer&gt; getBody() &#123;</span><br><span class="line">                return flux;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public HttpHeaders getHeaders() &#123;</span><br><span class="line">                return headers;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public HttpStatus getStatusCode() &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public int getRawStatusCode() &#123;</span><br><span class="line">                return 0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public MultiValueMap&lt;String, ResponseCookie&gt; getCookies() &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class BodyHandlerServerHttpResponseDecorator extends ServerHttpResponseDecorator &#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * body 处理拦截器</span><br><span class="line">         *&#x2F;</span><br><span class="line">        private BodyHandlerFunction bodyHandler &#x3D; initDefaultBodyHandler();</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * 构造函数</span><br><span class="line">         *</span><br><span class="line">         * @param bodyHandler</span><br><span class="line">         * @param delegate</span><br><span class="line">         *&#x2F;</span><br><span class="line">        public BodyHandlerServerHttpResponseDecorator(BodyHandlerFunction bodyHandler, ServerHttpResponse delegate) &#123;</span><br><span class="line">            super(delegate);</span><br><span class="line">            if (bodyHandler !&#x3D; null) &#123;</span><br><span class="line">                this.bodyHandler &#x3D; bodyHandler;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public Mono&lt;Void&gt; writeWith(Publisher&lt;? extends DataBuffer&gt; body) &#123;</span><br><span class="line">            &#x2F;&#x2F;body 拦截处理器处理响应</span><br><span class="line">            return bodyHandler.apply(getDelegate(), body);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public Mono&lt;Void&gt; writeAndFlushWith(Publisher&lt;? extends Publisher&lt;? extends DataBuffer&gt;&gt; body) &#123;</span><br><span class="line">            return writeWith(Flux.from(body).flatMapSequential(p -&gt; p));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * 默认body拦截处理器</span><br><span class="line">         *</span><br><span class="line">         * @return</span><br><span class="line">         *&#x2F;</span><br><span class="line">        private BodyHandlerFunction initDefaultBodyHandler() &#123;</span><br><span class="line">            return (resp, body) -&gt; resp.writeWith(body);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么万事具备，代码都写好了，我们又需要进行性能测试。这边要记住，我用的是官方的那个例子，其他的写法也用过了，但是结果差不多。</p>
<h1 id="4-再一次测试spring-cloud-gateway-网关路由性能"><a href="#4-再一次测试spring-cloud-gateway-网关路由性能" class="headerlink" title="4.再一次测试spring-cloud-gateway 网关路由性能"></a>4.再一次测试spring-cloud-gateway 网关路由性能</h1><p>　　step.1：性能测试，改一下配置，表示加入了过滤器。这里为什么只有一个过滤器，因为这个过滤器问题比较大，过程就略过了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- id: an</span><br><span class="line">        uri: http:&#x2F;&#x2F;10.1.4.32:14077&#x2F;hello</span><br><span class="line">        predicates:</span><br><span class="line">        - Path&#x3D;&#x2F;an</span><br><span class="line">        filters:</span><br><span class="line">        - An</span><br></pre></td></tr></table></figure>

<p>　经过多次测试，其他的过滤器都还好，只有修改response body的过滤器，严重影响性能，且有读写错误。</p>
<p>　　step.2：测试，以及测试结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[wrk@localhost wrk]$ .&#x2F;wrk  -t 15 -c500 -d 10 --latency -s scripts&#x2F;gateway.lua  http:&#x2F;&#x2F;10.1.4.32:14077&#x2F;an</span><br><span class="line">Running 10s test @ http:&#x2F;&#x2F;10.1.4.32:14077&#x2F;an</span><br><span class="line">  15 threads and 500 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +&#x2F;- Stdev</span><br><span class="line">    Latency     1.03s   488.75ms   2.00s    60.62%</span><br><span class="line">    Req&#x2F;Sec    26.59     13.84    80.00     67.60%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%  931.54ms</span><br><span class="line">     75%    1.45s</span><br><span class="line">     90%    1.76s</span><br><span class="line">     99%    1.97s</span><br><span class="line">  3848 requests in 10.10s, 1.64MB read</span><br><span class="line">  Socket errors: connect 0, read 0, write 0, timeout 458</span><br><span class="line">Requests&#x2F;sec:    381.05</span><br><span class="line">Transfer&#x2F;sec:    166.71KB</span><br></pre></td></tr></table></figure>

<p>结果多出一行，socket错误，而且还是超时,而且，日志中也存在错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2019-03-06T16:09:33,396|INFO ||AsyncResolver-bootstrap-executor-0||||Resolving eureka endpoints via configuration</span><br><span class="line">2019-03-06T16:10:38,268|ERROR||reactor-http-server-epoll-18||||Unhandled failure: Connection has been closed, response already set (status&#x3D;200)</span><br><span class="line">2019-03-06T16:10:38,268|WARN ||reactor-http-server-epoll-18||||Handling completed with error: Connection has been closed</span><br><span class="line">2019-03-06T16:10:38,269|ERROR||reactor-http-server-epoll-18||||Unhandled failure: null, response already set (status&#x3D;200)</span><br><span class="line">2019-03-06T16:10:38,269|WARN ||reactor-http-server-epoll-18||||Handling completed with error: null</span><br><span class="line">2019-03-06T16:10:38,294|ERROR||reactor-http-server-epoll-18||||Unhandled failure: syscall:write(..) failed: 断开的管道, response already set (status&#x3D;null)</span><br><span class="line">2019-03-06T16:10:38,294|WARN ||reactor-http-server-epoll-18||||Handling completed with error: syscall:write(..) failed: 断开的管道</span><br><span class="line">2019-03-06T16:10:38,306|ERROR||reactor-http-server-epoll-23||||Unhandled failure: syscall:write(..) failed: 断开的管道, response already set (status&#x3D;null)</span><br><span class="line">2019-03-06T16:10:38,306|WARN ||reactor-http-server-epoll-23||||Handling completed with error: syscall:write(..) failed: 断开的管道</span><br><span class="line">2019-03-06T16:14:33,397|INFO ||AsyncResolver-bootstrap-executor-0||||Resolving eureka endpoints via configuration</span><br></pre></td></tr></table></figure>

<p>这个问题很严重了，因为单个请求的时候，并不会报错，这个错误只发生在高并发压测下，无法追踪。最重要的是，我们看到性能只剩下300/s，这是万万不能接受的，生产更不能接收。</p>
<p>这个问题很难解释，因为我们采用的是官方提供的写法，我们回头看官方的修改response 类，好吧，不用看了，因为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">package org.springframework.cloud.gateway.filter.factory.rewrite;</span><br><span class="line">&#x2F;**</span><br><span class="line"> * This filter is BETA and may be subject to change in a future release.</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class ModifyResponseBodyGatewayFilterFactory</span><br><span class="line">        extends AbstractGatewayFilterFactory&lt;ModifyResponseBodyGatewayFilterFactory.Config&gt; &#123;</span><br></pre></td></tr></table></figure>

<p>官方已经说了，这是测试版本，不顶用。</p>
<p>不死心，又想起了gateway提供的GlobalFilter，将刚才的代码写到全局过滤器中再试试，但是结果相同！</p>
<p>凉凉…</p>
<p>跪求结论跟我不同的启发文档，或者只能等下一版本了。</p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
		data-enable='false'
        data-ae='false'
        data-ci=''
        data-cs=''
        data-r=''
        data-o=''
        data-a=''
        data-d='false'
    >查看评论</div>


    </div>
    
        <div class='side'>
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%8D%87%E7%BA%A7%E4%B8%BAspring-cloud-gateway%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">1 为什么要升级为spring-cloud-gateway？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-spring-cloud-gateway%E7%9A%84%E5%88%9D%E6%AD%A5%E6%B5%8B%E8%AF%95"><span class="toc-number">2.</span> <span class="toc-text">2.spring-cloud-gateway的初步测试</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8spring-cloud-gateway"><span class="toc-number">3.</span> <span class="toc-text">3.开始使用spring-cloud-gateway</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E5%86%8D%E4%B8%80%E6%AC%A1%E6%B5%8B%E8%AF%95spring-cloud-gateway-%E7%BD%91%E5%85%B3%E8%B7%AF%E7%94%B1%E6%80%A7%E8%83%BD"><span class="toc-number">4.</span> <span class="toc-text">4.再一次测试spring-cloud-gateway 网关路由性能</span></a></li></ol>	
        </div>
    
</div>


    </div>
</div>
</body>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>
<script src="/js/APlayer.min.js"></script>
<script src="/js/Meting.min.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>




</html>
