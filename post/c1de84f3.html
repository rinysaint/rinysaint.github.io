
<!DOCTYPE html>
<html lang="zh-Hans" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>大数据Flink详细教程(终篇) - 萧日宁的世界</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="Access-Control-Allow-Origin" content="*" />
    <meta name="keywords" content="萧日宁,肖日宁,君子兰,人工智能,AI,机器学习,博客,大数据,微服务,xiaorining,kingslanding,"> 
    <meta name="description" content="萧日宁,肖日宁,君子兰,人工智能,AI,机器学习,博客,大数据,微服务,xiaorining,kingslanding,大数据计算框架 Flink 实战教程共分为3篇。涵盖 Flink 安装配置、基本原理、核心概念、 流处理 API 和批处理 API、存储及状态一致性、容错机制、实战案例以及面试题讲解等。
本篇为第3,"> 
    <meta name="author" content="萧日宁"> 
    <link rel="alternative" href="atom.xml" title="萧日宁的世界" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
    
<link rel="stylesheet" href="/css/diaspora.css">
<link rel="stylesheet" href="/css/APlayer.min.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body class="loading">
    <span id="config-title" style="display:none">萧日宁的世界</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="https://blog.aichn.cn"></a>
        <!-- page音乐插件 -->
        
    <h3 class="subtitle">大数据Flink详细教程(终篇)</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">大数据Flink详细教程(终篇)</h1>
        <div class="stuff">
            <span>九月 28, 2019</span>
            
  <ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE-Flink/" rel="tag">大数据,Flink</a></li></ul>


        </div>
        <div class="content markdown">
            <p>大数据计算框架 <a target="_blank" rel="noopener" href="https://flink.apache.org/">Flink</a> 实战教程共分为3篇。涵盖 <a target="_blank" rel="noopener" href="https://baike.baidu.com/item/flink/9078426?fr=aladdin">Flink</a> 安装配置、基本原理、核心概念、 流处理 API 和批处理 API、存储及状态一致性、容错机制、实战案例以及面试题讲解等。</p>
<p>本篇为第3篇，主要讲解 <a target="_blank" rel="noopener" href="https://flink.apache.org/">Flink</a> 的<strong>实战</strong>案例。第1篇看<a href="d713bc0c.html">这里</a>；第2篇看<a href="7f834cb4.html">这里</a>。</p>
<p>【<strong>仅需一次订阅，作者所有专栏都能看</strong>】</p>
<p>推荐【<strong>Kafka</strong>】<a target="_blank" rel="noopener" href="https://bigbird.blog.csdn.net/article/details/108770504">https://bigbird.blog.csdn.net/article/details/108770504</a><br>推荐【<strong>Flink</strong>】<a target="_blank" rel="noopener" href="https://blog.csdn.net/hellozpc/article/details/109413465">https://blog.csdn.net/hellozpc/article/details/109413465</a><br>推荐【<strong>SpringBoot</strong>】<a target="_blank" rel="noopener" href="https://blog.csdn.net/hellozpc/article/details/107095951">https://blog.csdn.net/hellozpc/article/details/107095951</a><br>推荐【<strong>SpringCloud</strong>】<a target="_blank" rel="noopener" href="https://blog.csdn.net/hellozpc/article/details/83692496">https://blog.csdn.net/hellozpc/article/details/83692496</a><br>推荐【<strong>Mybatis</strong>】<a target="_blank" rel="noopener" href="https://blog.csdn.net/hellozpc/article/details/80878563">https://blog.csdn.net/hellozpc/article/details/80878563</a><br>推荐【<strong>SnowFlake</strong>】<a target="_blank" rel="noopener" href="https://blog.csdn.net/hellozpc/article/details/108248227">https://blog.csdn.net/hellozpc/article/details/108248227</a><br>推荐【<strong>并发限流</strong>】<a target="_blank" rel="noopener" href="https://blog.csdn.net/hellozpc/article/details/107582771">https://blog.csdn.net/hellozpc/article/details/107582771</a></p>
<p>本篇在讲解<a target="_blank" rel="noopener" href="https://flink.apache.org/">Flink</a>案例之前先补充了几个知识点。</p>
<h3 id="文章目录"><a href="#文章目录" class="headerlink" title="文章目录"></a>文章目录</h3><ul>
<li><ul>
<li><ul>
<li><a href="#BroadCast_StateBroadCast_Stream_19">BroadCast State和BroadCast Stream</a></li>
<li><a href="#RocksDB_425">RocksDB</a></li>
<li><a href="#QueryableState_502">QueryableState</a></li>
<li><ul>
<li><a href="#QueryableState_506">QueryableState组件</a></li>
<li><a href="#Queryable_State_514">开启Queryable State</a></li>
<li><a href="#Flink_536">在Flink中使状态可查询</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_736">实战案例</a></li>
<li><ul>
<li><a href="#UV_738">网页UV统计</a></li>
<li><ul>
<li><a href="#_742">日志数据实体类</a></li>
<li><a href="#Flink_754">Flink应用程序</a></li>
<li><a href="#topic_851">创建topic</a></li>
<li><a href="#jarflink_895">上传jar到flink集群中运行</a></li>
<li><a href="#Flink_903">远程提交Flink应用</a></li>
<li><a href="#springbootflink_915">springboot启动flink任务</a></li>
<li><ul>
<li><a href="#pomxml_917">pom.xml</a></li>
<li><a href="#SpringBoot_1067">SpringBoot入口类</a></li>
<li><a href="#Flink_1089">Flink应用程序</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_1210">头条实时热榜统计</a></li>
<li><a href="#_1569">订单超时检测</a></li>
<li><ul>
<li><a href="#CEP_1573">CEP简介</a></li>
<li><a href="#_1615">近邻模式</a></li>
<li><a href="#_1651">模式检测</a></li>
</ul>
</li>
<li><a href="#_1840">订单系统实时对账</a></li>
</ul>
</li>
<li><a href="#_2012">面试题集锦</a></li>
</ul>
</li>
</ul>
<h3 id="BroadCast-State和BroadCast-Stream"><a href="#BroadCast-State和BroadCast-Stream" class="headerlink" title="BroadCast State和BroadCast Stream"></a>BroadCast State和BroadCast Stream</h3><p>BroadCastStream是由BroadCastState(广播状态)组成的数据流。BroadcastStream通常是通过调用DataStream的 broadcast() 方法返回，该方法的入参是一个 MapStateDescriptor对象。BroadcastStream后面不支持算子操作，只能使用DataStream的connect方法去连接BroadcastStream，得到一个BroadcastConnectedStream。</p>
<p>BroadcastState是Flink支持的Operator State的一种。使用广播状态可以将输入流中的数据广播(broadcast)到下游的operator的每个并发Task中。由于这些数据能够被所有Task共享，因此BroadcastState经常用在一些需要共享数据的场景，比如配置分发，这样每个Task都可以读取到最新的配置文件数据。</p>
<p>使用Broadcast State的一般步骤是：先创建一个Keyed或Non-Keyed的Data Stream，再调用DataStream的 broadcast() 方法得到一个Broadcasted Stream，该方法传入的是一个MapStateDescriptor对象。最后将处理数据的Data Stream连接到Broadcasted Stream上得到一个BroadcastConnectedStream。这样就将Broadcast State广播到Data Stream下游operator的每个并发实例中。</p>
<p>若业务Data Stream是Keyed Stream，则连接到Broadcasted Stream后，添加的处理函数为KeyedBroadcastProcessFunction。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">KeyedBroadcastProcessFunction</span>&lt;KS, IN1, IN2, OUT&gt; <span class="keyword">extends</span> <span class="title class_">BaseBroadcastProcessFunction</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(<span class="keyword">final</span> IN1 value, <span class="keyword">final</span> ReadOnlyContext ctx, <span class="keyword">final</span> Collector&lt;OUT&gt; out)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">processBroadcastElement</span><span class="params">(<span class="keyword">final</span> IN2 value, <span class="keyword">final</span> Context ctx, <span class="keyword">final</span> Collector&lt;OUT&gt; out)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>泛型参数的含义如下：</p>
<p>KS：Keyed Stream的keyBy的元素类型</p>
<p>IN1：非Broadcast的Data Stream中的数据记录的类型</p>
<p>IN2：Broadcast Stream中的数据记录的类型</p>
<p>OUT：经过处理后返回数据的数据类型</p>
<p>若Data Stream是Non-Keyed Stream，则连接到Broadcasted Stream后，添加的处理函数为BroadcastProcessFunction。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BroadcastProcessFunction</span>&lt;IN1, IN2, OUT&gt; <span class="keyword">extends</span> <span class="title class_">BaseBroadcastProcessFunction</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(<span class="keyword">final</span> IN1 value, <span class="keyword">final</span> ReadOnlyContext ctx, <span class="keyword">final</span> Collector&lt;OUT&gt; out)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">processBroadcastElement</span><span class="params">(<span class="keyword">final</span> IN2 value, <span class="keyword">final</span> Context ctx, <span class="keyword">final</span> Collector&lt;OUT&gt; out)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述泛型参数的含义与KeyedBroadcastProcessFunction中的相同，只是没有keyBy操作，所以就没有KS泛型参数。</p>
<p>下面一个完整的例子来阐述如何使用广播处理函数。</p>
<p>需求1)：自定义一个数据源，构建一个广播流，定时读取配置文件。在处理流中应用最新的配置，如果业务数据流中的元素在配置文件中开启处理标记则处理，否则忽略。</p>
<p>编写自定义数据源读定时取配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfigSource</span> <span class="keyword">implements</span> <span class="title class_">SourceFunction</span>&lt;String&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isRunning</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">confPath</span> <span class="operator">=</span> <span class="string">&quot;F:\\data\\conf.txt&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * run方法里编写数据产生逻辑</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(SourceContext&lt;String&gt; ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line">            List&lt;String&gt; lines = Files.readAllLines(Paths.get(confPath));</span><br><span class="line">            lines.forEach(ctx::collect);</span><br><span class="line">            Thread.sleep(<span class="number">30000</span>);<span class="comment">//每隔30秒更新一次配置</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span> &#123;</span><br><span class="line">        isRunning = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写Flink应用程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BroadCastDemo</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">9001</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">hostname</span> <span class="operator">=</span> <span class="string">&quot;192.168.174.136&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">delimiter</span> <span class="operator">=</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//定义MapStateDescriptor来保存要广播的数据</span></span><br><span class="line">        <span class="keyword">final</span> MapStateDescriptor&lt;String, String&gt; CONFIG_DESCRIPTOR = <span class="keyword">new</span> <span class="title class_">MapStateDescriptor</span>&lt;&gt;(</span><br><span class="line">                <span class="string">&quot;config&quot;</span>,</span><br><span class="line">                BasicTypeInfo.STRING_TYPE_INFO,</span><br><span class="line">                BasicTypeInfo.STRING_TYPE_INFO);</span><br><span class="line">        <span class="comment">//创建广播流，向下游广播配置数据</span></span><br><span class="line">        BroadcastStream&lt;String&gt; broadcastStream = env.addSource(<span class="keyword">new</span> <span class="title class_">MyConfigSource</span>()).broadcast(CONFIG_DESCRIPTOR);</span><br><span class="line">        <span class="comment">//创建业务数据流</span></span><br><span class="line">        <span class="comment">//连接socket获取输入数据</span></span><br><span class="line">        DataStreamSource&lt;String&gt; dataStreamSource = env.socketTextStream(hostname, port, delimiter);</span><br><span class="line">        dataStreamSource.connect(broadcastStream).process(<span class="keyword">new</span> <span class="title class_">BroadcastProcessFunction</span>&lt;String, String, Object&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(String value, ReadOnlyContext ctx, Collector&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="comment">//获取广播数据</span></span><br><span class="line">                ReadOnlyBroadcastState&lt;String, String&gt; broadcastState = ctx.getBroadcastState(CONFIG_DESCRIPTOR);</span><br><span class="line">                <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> broadcastState.get(value);</span><br><span class="line">                <span class="comment">//如果key对应的value为1，则表示该数据要被处理</span></span><br><span class="line">                <span class="keyword">if</span> (flag != <span class="literal">null</span> &amp;&amp; flag.equals(<span class="string">&quot;1&quot;</span>)) &#123;</span><br><span class="line">                    out.collect(value + <span class="string">&quot;被处理了&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processBroadcastElement</span><span class="params">(String value, Context ctx, Collector&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;update config:&quot;</span> + value);</span><br><span class="line">                String[] split = value.split(<span class="string">&quot;=&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> split[<span class="number">0</span>];</span><br><span class="line">                <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> split[<span class="number">1</span>];</span><br><span class="line">                <span class="comment">//接收广播数据，更新State</span></span><br><span class="line">                BroadcastState&lt;String, String&gt; broadcastState = ctx.getBroadcastState(CONFIG_DESCRIPTOR);</span><br><span class="line">                broadcastState.put(key, flag);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).print();</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">&quot;broadcast&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件conf.txt：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat=<span class="number">1</span></span><br><span class="line">dog=<span class="number">0</span></span><br><span class="line">fish=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>linux控制台输入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vm1 ~]# nc -lk 9001</span><br><span class="line">cat</span><br><span class="line">dog</span><br><span class="line">fish</span><br></pre></td></tr></table></figure>

<p>idea控制台输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">update config:cat=<span class="number">1</span></span><br><span class="line">update config:dog=<span class="number">0</span></span><br><span class="line">update config:fish=<span class="number">1</span></span><br><span class="line">cat被处理了</span><br><span class="line">fish被处理了</span><br></pre></td></tr></table></figure>

<p>修改conf.txt</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat=<span class="number">1</span></span><br><span class="line">dog=<span class="number">1</span></span><br><span class="line">fish=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>linux控制台输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dog</span><br></pre></td></tr></table></figure>

<p>IDEA控制台输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">update config:cat=<span class="number">1</span></span><br><span class="line">update config:dog=<span class="number">1</span></span><br><span class="line">update config:fish=<span class="number">1</span></span><br><span class="line">dog被处理了</span><br></pre></td></tr></table></figure>

<p>需求2)：从kafka topic中读取各个城市的网约车最高限速配置，并实时处理司机上报的里程数据，如果超速则告警。司机里程实时上报也使用kafka topic来接收。</p>
<p>kafka的详细教程参见博文 <a target="_blank" rel="noopener" href="https://blog.csdn.net/hellozpc/article/details/105680217">《kafka详细教程》</a><a target="_blank" rel="noopener" href="https://blog.csdn.net/hellozpc/article/details/105680217">https://blog.csdn.net/hellozpc/article/details/105680217</a></p>
<p>pom依赖引入kafka连接器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-kafka_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Java 代码</p>
<p>实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DriverUploadInfo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String driverId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前时间戳(毫秒)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> timestamp;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前里程表记录的总里程数(米)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> totalMileage;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 城市编码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String cityCode;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;DriverUploadInfo&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;driverId=&#x27;&quot;</span> + driverId + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, timestamp=&quot;</span> + timestamp +</span><br><span class="line">                <span class="string">&quot;, totalMileage=&quot;</span> + totalMileage +</span><br><span class="line">                <span class="string">&quot;, cityCode=&#x27;&quot;</span> + cityCode + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Flink应用程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BroadCastDemo2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//kafka配置参数</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        props.put(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;192.168.174.136:9092&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;zookeeper.connect&quot;</span>, <span class="string">&quot;192.168.174.136:2181&quot;</span>);</span><br><span class="line">        <span class="comment">//props.put(&quot;group.id&quot;, &quot;metric-group&quot;);</span></span><br><span class="line">        props.put(<span class="string">&quot;key.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;value.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;auto.offset.reset&quot;</span>, <span class="string">&quot;latest&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义MapStateDescriptor来保存要广播的数据</span></span><br><span class="line">        <span class="keyword">final</span> MapStateDescriptor&lt;String, Double&gt; CONFIG_DESCRIPTOR = <span class="keyword">new</span> <span class="title class_">MapStateDescriptor</span>&lt;&gt;(</span><br><span class="line">                <span class="string">&quot;speed_config&quot;</span>,</span><br><span class="line">                BasicTypeInfo.STRING_TYPE_INFO,</span><br><span class="line">                BasicTypeInfo.DOUBLE_TYPE_INFO);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置数据流，读取配置</span></span><br><span class="line">        BroadcastStream&lt;String&gt; broadcastStream = env.addSource(<span class="keyword">new</span> <span class="title class_">FlinkKafkaConsumer</span>&lt;&gt;(</span><br><span class="line">                <span class="string">&quot;city_speed_config&quot;</span>,  <span class="comment">//kafka topic</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">SimpleStringSchema</span>(),  <span class="comment">// String 序列化</span></span><br><span class="line">                props)).broadcast(CONFIG_DESCRIPTOR);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//业务数据流，处理数据</span></span><br><span class="line">        DataStreamSource&lt;String&gt; dataStreamSource = env.addSource(<span class="keyword">new</span> <span class="title class_">FlinkKafkaConsumer</span>&lt;&gt;(</span><br><span class="line">                <span class="string">&quot;driver_upload&quot;</span>,  <span class="comment">//kafka topic</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">SimpleStringSchema</span>(),  <span class="comment">// String 序列化</span></span><br><span class="line">                props));</span><br><span class="line"></span><br><span class="line">        KeyedStream&lt;DriverUploadInfo, String&gt; driverStream = dataStreamSource.map(<span class="keyword">new</span> <span class="title class_">MapFunction</span>&lt;String, DriverUploadInfo&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> DriverUploadInfo <span class="title function_">map</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="type">DriverUploadInfo</span> <span class="variable">driverUploadInfo</span> <span class="operator">=</span> JSON.parseObject(value, DriverUploadInfo.class);</span><br><span class="line">                <span class="keyword">return</span> driverUploadInfo;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).keyBy(<span class="keyword">new</span> <span class="title class_">KeySelector</span>&lt;DriverUploadInfo, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getKey</span><span class="params">(DriverUploadInfo value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="keyword">return</span> value.driverId;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        driverStream.connect(broadcastStream).process(<span class="keyword">new</span> <span class="title class_">KeyedBroadcastProcessFunction</span>&lt;Object, DriverUploadInfo, String, Object&gt;() &#123;</span><br><span class="line">            <span class="comment">//使用ValueState保存上一次司机状态信息</span></span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">transient</span> ValueState&lt;DriverUploadInfo&gt; driverState;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                ValueStateDescriptor&lt;DriverUploadInfo&gt; descriptor = <span class="keyword">new</span> <span class="title class_">ValueStateDescriptor</span>&lt;&gt;(<span class="string">&quot;driverInfoState&quot;</span>, DriverUploadInfo.class);</span><br><span class="line">                driverState = getRuntimeContext().getState(descriptor);<span class="comment">//注册状态</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(DriverUploadInfo driverUploadInfo, ReadOnlyContext ctx, Collector&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;received event:&quot;</span> + driverUploadInfo);</span><br><span class="line">                ReadOnlyBroadcastState&lt;String, Double&gt; broadcastState = ctx.getBroadcastState(CONFIG_DESCRIPTOR);</span><br><span class="line">                <span class="type">Double</span> <span class="variable">speedLimit</span> <span class="operator">=</span> broadcastState.get(driverUploadInfo.cityCode);</span><br><span class="line"></span><br><span class="line">                <span class="type">DriverUploadInfo</span> <span class="variable">previousInfo</span> <span class="operator">=</span> driverState.value();</span><br><span class="line">                <span class="keyword">if</span> (previousInfo != <span class="literal">null</span> &amp;&amp; speedLimit != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//计算平均车速，通过里程表数差除以时间戳之差求得这段时间内的平均速度</span></span><br><span class="line">                    <span class="type">double</span> <span class="variable">distance</span> <span class="operator">=</span> driverUploadInfo.totalMileage - previousInfo.totalMileage;</span><br><span class="line">                    <span class="type">double</span> <span class="variable">interval</span> <span class="operator">=</span> (driverUploadInfo.timestamp - previousInfo.timestamp) / <span class="number">1000</span>;</span><br><span class="line">                    <span class="type">double</span> <span class="variable">speed</span> <span class="operator">=</span> distance / interval;</span><br><span class="line">                    System.out.println(<span class="string">&quot;current speedLimit:&quot;</span> + speedLimit + <span class="string">&quot;,current speed:&quot;</span> + speed);</span><br><span class="line">                    <span class="keyword">if</span> (speed &gt; speedLimit) &#123;</span><br><span class="line">                        out.collect(<span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;String, Double&gt;(driverUploadInfo.driverId + <span class="string">&quot;已超速&quot;</span>, speed));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//更新状态</span></span><br><span class="line">                driverState.update(driverUploadInfo);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processBroadcastElement</span><span class="params">(String value, Context ctx, Collector&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;update config:&quot;</span> + value);</span><br><span class="line">                List&lt;CityConfig&gt; cityConfigs = JSON.parseArray(value, CityConfig.class);</span><br><span class="line">                BroadcastState&lt;String, Double&gt; broadcastState = ctx.getBroadcastState(CONFIG_DESCRIPTOR);</span><br><span class="line">                cityConfigs.forEach(e -&gt; &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        broadcastState.put(e.cityCode, e.speedLimit);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).print();</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">&quot;Broadcast State demo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在linux上启动Kafka集群测试。</p>
<p>创建配置topic，topic名称city_speed_config</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --create --topic city_speed_config --bootstrap-server 192.168.174.136:9092</span><br></pre></td></tr></table></figure>

<p>创建业务数据topic接收司机上报数据，topic名称driver_upload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --create --topic driver_upload --bootstrap-server 192.168.174.136:9092</span><br></pre></td></tr></table></figure>

<p>查看主题列表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --list --bootstrap-server 192.168.174.136:9092</span><br></pre></td></tr></table></figure>

<p>运行Java程序，启动Flink作业。</p>
<p>使用Kafka生产者脚本发送消息到主题city_speed_config：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-console-producer.sh --topic city_speed_config --bootstrap-server 192.168.174.136:9092</span><br></pre></td></tr></table></figure>

<p>输入 <code>[&#123;&quot;cityCode&quot;:&quot;320100&quot;,&quot;speedLimit&quot;:&quot;45&quot;&#125;,&#123;&quot;cityCode&quot;:&quot;320101&quot;,&quot;speedLimit&quot;:&quot;55&quot;&#125;]</code></p>
<p>使用Kafka生产者脚本发送消息到主题driver_upload ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-console-producer.sh --topic driver_upload --bootstrap-server 192.168.174.136:9092</span><br></pre></td></tr></table></figure>

<p>一条一条输入下列数据，观察IDEA控制台的输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;driverId&quot;:&quot;D10001&quot;,&quot;cityCode&quot;:&quot;320100&quot;,&quot;timestamp&quot;:1607347920499,&quot;totalMileage&quot;:1000&#125;</span><br><span class="line">&#123;&quot;driverId&quot;:&quot;D10001&quot;,&quot;cityCode&quot;:&quot;320100&quot;,&quot;timestamp&quot;:1607347921501,&quot;totalMileage&quot;:1040&#125;</span><br><span class="line">&#123;&quot;driverId&quot;:&quot;D10001&quot;,&quot;cityCode&quot;:&quot;320100&quot;,&quot;timestamp&quot;:1607347922503,&quot;totalMileage&quot;:1090&#125;</span><br><span class="line">&#123;&quot;driverId&quot;:&quot;D10001&quot;,&quot;cityCode&quot;:&quot;320100&quot;,&quot;timestamp&quot;:1607347923503,&quot;totalMileage&quot;:1120&#125;</span><br><span class="line">1234</span><br><span class="line">&#123;&quot;driverId&quot;:&quot;D10002&quot;,&quot;cityCode&quot;:&quot;320101&quot;,&quot;timestamp&quot;:1607347920499,&quot;totalMileage&quot;:1000&#125;</span><br><span class="line">&#123;&quot;driverId&quot;:&quot;D10002&quot;,&quot;cityCode&quot;:&quot;320101&quot;,&quot;timestamp&quot;:1607347921501,&quot;totalMileage&quot;:1040&#125;</span><br><span class="line">&#123;&quot;driverId&quot;:&quot;D10002&quot;,&quot;cityCode&quot;:&quot;320101&quot;,&quot;timestamp&quot;:1607347922503,&quot;totalMileage&quot;:1095&#125;</span><br><span class="line">&#123;&quot;driverId&quot;:&quot;D10002&quot;,&quot;cityCode&quot;:&quot;320101&quot;,&quot;timestamp&quot;:1607347923503,&quot;totalMileage&quot;:1151&#125;</span><br></pre></td></tr></table></figure>

<p>IDEA控制台输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">update config:[&#123;<span class="string">&quot;cityCode&quot;</span>:<span class="string">&quot;320100&quot;</span>,<span class="string">&quot;speedLimit&quot;</span>:<span class="string">&quot;45&quot;</span>&#125;,&#123;<span class="string">&quot;cityCode&quot;</span>:<span class="string">&quot;320101&quot;</span>,<span class="string">&quot;speedLimit&quot;</span>:<span class="string">&quot;55&quot;</span>&#125;]  </span><br><span class="line">received event:DriverUploadInfo&#123;driverId=<span class="string">&#x27;D10001&#x27;</span>, timestamp=<span class="number">1607347920499</span>, totalMileage=<span class="number">1000.0</span>, cityCode=<span class="string">&#x27;320100&#x27;</span>&#125;</span><br><span class="line">received event:DriverUploadInfo&#123;driverId=<span class="string">&#x27;D10001&#x27;</span>, timestamp=<span class="number">1607347921501</span>, totalMileage=<span class="number">1040.0</span>, cityCode=<span class="string">&#x27;320100&#x27;</span>&#125;</span><br><span class="line">current speedLimit:<span class="number">45.0</span>,current speed:<span class="number">40.0</span></span><br><span class="line">received event:DriverUploadInfo&#123;driverId=<span class="string">&#x27;D10001&#x27;</span>, timestamp=<span class="number">1607347922503</span>, totalMileage=<span class="number">1090.0</span>, cityCode=<span class="string">&#x27;320100&#x27;</span>&#125;</span><br><span class="line">current speedLimit:<span class="number">45.0</span>,current speed:<span class="number">50.0</span></span><br><span class="line">(D10001已超速,<span class="number">50.0</span>)</span><br><span class="line">received event:DriverUploadInfo&#123;driverId=<span class="string">&#x27;D10001&#x27;</span>, timestamp=<span class="number">1607347923503</span>, totalMileage=<span class="number">1120.0</span>, cityCode=<span class="string">&#x27;320100&#x27;</span>&#125;</span><br><span class="line">current speedLimit:<span class="number">45.0</span>,current speed:<span class="number">30.0</span></span><br><span class="line">received event:DriverUploadInfo&#123;driverId=<span class="string">&#x27;D10002&#x27;</span>, timestamp=<span class="number">1607347920499</span>, totalMileage=<span class="number">1000.0</span>, cityCode=<span class="string">&#x27;320101&#x27;</span>&#125;</span><br><span class="line">received event:DriverUploadInfo&#123;driverId=<span class="string">&#x27;D10002&#x27;</span>, timestamp=<span class="number">1607347921501</span>, totalMileage=<span class="number">1040.0</span>, cityCode=<span class="string">&#x27;320101&#x27;</span>&#125;</span><br><span class="line">current speedLimit:<span class="number">55.0</span>,current speed:<span class="number">40.0</span></span><br><span class="line">received event:DriverUploadInfo&#123;driverId=<span class="string">&#x27;D10002&#x27;</span>, timestamp=<span class="number">1607347922503</span>, totalMileage=<span class="number">1095.0</span>, cityCode=<span class="string">&#x27;320101&#x27;</span>&#125;</span><br><span class="line">current speedLimit:<span class="number">55.0</span>,current speed:<span class="number">55.0</span></span><br><span class="line">received event:DriverUploadInfo&#123;driverId=<span class="string">&#x27;D10002&#x27;</span>, timestamp=<span class="number">1607347923503</span>, totalMileage=<span class="number">1151.0</span>, cityCode=<span class="string">&#x27;320101&#x27;</span>&#125;</span><br><span class="line">current speedLimit:<span class="number">55.0</span>,current speed:<span class="number">56.0</span></span><br><span class="line">(D10002已超速,<span class="number">56.0</span>)</span><br></pre></td></tr></table></figure>

<p>重新发送配置数据到主题city_speed_config：</p>
<p>[{“cityCode”:“320100”,“speedLimit”:“60”},{“cityCode”:“320101”,“speedLimit”:“40”}]</p>
<p>再次发送业务数据到主题driver_upload 验证配置修改是否生效：</p>
<p>{“driverId”:“D10001”,“cityCode”:“320100”,“timestamp”:1607347920499,“totalMileage”:1000}</p>
<p>{“driverId”:“D10001”,“cityCode”:“320100”,“timestamp”:1607347921501,“totalMileage”:1061}</p>
<p>{“driverId”:“D10001”,“cityCode”:“320101”,“timestamp”:1607347922501,“totalMileage”:1112}</p>
<p>IDEA控制台输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">update config:[&#123;<span class="string">&quot;cityCode&quot;</span>:<span class="string">&quot;320100&quot;</span>,<span class="string">&quot;speedLimit&quot;</span>:<span class="string">&quot;60&quot;</span>&#125;,&#123;<span class="string">&quot;cityCode&quot;</span>:<span class="string">&quot;320101&quot;</span>,<span class="string">&quot;speedLimit&quot;</span>:<span class="string">&quot;40&quot;</span>&#125;]</span><br><span class="line">received event:DriverUploadInfo&#123;driverId=<span class="string">&#x27;D10001&#x27;</span>, timestamp=<span class="number">1607347920499</span>, totalMileage=<span class="number">1000.0</span>, cityCode=<span class="string">&#x27;320100&#x27;</span>&#125;</span><br><span class="line">current speedLimit:<span class="number">60.0</span>,current speed:<span class="number">40.0</span></span><br><span class="line">received event:DriverUploadInfo&#123;driverId=<span class="string">&#x27;D10001&#x27;</span>, timestamp=<span class="number">1607347921501</span>, totalMileage=<span class="number">1061.0</span>, cityCode=<span class="string">&#x27;320100&#x27;</span>&#125;</span><br><span class="line">current speedLimit:<span class="number">60.0</span>,current speed:<span class="number">61.0</span></span><br><span class="line">(D10001已超速,<span class="number">61.0</span>)</span><br><span class="line">received event:DriverUploadInfo&#123;driverId=<span class="string">&#x27;D10001&#x27;</span>, timestamp=<span class="number">1607347922501</span>, totalMileage=<span class="number">1112.0</span>, cityCode=<span class="string">&#x27;320101&#x27;</span>&#125;</span><br><span class="line">current speedLimit:<span class="number">40.0</span>,current speed:<span class="number">51.0</span></span><br><span class="line">(D10001已超速,<span class="number">51.0</span>)</span><br></pre></td></tr></table></figure>

<p>可见配置修改已经生效！至此，广播流的案例完结。</p>
<h3 id="RocksDB"><a href="#RocksDB" class="headerlink" title="RocksDB"></a>RocksDB</h3><p>RocksDB是使用C++编写的嵌入式kv存储引擎，其键值均允许使用二进制流。由Facebook基于levelDB开发， 提供向后兼容的levelDB API。RocksDB使用LSM存储引擎，这也是许多非关系型数据库比如Hbase的核心思想。RocksDB支持多种压缩算法，配置灵活，存储层可以直接使用内存，使用Flash，使用硬盘或者HDFS。</p>
<p>以RocksDB的Java驱动为例，来演示一下RocksDB的使用。</p>
<p>引入pom依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.rocksdb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocksdbjni<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.13.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Java代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.rocksdb.Options;</span><br><span class="line"><span class="keyword">import</span> org.rocksdb.RocksDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RocksDemo</span> &#123;</span><br><span class="line">    <span class="comment">// RocksDB是由C++编写，在Java中使用首先需要加载JNI Native库</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// a static method that loads the RocksDB C++ library.</span></span><br><span class="line">        RocksDB.loadLibrary();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// the Options class contains a set of configurable DB options that determines the behaviour of the database.</span></span><br><span class="line">        <span class="comment">// 创建配置</span></span><br><span class="line">        <span class="type">Options</span> <span class="variable">dbOpt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Options</span>();</span><br><span class="line">        <span class="comment">// 当数据库不存在时自动创建(路径中的上层目录需要先创建好)</span></span><br><span class="line">        dbOpt.setCreateIfMissing(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 指定RocksDB文件存储位置，默认是本地文件，存储在本地磁盘；也可以使用分布式文件系统比如HDFS</span></span><br><span class="line">        <span class="type">RocksDB</span> <span class="variable">rdb</span> <span class="operator">=</span> RocksDB.open(dbOpt, <span class="string">&quot;d:\\data\\rocksdb&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RocksDB以字节流形式保存数据</span></span><br><span class="line">        <span class="type">byte</span>[] key = <span class="string">&quot;data&quot;</span>.getBytes();</span><br><span class="line">        <span class="type">byte</span>[] value = <span class="string">&quot;hello rocks db&quot;</span>.getBytes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用put方法写入数据</span></span><br><span class="line">        rdb.put(key, value);</span><br><span class="line">        System.out.println(<span class="string">&quot;数据写入到RocksDB&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用get方法读取数据</span></span><br><span class="line">        System.out.println(<span class="string">&quot;从RocksDB读取数据，key = &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(key) + <span class="string">&quot;，value=&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(rdb.get(key)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除数据</span></span><br><span class="line">        rdb.delete(key);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭资源</span></span><br><span class="line">        rdb.close();</span><br><span class="line">        dbOpt.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述入门案例演示了RocksDB的存储和查询，那么在Flink中如何使用RocksDB作为状态后端存储呢？</p>
<p>引入pom依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-statebackend-rocksdb_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>设置RocksDB状态后端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env.setStateBackend(<span class="keyword">new</span> <span class="title class_">RocksDBStateBackend</span>(<span class="string">&quot;file:///D://data//rocksdb_flink&quot;</span>, <span class="literal">true</span>));</span><br></pre></td></tr></table></figure>

<h3 id="QueryableState"><a href="#QueryableState" class="headerlink" title="QueryableState"></a>QueryableState</h3><p>上述案例中，状态后端存储的状态数据我们是没法直接读取的，都是二进制流。Flink提供了一种获取运行时状态的机制，让我们可以实时获取到Job运行时的State。这就是可查询状态(Queryable State)服务，顾名思义就是允许用户从外部系统(如业务系统)中查询Flink作业内部的状态(State)。在一些需要给外部系统开放状态查询的场景可以使用此特性。</p>
<h4 id="QueryableState组件"><a href="#QueryableState组件" class="headerlink" title="QueryableState组件"></a>QueryableState组件</h4><p>QueryableStateClient：客户端组件，可以独立于Flink集群运行，用于提交用户查询请求。</p>
<p>QueryableStateClientProxy：代理组件，运行在每个TaskManager上(即在Flink集群中)，负责接收客户端的请求。客户端的查询请求通常带一个key，代理组件从JobManager处查得key所属的TaskManager，将客户端请求转发到该TaskManager上运行的QueryableStateServer中，并将用户查询的状态结果转发给客户端。</p>
<p>QueryableStateServer：状态查询组件，运行在每个TaskManager上，负责管理本地状态，处理客户端的查询。</p>
<h4 id="开启Queryable-State"><a href="#开启Queryable-State" class="headerlink" title="开启Queryable State"></a>开启Queryable State</h4><p>引入pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-queryable-state-runtime_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>本地代码中开启Queryable State服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Configuration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>();</span><br><span class="line">config.setInteger(ConfigOptions.key(<span class="string">&quot;rest.port&quot;</span>).intType().defaultValue(<span class="number">8081</span>), <span class="number">8081</span>);</span><br><span class="line"><span class="comment">//开启Queryable State服务</span></span><br><span class="line">config.setBoolean(QueryableStateOptions.ENABLE_QUERYABLE_STATE_PROXY_SERVER, <span class="literal">true</span>);</span><br><span class="line"><span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.createLocalEnvironmentWithWebUI(config);</span><br></pre></td></tr></table></figure>

<h4 id="在Flink中使状态可查询"><a href="#在Flink中使状态可查询" class="headerlink" title="在Flink中使状态可查询"></a>在Flink中使状态可查询</h4><p>有2种方式设置状态可查询。</p>
<p>1）QueryableStateStream</p>
<p>在将数据流转换为KeyedStream后调用asQueryableState()方法返回一个QueryableStateStream数据流。</p>
<p>需求：自定义数据源，接收用户每秒上报1个随机数。每隔10秒统计1次每个用户这10秒内上传的最大数值输出。并开启状态可查询，使用客户端每秒查一次指定用户的状态并输出。</p>
<p>自定义数据源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDataSource</span> <span class="keyword">implements</span> <span class="title class_">SourceFunction</span>&lt;Tuple2&lt;String, Integer&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isRunning</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * run方法里编写数据产生逻辑，假设有3个用户，他们每秒钟上传一个数字</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(SourceContext&lt;Tuple2&lt;String, Integer&gt;&gt; ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SecureRandom</span> <span class="variable">secureRandom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecureRandom</span>();</span><br><span class="line">        <span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i1</span> <span class="operator">=</span> secureRandom.nextInt(<span class="number">1000</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> secureRandom.nextInt(<span class="number">1000</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">i3</span> <span class="operator">=</span> secureRandom.nextInt(<span class="number">1000</span>);</span><br><span class="line">            Tuple2&lt;String, Integer&gt; hd = <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(<span class="string">&quot;恒大&quot;</span>, i1);</span><br><span class="line">            System.out.println(<span class="string">&quot;source time:&quot;</span> + LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>)) + <span class="string">&quot;,value:&quot;</span> + hd.toString());</span><br><span class="line"></span><br><span class="line">            Tuple2&lt;String, Integer&gt; le = <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(<span class="string">&quot;刘二&quot;</span>, i2);</span><br><span class="line">            System.out.println(<span class="string">&quot;source time:&quot;</span> + LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>)) + <span class="string">&quot;,value:&quot;</span> + le.toString());</span><br><span class="line"></span><br><span class="line">            Tuple2&lt;String, Integer&gt; zs = <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(<span class="string">&quot;张三&quot;</span>, i3);</span><br><span class="line">            System.out.println(<span class="string">&quot;source time:&quot;</span> + LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>)) + <span class="string">&quot;,value:&quot;</span> + zs.toString());</span><br><span class="line"></span><br><span class="line">            ctx.collect(hd);</span><br><span class="line">            ctx.collect(le);</span><br><span class="line">            ctx.collect(zs);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span> &#123;</span><br><span class="line">        isRunning = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>flink应用代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryableState</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>();</span><br><span class="line">        config.setInteger(ConfigOptions.key(<span class="string">&quot;rest.port&quot;</span>).intType().defaultValue(<span class="number">8081</span>), <span class="number">8081</span>);</span><br><span class="line">        <span class="comment">//开启Queryable State服务</span></span><br><span class="line">        config.setBoolean(QueryableStateOptions.ENABLE_QUERYABLE_STATE_PROXY_SERVER, <span class="literal">true</span>);</span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.createLocalEnvironmentWithWebUI(config);</span><br><span class="line">        DataStreamSource&lt;Tuple2&lt;String, Integer&gt;&gt; dataStreamSource = env.addSource(<span class="keyword">new</span> <span class="title class_">MyDataSource</span>());</span><br><span class="line">        SingleOutputStreamOperator&lt;Tuple2&lt;String, Integer&gt;&gt; result = dataStreamSource.keyBy(<span class="keyword">new</span> <span class="title class_">KeySelector</span>&lt;Tuple2&lt;String, Integer&gt;, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getKey</span><span class="params">(Tuple2&lt;String, Integer&gt; value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="keyword">return</span> value.f0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).timeWindow(Time.seconds(<span class="number">10</span>))</span><br><span class="line">                .apply(<span class="keyword">new</span> <span class="title class_">WindowFunction</span>&lt;Tuple2&lt;String, Integer&gt;, Tuple2&lt;String, Integer&gt;, String, TimeWindow&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(String o, TimeWindow window, Iterable&lt;Tuple2&lt;String, Integer&gt;&gt; input, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        List&lt;Tuple2&lt;String, Integer&gt;&gt; items = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                        Iterator&lt;Tuple2&lt;String, Integer&gt;&gt; iterator = input.iterator();</span><br><span class="line">                        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                            items.add(iterator.next());</span><br><span class="line">                        &#125;</span><br><span class="line">                        Collections.sort(items, Comparator.comparing(e -&gt; e.f1));</span><br><span class="line">                        Tuple2&lt;String, Integer&gt; max = items.get(items.size() - <span class="number">1</span>);</span><br><span class="line">                        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line">                        System.out.println((<span class="string">&quot;window[&quot;</span> + sdf.format(window.getStart()) + <span class="string">&quot;,&quot;</span> + sdf.format(window.getEnd()) + <span class="string">&quot;],max：&quot;</span> + max));</span><br><span class="line">                        out.collect(max);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        result.print();</span><br><span class="line"></span><br><span class="line">        result.keyBy(<span class="keyword">new</span> <span class="title class_">KeySelector</span>&lt;Tuple2&lt;String, Integer&gt;, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getKey</span><span class="params">(Tuple2&lt;String, Integer&gt; value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="keyword">return</span> value.f0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).asQueryableState(<span class="string">&quot;MaxValueIn10s&quot;</span>);<span class="comment">//asQueryableState使得结果的状态可查</span></span><br><span class="line">        env.execute(<span class="string">&quot;queryableState demo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryClient1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//jobID是运行上述flink作业时控制台输出的</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jobID</span> <span class="operator">=</span> <span class="string">&quot;db6ba9ca3bcd15cf7f06da4122ea975d&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">JobID</span> <span class="variable">jobId</span> <span class="operator">=</span> JobID.fromHexString(jobID);</span><br><span class="line">        System.out.println(<span class="string">&quot;jobId:&quot;</span> + jobId);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">jobManagerHost</span> <span class="operator">=</span> <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">jobManagerPort</span> <span class="operator">=</span> <span class="number">9069</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">QueryableStateClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryableStateClient</span>(jobManagerHost, jobManagerPort);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用状态描述符来描述我们要查询的状态</span></span><br><span class="line">        ValueStateDescriptor&lt;Tuple2&lt;String, Integer&gt;&gt; stateDescriptor = <span class="keyword">new</span> <span class="title class_">ValueStateDescriptor</span>&lt;Tuple2&lt;String, Integer&gt;&gt;(<span class="string">&quot;maxvalue&quot;</span>, TypeInformation.of(<span class="keyword">new</span> <span class="title class_">TypeHint</span>&lt;Tuple2&lt;String, Integer&gt;&gt;() &#123;</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询指定用户的状态，key对应keyBy的元素类型</span></span><br><span class="line">        <span class="comment">//比如这里每隔1秒查询Flink中恒大这个用户的状态</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;恒大&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            CompletableFuture&lt;ValueState&lt;Tuple2&lt;String, Integer&gt;&gt;&gt; completableFuture =</span><br><span class="line">                    client.getKvState(</span><br><span class="line">                            jobId,</span><br><span class="line">                            <span class="string">&quot;MaxValueIn10s&quot;</span>,</span><br><span class="line">                            key,</span><br><span class="line">                            BasicTypeInfo.STRING_TYPE_INFO,</span><br><span class="line">                            stateDescriptor);</span><br><span class="line">            System.out.println(completableFuture.get().value());</span><br><span class="line">            <span class="comment">//每隔1秒查询一次</span></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）StateDescriptor</p>
<p>通过ValueStateDescriptor.setQueryable()方法开放此状态，使此状态可查询。还是以上面的需求举例。</p>
<p>改动点在于不使用KeyedStream的asQueryableState()方法，而是在状态描述符上直接设置状态可查询。</p>
<p>flink应用代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryableState2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>();</span><br><span class="line">        config.setInteger(ConfigOptions.key(<span class="string">&quot;rest.port&quot;</span>).intType().defaultValue(<span class="number">8081</span>), <span class="number">8081</span>);</span><br><span class="line">        <span class="comment">//开启Queryable State服务</span></span><br><span class="line">        config.setBoolean(QueryableStateOptions.ENABLE_QUERYABLE_STATE_PROXY_SERVER, <span class="literal">true</span>);</span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.createLocalEnvironmentWithWebUI(config);</span><br><span class="line">        DataStreamSource&lt;Tuple2&lt;String, Integer&gt;&gt; dataStreamSource = env.addSource(<span class="keyword">new</span> <span class="title class_">MyDataSource</span>());</span><br><span class="line">        SingleOutputStreamOperator&lt;Tuple2&lt;String, Integer&gt;&gt; result = dataStreamSource.keyBy(<span class="keyword">new</span> <span class="title class_">KeySelector</span>&lt;Tuple2&lt;String, Integer&gt;, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getKey</span><span class="params">(Tuple2&lt;String, Integer&gt; value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="keyword">return</span> value.f0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).timeWindow(Time.seconds(<span class="number">10</span>))</span><br><span class="line">                .apply(<span class="keyword">new</span> <span class="title class_">RichWindowFunction</span>&lt;Tuple2&lt;String, Integer&gt;, Tuple2&lt;String, Integer&gt;, String, TimeWindow&gt;() &#123;</span><br><span class="line">                    <span class="comment">// 定义一个ValueState，来存放状态</span></span><br><span class="line">                    <span class="keyword">private</span> <span class="keyword">transient</span> ValueState&lt;Tuple2&lt;String, Integer&gt;&gt; maxValueState;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="comment">//用状态描述符来描述我们要查询的状态</span></span><br><span class="line">                        ValueStateDescriptor&lt;Tuple2&lt;String, Integer&gt;&gt; stateDescriptor = <span class="keyword">new</span> <span class="title class_">ValueStateDescriptor</span>&lt;Tuple2&lt;String, Integer&gt;&gt;(<span class="string">&quot;maxvalue&quot;</span>, TypeInformation.of(<span class="keyword">new</span> <span class="title class_">TypeHint</span>&lt;Tuple2&lt;String, Integer&gt;&gt;() &#123;</span><br><span class="line">                        &#125;));</span><br><span class="line">                        <span class="comment">//在状态描述符上直接设置状态可查询</span></span><br><span class="line">                        stateDescriptor.setQueryable(<span class="string">&quot;MaxValueIn10s&quot;</span>);</span><br><span class="line">                        maxValueState = getRuntimeContext().getState(stateDescriptor);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(String o, TimeWindow window, Iterable&lt;Tuple2&lt;String, Integer&gt;&gt; input, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        List&lt;Tuple2&lt;String, Integer&gt;&gt; items = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                        Iterator&lt;Tuple2&lt;String, Integer&gt;&gt; iterator = input.iterator();</span><br><span class="line">                        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                            items.add(iterator.next());</span><br><span class="line">                        &#125;</span><br><span class="line">                        Collections.sort(items, Comparator.comparing(e -&gt; e.f1));</span><br><span class="line">                        Tuple2&lt;String, Integer&gt; max = items.get(items.size() - <span class="number">1</span>);</span><br><span class="line">                        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line">                        System.out.println((<span class="string">&quot;window[&quot;</span> + sdf.format(window.getStart()) + <span class="string">&quot;,&quot;</span> + sdf.format(window.getEnd()) + <span class="string">&quot;],max：&quot;</span> + max));</span><br><span class="line">                        <span class="comment">//更新状态值</span></span><br><span class="line">                        maxValueState.update(max);</span><br><span class="line">                        out.collect(max);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;);</span><br><span class="line">        result.print();</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">&quot;queryableState demo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端代码没有变化，只要改变jobId的值，依然能够查询到指定用户的实时state值。</p>
<h2 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h2><h3 id="网页UV统计"><a href="#网页UV统计" class="headerlink" title="网页UV统计"></a>网页UV统计</h3><p>web应用中将用户对每个页面的请求日志发送到Kafka中，Flink从Kafka中消费日志数据，并解析日志、统计每个页面当日独立用户访问量(UV)，最后将统计结果输出到redis中供其它服务查询。</p>
<h4 id="日志数据实体类"><a href="#日志数据实体类" class="headerlink" title="日志数据实体类"></a>日志数据实体类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserVisitEvent</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String traceId;<span class="comment">//日志id</span></span><br><span class="line">    <span class="keyword">public</span> String date;<span class="comment">//日志日期，如：20201221</span></span><br><span class="line">    <span class="keyword">public</span> Integer pageId;<span class="comment">//web页面id</span></span><br><span class="line">    <span class="keyword">public</span> String uid;<span class="comment">//用户id</span></span><br><span class="line">    <span class="keyword">public</span> String url;<span class="comment">//页面url</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Flink应用程序"><a href="#Flink应用程序" class="headerlink" title="Flink应用程序"></a>Flink应用程序</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UVdemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        <span class="comment">//kafka配置参数</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">&quot;192.168.174.129:9092&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;web-uv-stat&quot;</span>);</span><br><span class="line">        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, <span class="string">&quot;latest&quot;</span>);</span><br><span class="line">        FlinkKafkaConsumer011&lt;String&gt; kafkaConsumer011 = <span class="keyword">new</span> <span class="title class_">FlinkKafkaConsumer011</span>&lt;&gt;(</span><br><span class="line">                <span class="string">&quot;uv_statistics&quot;</span>,  <span class="comment">//kafka topic</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">SimpleStringSchema</span>(),  <span class="comment">// String 序列化</span></span><br><span class="line">                props);</span><br><span class="line"></span><br><span class="line">        <span class="type">FlinkJedisPoolConfig</span> <span class="variable">redisConf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FlinkJedisPoolConfig</span></span><br><span class="line">                .Builder().setHost(<span class="string">&quot;127.0.0.1&quot;</span>).setPort(<span class="number">6379</span>).build();</span><br><span class="line"></span><br><span class="line">        env.addSource(kafkaConsumer011)</span><br><span class="line">                .setParallelism(<span class="number">2</span>)</span><br><span class="line">                .map(str -&gt; &#123;</span><br><span class="line">                    <span class="comment">//解析日志时间戳，转换为日期</span></span><br><span class="line">                    Map&lt;String, String&gt; o = JSON.parseObject(str, Map.class);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">timestamp</span> <span class="operator">=</span> o.get(<span class="string">&quot;timestamp&quot;</span>);</span><br><span class="line">                    <span class="type">Instant</span> <span class="variable">instant</span> <span class="operator">=</span> Instant.ofEpochMilli(Long.parseLong(timestamp));</span><br><span class="line">                    <span class="type">LocalDateTime</span> <span class="variable">localDateTime</span> <span class="operator">=</span> LocalDateTime.ofInstant(instant, ZoneId.systemDefault());</span><br><span class="line">                    <span class="type">UserVisitEvent</span> <span class="variable">userVisitEvent</span> <span class="operator">=</span> JSON.parseObject(str, UserVisitEvent.class);</span><br><span class="line">                    userVisitEvent.date = localDateTime.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyyMMdd&quot;</span>));</span><br><span class="line">                    <span class="keyword">return</span> userVisitEvent;</span><br><span class="line">                &#125;)</span><br><span class="line">                .keyBy(<span class="string">&quot;date&quot;</span>, <span class="string">&quot;pageId&quot;</span>)<span class="comment">//按照日期和页面id分组，每个页面用独立的KeyedState来存储数据</span></span><br><span class="line">                .map(<span class="keyword">new</span> <span class="title class_">RichMapFunction</span>&lt;UserVisitEvent, Tuple2&lt;String, Long&gt;&gt;() &#123;</span><br><span class="line">                    <span class="comment">// 存储userId集合，使用MapState存储key即可，value不使用</span></span><br><span class="line">                    <span class="keyword">private</span> MapState&lt;String, String&gt; userIdSet;</span><br><span class="line">                    <span class="comment">// MapState没有统计元素个数的方法，所以需要一个存储UV值的状态</span></span><br><span class="line">                    <span class="keyword">private</span> ValueState&lt;Long&gt; uvCount;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="built_in">super</span>.open(parameters);</span><br><span class="line">                        <span class="comment">// 从状态中恢复userIdSet状态</span></span><br><span class="line">                        userIdSet = getRuntimeContext().getMapState(</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">MapStateDescriptor</span>&lt;&gt;(<span class="string">&quot;userIdSet&quot;</span>,</span><br><span class="line">                                        TypeInformation.of(<span class="keyword">new</span> <span class="title class_">TypeHint</span>&lt;String&gt;() &#123;</span><br><span class="line">                                        &#125;),</span><br><span class="line">                                        TypeInformation.of(<span class="keyword">new</span> <span class="title class_">TypeHint</span>&lt;String&gt;() &#123;</span><br><span class="line">                                        &#125;)));</span><br><span class="line">                        <span class="comment">// 从状态中恢复uvCount状态</span></span><br><span class="line">                        uvCount = getRuntimeContext().getState(<span class="keyword">new</span> <span class="title class_">ValueStateDescriptor</span>&lt;&gt;(<span class="string">&quot;uvCount&quot;</span>, TypeInformation.of(<span class="keyword">new</span> <span class="title class_">TypeHint</span>&lt;Long&gt;() &#123;</span><br><span class="line">                        &#125;)));</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Tuple2&lt;String, Long&gt; <span class="title function_">map</span><span class="params">(UserVisitEvent userVisitEvent)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="comment">// 设置uvCount初始值</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="literal">null</span> == uvCount.value()) &#123;</span><br><span class="line">                            uvCount.update(<span class="number">0L</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (!userIdSet.contains(userVisitEvent.uid)) &#123;</span><br><span class="line">                            userIdSet.put(userVisitEvent.uid, <span class="literal">null</span>);</span><br><span class="line">                            <span class="comment">//用户首次访问才更新uvCount计数</span></span><br><span class="line">                            uvCount.update(uvCount.value() + <span class="number">1</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 生成写入redis的数据，格式:key=date_pageId,value=count值</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> userVisitEvent.date + <span class="string">&quot;_&quot;</span></span><br><span class="line">                                + userVisitEvent.pageId;</span><br><span class="line">                        System.out.println(redisKey + <span class="string">&quot;:&quot;</span> + uvCount.value());</span><br><span class="line">                        <span class="keyword">return</span> Tuple2.of(redisKey, uvCount.value());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .addSink(<span class="keyword">new</span> <span class="title class_">RedisSink</span>&lt;&gt;(redisConf, <span class="keyword">new</span> <span class="title class_">RedisSinkMapper</span>()));</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">&quot;UV Statistics&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RedisSinkMapper</span> <span class="keyword">implements</span> <span class="title class_">RedisMapper</span>&lt;Tuple2&lt;String, Long&gt;&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> RedisCommandDescription <span class="title function_">getCommandDescription</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisCommandDescription</span>(RedisCommand.SET);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getKeyFromData</span><span class="params">(Tuple2&lt;String, Long&gt; data)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> data.f0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getValueFromData</span><span class="params">(Tuple2&lt;String, Long&gt; data)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> data.f1.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建topic"><a href="#创建topic" class="headerlink" title="创建topic"></a>创建topic</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@vm1 ~]# kafka-topics.sh --create --zookeeper 192.168.174.136:2181 --replication-factor 2 -partitions 2 --topic uv_statistics</span><br></pre></td></tr></table></figure>

<p>运行Flink应用，使用kafka生产者脚本向topic发送数据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kafka-console-producer.sh --topic uv_statistics --bootstrap-server 192.168.174.136:9092</span><br><span class="line">&gt;&#123;&quot;timestamp&quot;:&quot;1607695647643&quot;,&quot;pageId&quot;:1001,&quot;traceId&quot;:&quot;tid-11&quot;,&quot;uid&quot;:&quot;U0001&quot;,&quot;url&quot;:&quot;/user/login&quot;&#125;</span><br><span class="line">&gt;&#123;&quot;timestamp&quot;:&quot;1607695647643&quot;,&quot;pageId&quot;:1001,&quot;traceId&quot;:&quot;tid-11&quot;,&quot;uid&quot;:&quot;U0001&quot;,&quot;url&quot;:&quot;/user/login&quot;&#125;</span><br><span class="line">&gt;&#123;&quot;timestamp&quot;:&quot;1607695647643&quot;,&quot;pageId&quot;:1001,&quot;traceId&quot;:&quot;tid-11&quot;,&quot;uid&quot;:&quot;U0002&quot;,&quot;url&quot;:&quot;/user/login&quot;&#125;</span><br><span class="line">&gt;&#123;&quot;timestamp&quot;:&quot;1607695647643&quot;,&quot;pageId&quot;:1001,&quot;traceId&quot;:&quot;tid-11&quot;,&quot;uid&quot;:&quot;U0001&quot;,&quot;url&quot;:&quot;/user/login&quot;&#125;</span><br><span class="line">&gt;&#123;&quot;timestamp&quot;:&quot;1607695647643&quot;,&quot;pageId&quot;:1001,&quot;traceId&quot;:&quot;tid-11&quot;,&quot;uid&quot;:&quot;U0002&quot;,&quot;url&quot;:&quot;/user/login&quot;&#125;</span><br><span class="line">&gt;&#123;&quot;timestamp&quot;:&quot;1607695647643&quot;,&quot;pageId&quot;:1001,&quot;traceId&quot;:&quot;tid-11&quot;,&quot;uid&quot;:&quot;U0002&quot;,&quot;url&quot;:&quot;/user/login&quot;&#125;</span><br><span class="line">&gt;&#123;&quot;timestamp&quot;:&quot;1607695647643&quot;,&quot;pageId&quot;:1001,&quot;traceId&quot;:&quot;tid-11&quot;,&quot;uid&quot;:&quot;U0003&quot;,&quot;url&quot;:&quot;/user/login&quot;&#125;          </span><br><span class="line">&gt;&#123;&quot;timestamp&quot;:&quot;1607695647643&quot;,&quot;pageId&quot;:1002,&quot;traceId&quot;:&quot;tid-11&quot;,&quot;uid&quot;:&quot;U0003&quot;,&quot;url&quot;:&quot;/user/login&quot;&#125; </span><br><span class="line">&gt;&#123;&quot;timestamp&quot;:&quot;1607695647643&quot;,&quot;pageId&quot;:1002,&quot;traceId&quot;:&quot;tid-11&quot;,&quot;uid&quot;:&quot;U0003&quot;,&quot;url&quot;:&quot;/user/login&quot;&#125;</span><br><span class="line">&gt;&#123;&quot;timestamp&quot;:&quot;1607695647643&quot;,&quot;pageId&quot;:1002,&quot;traceId&quot;:&quot;tid-11&quot;,&quot;uid&quot;:&quot;U1442&quot;,&quot;url&quot;:&quot;/user/login&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到flink应用程序输出正常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20201211_1001</span>:<span class="number">1</span></span><br><span class="line"><span class="number">20201211_1001</span>:<span class="number">2</span></span><br><span class="line"><span class="number">20201211_1001</span>:<span class="number">2</span></span><br><span class="line"><span class="number">20201211_1001</span>:<span class="number">3</span></span><br><span class="line"><span class="number">20201211_1002</span>:<span class="number">1</span></span><br><span class="line"><span class="number">20201211_1002</span>:<span class="number">1</span></span><br><span class="line"><span class="number">20201211_1002</span>:<span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>同时redis里面也能查询到最新的统计数据。打开redis客户端，执行下列命令获取key的值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get 20201211_1002</span><br><span class="line">&quot;2&quot;</span><br><span class="line">127.0.0.1:6379&gt; get 20201211_1001</span><br><span class="line">&quot;3&quot;</span><br></pre></td></tr></table></figure>

<h4 id="上传jar到flink集群中运行"><a href="#上传jar到flink集群中运行" class="headerlink" title="上传jar到flink集群中运行"></a>上传jar到flink集群中运行</h4><p>上述程序是在本地运行的，也可以提交到Flink集群中运行。Flink应用程序打包方式以及如何提交到flink集群参见<a target="_blank" rel="noopener" href="https://blog.csdn.net/hellozpc/article/details/109413465">第一篇</a>的快速入门案例。提交之前确保kafka和redis都已经启动，且能正常连接。<br><img src="/../images/%E5%A4%A7%E6%95%B0%E6%8D%AEFlink%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B(%E7%BB%88%E7%AF%87)/20210115214543415.png" alt="在这里插入图片描述"></p>
<p>由此可见，在集群多并行度环境下，依然正常输出正确的结果！</p>
<h4 id="远程提交Flink应用"><a href="#远程提交Flink应用" class="headerlink" title="远程提交Flink应用"></a>远程提交Flink应用</h4><p>只要像下面这样修改运行环境，运行主函数所在的类即可远程提交flink任务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.createRemoteEnvironment(<span class="string">&quot;192.168.174.136&quot;</span>, <span class="number">8081</span>, <span class="string">&quot;F:\\flink\\flink_job_uv\\target\\flink_job_uv-0.0.1-SNAPSHOT-jar-with-dependencies.jar&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>提交到flink集群中运行后，本地idea关闭flink应用程序不会影响已经提交到flink集群中的job。即已提交到集群中运行的job不会被终止。注意，提交job时要把flink应用程序中用到的其它类所在的jar包带上。即flink应用程序所依赖的类库要打包成jar包传入，否则会报各种类找不到的异常：<code>ClassNotFoundException</code>。</p>
<p>在实际生产中，可以先将flink应用程序工程打成jar。通过springboot应用在程序启动时提交flink任务。springboot应用程序也打成jar，这样就可以通过运行springboot应用启动flink计算任务。</p>
<h4 id="springboot启动flink任务"><a href="#springboot启动flink任务" class="headerlink" title="springboot启动flink任务"></a>springboot启动flink任务</h4><h5 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 排除自带的logback依赖 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--            &lt;scope&gt;provided&lt;/scope&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-streaming-java_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--            &lt;scope&gt;provided&lt;/scope&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-clients_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-kafka_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.bahir<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-redis_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.73<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 编译插件 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- scala编译插件,用于将scala代码编译成class文件 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.alchim31.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>scala-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">scalaCompatVersion</span>&gt;</span>2.11<span class="tag">&lt;/<span class="name">scalaCompatVersion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">scalaVersion</span>&gt;</span>2.11.12<span class="tag">&lt;/<span class="name">scalaVersion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>compile-scala<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>add-source<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>test-compile-scala<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>test-compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>add-source<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>testCompile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 打jar包插件(会包含所有依赖) --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!-- 可以设置jar包的入口类(可选) --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.bigbird.flink_job_uv.FlinkJobUvApplication<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- Springboot打包插件 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;plugin&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                &lt;version&gt;2.2.6.RELEASE&lt;/version&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;/plugin&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="SpringBoot入口类"><a href="#SpringBoot入口类" class="headerlink" title="SpringBoot入口类"></a>SpringBoot入口类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlinkJobUvApplication</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ContextRefreshedEvent&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(FlinkJobUvApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ContextRefreshedEvent contextRefreshedEvent)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;submit flink job...&quot;</span>);</span><br><span class="line">            UVdemo.submitJob();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Flink应用程序-1"><a href="#Flink应用程序-1" class="headerlink" title="Flink应用程序"></a>Flink应用程序</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UVdemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">submitJob</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span></span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.createRemoteEnvironment(<span class="string">&quot;192.168.174.136&quot;</span>, <span class="number">8081</span>, <span class="string">&quot;F:\\flink\\flink_job_uv\\flink_job_uv-0.0.1-SNAPSHOT-jar-with-dependencies.jar&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//kafka配置参数</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">&quot;192.168.174.136:9092&quot;</span>);</span><br><span class="line">        props.put(ConsumerConfig.GROUP_ID_CONFIG, <span class="string">&quot;web-uv-stat&quot;</span>);</span><br><span class="line">        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, <span class="string">&quot;latest&quot;</span>);</span><br><span class="line">        FlinkKafkaConsumer&lt;String&gt; kafkaConsumer011 = <span class="keyword">new</span> <span class="title class_">FlinkKafkaConsumer</span>&lt;&gt;(</span><br><span class="line">                <span class="string">&quot;uv_statistics&quot;</span>,  <span class="comment">//kafka topic</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">SimpleStringSchema</span>(),  <span class="comment">// String 序列化</span></span><br><span class="line">                props);</span><br><span class="line"></span><br><span class="line">        <span class="type">FlinkJedisPoolConfig</span> <span class="variable">redisConf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FlinkJedisPoolConfig</span></span><br><span class="line">                .Builder().setHost(<span class="string">&quot;192.168.174.1&quot;</span>).setPort(<span class="number">6379</span>).build();</span><br><span class="line"></span><br><span class="line">        env.addSource(kafkaConsumer011)</span><br><span class="line">                .map(<span class="keyword">new</span> <span class="title class_">MapFunction</span>&lt;String, UserVisitEvent&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> UserVisitEvent <span class="title function_">map</span><span class="params">(String str)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="comment">//解析日志时间戳，转换为日期</span></span><br><span class="line">                        Map&lt;String, String&gt; o = JSON.parseObject(str, Map.class);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">timestamp</span> <span class="operator">=</span> o.get(<span class="string">&quot;timestamp&quot;</span>);</span><br><span class="line">                        <span class="type">UserVisitEvent</span> <span class="variable">userVisitEvent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserVisitEvent</span>();</span><br><span class="line">                        <span class="keyword">if</span> (timestamp != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="type">Instant</span> <span class="variable">instant</span> <span class="operator">=</span> Instant.ofEpochMilli(Long.parseLong(timestamp));</span><br><span class="line">                            <span class="type">LocalDateTime</span> <span class="variable">localDateTime</span> <span class="operator">=</span> LocalDateTime.ofInstant(instant, ZoneId.systemDefault());</span><br><span class="line">                            userVisitEvent = JSON.parseObject(str, UserVisitEvent.class);</span><br><span class="line">                            userVisitEvent.date = localDateTime.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyyMMdd&quot;</span>));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            System.out.println(<span class="string">&quot;timestamp不能为空&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> userVisitEvent;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .keyBy(<span class="string">&quot;date&quot;</span>, <span class="string">&quot;pageId&quot;</span>)<span class="comment">//按照日期和页面id分组，每个页面用独立的KeyedState来存储数据</span></span><br><span class="line">                .map(<span class="keyword">new</span> <span class="title class_">RichMapFunction</span>&lt;UserVisitEvent, Tuple2&lt;String, Long&gt;&gt;() &#123;</span><br><span class="line">                    <span class="comment">// 存储userId集合，使用MapState存储key即可，value不使用</span></span><br><span class="line">                    <span class="keyword">private</span> MapState&lt;String, String&gt; userIdSet;</span><br><span class="line">                    <span class="comment">// MapState没有统计元素个数的方法，所以需要一个存储UV值的状态</span></span><br><span class="line">                    <span class="keyword">private</span> ValueState&lt;Long&gt; uvCount;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="built_in">super</span>.open(parameters);</span><br><span class="line">                        <span class="comment">// 从状态中恢复userIdSet状态</span></span><br><span class="line">                        userIdSet = getRuntimeContext().getMapState(</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">MapStateDescriptor</span>&lt;&gt;(<span class="string">&quot;userIdSet&quot;</span>,</span><br><span class="line">                                        TypeInformation.of(<span class="keyword">new</span> <span class="title class_">TypeHint</span>&lt;String&gt;() &#123;</span><br><span class="line">                                        &#125;),</span><br><span class="line">                                        TypeInformation.of(<span class="keyword">new</span> <span class="title class_">TypeHint</span>&lt;String&gt;() &#123;</span><br><span class="line">                                        &#125;)));</span><br><span class="line">                        <span class="comment">// 从状态中恢复uvCount状态</span></span><br><span class="line">                        uvCount = getRuntimeContext().getState(<span class="keyword">new</span> <span class="title class_">ValueStateDescriptor</span>&lt;&gt;(<span class="string">&quot;uvCount&quot;</span>, TypeInformation.of(<span class="keyword">new</span> <span class="title class_">TypeHint</span>&lt;Long&gt;() &#123;</span><br><span class="line">                        &#125;)));</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Tuple2&lt;String, Long&gt; <span class="title function_">map</span><span class="params">(UserVisitEvent userVisitEvent)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="comment">// 设置uvCount初始值</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="literal">null</span> == uvCount.value()) &#123;</span><br><span class="line">                            uvCount.update(<span class="number">0L</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (!userIdSet.contains(userVisitEvent.uid)) &#123;</span><br><span class="line">                            userIdSet.put(userVisitEvent.uid, <span class="literal">null</span>);</span><br><span class="line">                            <span class="comment">//用户首次访问才更新uvCount计数</span></span><br><span class="line">                            uvCount.update(uvCount.value() + <span class="number">1</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 生成写入redis的数据，格式:key=date_pageId,value=count值</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> userVisitEvent.date + <span class="string">&quot;_&quot;</span></span><br><span class="line">                                + userVisitEvent.pageId;</span><br><span class="line">                        System.out.println(redisKey + <span class="string">&quot;:&quot;</span> + uvCount.value());</span><br><span class="line">                        <span class="keyword">return</span> Tuple2.of(redisKey, uvCount.value());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .addSink(<span class="keyword">new</span> <span class="title class_">RedisSink</span>&lt;&gt;(redisConf, <span class="keyword">new</span> <span class="title class_">RedisSinkMapper</span>()));</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">&quot;UV Statistics_demo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RedisSinkMapper</span> <span class="keyword">implements</span> <span class="title class_">RedisMapper</span>&lt;Tuple2&lt;String, Long&gt;&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> RedisCommandDescription <span class="title function_">getCommandDescription</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisCommandDescription</span>(RedisCommand.SET);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getKeyFromData</span><span class="params">(Tuple2&lt;String, Long&gt; data)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> data.f0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getValueFromData</span><span class="params">(Tuple2&lt;String, Long&gt; data)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> data.f1.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，flink应用程序中传入的jar路径是Flink应用程序所有的依赖库打成的jar包。因此是先将flink应用程序及其依赖库打jar包，存放到指定位置。再将SpringBoot工程打成jar包。因此pom文件中有两种打包插件，分别用于打包flink应用程序和Springboot。</p>
<p>打包命令：mvn package -DskipTests</p>
<p>运行SpringBoo应用即可提交flink任务到集群中运行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar flink_job_uv-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure>

<p>取消任务可以在Flink web页面(笔者的flink集群web地址是<a target="_blank" rel="noopener" href="http://vm1:8081/">http://vm1:8081/</a> )或者linux命令行操作。</p>
<p>SpringBoot直接停止、取消flink任务的实现方式欢迎留言！</p>
<h3 id="头条实时热榜统计"><a href="#头条实时热榜统计" class="headerlink" title="头条实时热榜统计"></a>头条实时热榜统计</h3><p>需求描述：每5分钟统计一次1小时内南京地区的热点新闻，输出topN条热门新闻。新闻点击阅读数据来自kafka消息队列(由业务系统或者ETL系统写入处理过的数据到kafka中)。</p>
<p>输入数据实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 新闻数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NewsInfo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String newsId;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> categoryId;</span><br><span class="line">    <span class="keyword">public</span> String city;</span><br><span class="line">    <span class="keyword">public</span> String content;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> timestamp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>计数数据实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 某个窗口内特定新闻的计数值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NewsWindowCount</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String newsId;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> windowEnd;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Flink应用程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 热榜统计：每5分钟统计1次1小时内南京地区的热点新闻，输出头条新闻</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotListStatistics</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//简单起见，数据也可从文本文件中读取;并从数据中提取时间戳生成水位线</span></span><br><span class="line">        <span class="comment">//DataStreamSource&lt;String&gt; inputStreamSource = env.readTextFile(&quot;D:\\news.txt&quot;);</span></span><br><span class="line">        <span class="comment">//从kafka接收输入数据</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        props.put(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;192.168.244.128:9092&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;news-group&quot;</span>);<span class="comment">//指定消费者组</span></span><br><span class="line">        props.put(<span class="string">&quot;key.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);  <span class="comment">//key 反序列化</span></span><br><span class="line">        props.put(<span class="string">&quot;value.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;auto.offset.reset&quot;</span>, <span class="string">&quot;latest&quot;</span>); <span class="comment">//value 反序列化</span></span><br><span class="line"></span><br><span class="line">        DataStreamSource&lt;String&gt; inputStreamSource = env.addSource(<span class="keyword">new</span> <span class="title class_">FlinkKafkaConsumer</span>&lt;&gt;(<span class="string">&quot;topic_hotlist&quot;</span>, <span class="keyword">new</span> <span class="title class_">SimpleStringSchema</span>(), props));</span><br><span class="line"></span><br><span class="line">        DataStream&lt;NewsInfo&gt; dataStream = inputStreamSource.map(line -&gt; &#123;</span><br><span class="line">            String[] split = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="type">NewsInfo</span> <span class="variable">newsInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NewsInfo</span>();</span><br><span class="line">            newsInfo.newsId = split[<span class="number">0</span>];</span><br><span class="line">            newsInfo.categoryId = Integer.parseInt(split[<span class="number">1</span>]);</span><br><span class="line">            newsInfo.city = split[<span class="number">2</span>];</span><br><span class="line">            newsInfo.content = split[<span class="number">3</span>];</span><br><span class="line">            newsInfo.timestamp = Long.parseLong(split[<span class="number">4</span>]);</span><br><span class="line">            <span class="keyword">return</span> newsInfo;</span><br><span class="line">        &#125;)</span><br><span class="line">                <span class="comment">//由于输入数据是单调递增的时间戳,可以直接使用Flink提供的水位线生成器MonotonousTimestamps,也可以使用固定延迟的水位线</span></span><br><span class="line">                .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;NewsInfo&gt;forMonotonousTimestamps()</span><br><span class="line">                        .withTimestampAssigner((element, recordTimestamp) -&gt; element.timestamp));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//过滤南京地区的热榜;分组开窗聚合,得到每个窗口内各个新闻的count值</span></span><br><span class="line">        DataStream&lt;NewsWindowCount&gt; aggregateStream = dataStream.filter(e -&gt; e.city.equals(<span class="string">&quot;南京&quot;</span>))</span><br><span class="line">                .keyBy(e -&gt; e.newsId)<span class="comment">//按照新闻id分组</span></span><br><span class="line">                .timeWindow(Time.hours(<span class="number">1</span>), Time.minutes(<span class="number">5</span>))<span class="comment">//一小时的窗口，每隔5分滑动一次</span></span><br><span class="line">                .aggregate(<span class="keyword">new</span> <span class="title class_">CountAggregation</span>(), <span class="keyword">new</span> <span class="title class_">ItemWindowCountFunction</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将同一窗口内的新闻按计数值排序，统计topN热点新闻(使用状态编程、定时器)</span></span><br><span class="line">        DataStream&lt;String&gt; processRes = aggregateStream</span><br><span class="line">                .keyBy(<span class="string">&quot;windowEnd&quot;</span>)</span><br><span class="line">                .process(<span class="keyword">new</span> <span class="title class_">TopNHotListFunction</span>(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">        processRes.print();</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">&quot;hot list&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义增量聚合函数，完成每个新闻热点的计数累加功能</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CountAggregation</span> <span class="keyword">implements</span> <span class="title class_">AggregateFunction</span>&lt;NewsInfo, Long, Long&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Long <span class="title function_">createAccumulator</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">//初始值为0</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Long <span class="title function_">add</span><span class="params">(NewsInfo value, Long accumulator)</span> &#123;</span><br><span class="line">            <span class="comment">//每来一次相同的新闻点击数据，计数加一</span></span><br><span class="line">            <span class="keyword">return</span> accumulator + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Long <span class="title function_">getResult</span><span class="params">(Long accumulator)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> accumulator;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Long <span class="title function_">merge</span><span class="params">(Long a, Long b)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> a + b;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义全量窗口聚合函数，输出封装好的ItemWindowCount</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ItemWindowCountFunction</span> <span class="keyword">implements</span> <span class="title class_">WindowFunction</span>&lt;Long, NewsWindowCount, String, TimeWindow&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(String key, TimeWindow window, Iterable&lt;Long&gt; input, Collector&lt;NewsWindowCount&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            Iterator&lt;Long&gt; iterator = input.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                iterator.next();</span><br><span class="line">                size++;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;size is:&quot;</span> + size);</span><br><span class="line"></span><br><span class="line">            <span class="type">NewsWindowCount</span> <span class="variable">newsWindowCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NewsWindowCount</span>();</span><br><span class="line">            <span class="comment">//这里input迭代器里只有一个元素</span></span><br><span class="line">            newsWindowCount.count = input.iterator().next();</span><br><span class="line">            newsWindowCount.newsId = key;</span><br><span class="line">            newsWindowCount.windowEnd = window.getEnd();</span><br><span class="line">            out.collect(newsWindowCount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TopNHotListFunction</span> <span class="keyword">extends</span> <span class="title class_">KeyedProcessFunction</span>&lt;Tuple, NewsWindowCount, String&gt; &#123;</span><br><span class="line">        <span class="comment">//输出topN的结果数据</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> topN;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//先定义状态变量，在生命周期方法里获取</span></span><br><span class="line">        <span class="keyword">private</span> ListState&lt;NewsWindowCount&gt; newsWindowCountListState = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">TopNHotListFunction</span><span class="params">(<span class="type">int</span> topN)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.topN = topN;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            newsWindowCountListState = getRuntimeContext().getListState(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ListStateDescriptor</span>&lt;&gt;(<span class="string">&quot;newsCountListState&quot;</span>, NewsWindowCount.class));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(NewsWindowCount value, Context ctx, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="comment">//每来一个数据直接加入状态ListState中</span></span><br><span class="line">            newsWindowCountListState.add(value);</span><br><span class="line">            <span class="comment">//注册一个windowEnd+1毫秒触发的定时器</span></span><br><span class="line">            ctx.timerService().registerEventTimeTimer(value.windowEnd + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 当所有所有的窗口统计结果都到达，触发定时器，输出排序</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> timestamp</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> out</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTimer</span><span class="params">(<span class="type">long</span> timestamp, OnTimerContext ctx, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="comment">//将ListState中的数据放到可排序的数据结构里面</span></span><br><span class="line">            List&lt;NewsWindowCount&gt; newsWindowCounts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            Iterator&lt;NewsWindowCount&gt; iterator = newsWindowCountListState.get().iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                newsWindowCounts.add(iterator.next());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//清除状态，节省内存</span></span><br><span class="line">            newsWindowCountListState.clear();</span><br><span class="line">            newsWindowCounts.sort(<span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;NewsWindowCount&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(NewsWindowCount o1, NewsWindowCount o2)</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (o1.count == o2.count) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o1.count &gt; o2.count) &#123;</span><br><span class="line">                        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将新闻排名格式化输出</span></span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">outputStr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">            outputStr.append(<span class="string">&quot;windowEndTime:&quot;</span>).append(<span class="keyword">new</span> <span class="title class_">Timestamp</span>(timestamp - <span class="number">1</span>)).append(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; Math.min(newsWindowCounts.size(), topN); i++) &#123;</span><br><span class="line">                <span class="type">NewsWindowCount</span> <span class="variable">newsWindowCount</span> <span class="operator">=</span> newsWindowCounts.get(i);</span><br><span class="line">                outputStr.append(<span class="string">&quot;No.&quot;</span>).append(i + <span class="number">1</span>)</span><br><span class="line">                        .append(<span class="string">&quot; 新闻ID:&quot;</span>).append(newsWindowCount.newsId).append(<span class="string">&quot;\t&quot;</span>)</span><br><span class="line">                        .append(<span class="string">&quot; 点击量:&quot;</span>).append(newsWindowCount.count)</span><br><span class="line">                        .append(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            out.collect(outputStr.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>准备数据news.txt</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">100001,1,南京,鸟哥发财了,1608285818351,20201218 18:03:38:351</span><br><span class="line">100002,1,南京,李晶发财了,1608285878351,20201218 18:04:38:351</span><br><span class="line">100002,1,北京,李晶发财了,1608285900000,20201218 18:05:00:000</span><br><span class="line">100003,1,南京,衡总发财了,1608285900002,20201218 18:05:00:002</span><br><span class="line"></span><br><span class="line">100001,1,南京,鸟哥发财了,1608285938351,20201218 18:05:38:351</span><br><span class="line">100005,1,南京,军哥发财了,1608286058351,20201218 18:07:38:351</span><br><span class="line">100005,1,南京,军哥发财了,1608286178351,20201218 18:09:38:351</span><br><span class="line">100005,1,南京,军哥发财了,1608286200000,20201218 18:10:00:000</span><br><span class="line">100001,1,南京,鸟哥发财了,1608286200002,20201218 18:10:00:002</span><br><span class="line">100003,1,南京,衡总发财了,1608286298351,20201218 18:11:38:351</span><br><span class="line"></span><br><span class="line">100002,1,南京,李晶发财了,1608289200000,20201218 19:00:00:000</span><br><span class="line">100002,1,南京,李晶发财了,1608289200002,20201218 19:00:00:002</span><br><span class="line">100002,1,南京,李晶发财了,1608289500002,20201218 19:00:05:002</span><br></pre></td></tr></table></figure>

<p>分别运行flink应用程序、kafka生产者工具，并发送第一条消息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --create --zookeeper 192.168.174.136:2181 --replication-factor 2 -partitions 2 --topic topic_hotlist</span><br><span class="line">kafka-console-producer.sh --topic topic_hotlist --bootstrap-server 192.168.174.136:9092</span><br><span class="line">&gt;100001,1,南京,鸟哥发财了,1608285818351</span><br></pre></td></tr></table></figure>

<p>flink应用程序收到第一条数据时没有输出，直到收到第4条时间戳为1608285900002的数据才触发计算，此时数据的时间戳正好比window的endTime 18:05:00加1毫秒大，因此触发计算。但是输出的统计结果不含时间戳为1608285900000的这条边界数据，因此结果如下：</p>
<p>输入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">100002</span>,<span class="number">1</span>,南京,李晶发财了,<span class="number">1608285878351</span></span><br><span class="line">&gt;<span class="number">100002</span>,<span class="number">1</span>,北京,李晶发财了,<span class="number">1608285900000</span></span><br><span class="line">&gt;<span class="number">100003</span>,<span class="number">1</span>,南京,衡总发财了,<span class="number">1608285900002</span></span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">windowEndTime:<span class="number">2020</span>-<span class="number">12</span>-<span class="number">18</span> <span class="number">18</span>:<span class="number">05</span>:<span class="number">00.0</span></span><br><span class="line">No<span class="number">.1</span> 新闻ID:<span class="number">100001</span>	 点击量:<span class="number">1</span></span><br><span class="line">No<span class="number">.2</span> 新闻ID:<span class="number">100002</span>	 点击量:<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>以此类推，时间戳为1608286200001的数据到达时，再次触发计算，累计统计前一小时的数据。</p>
<p>输入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">100001</span>,<span class="number">1</span>,南京,鸟哥发财了,<span class="number">1608285938351</span></span><br><span class="line">&gt;<span class="number">100005</span>,<span class="number">1</span>,南京,军哥发财了,<span class="number">1608286058351</span></span><br><span class="line">&gt;<span class="number">100005</span>,<span class="number">1</span>,南京,军哥发财了,<span class="number">1608286178351</span></span><br><span class="line">&gt;<span class="number">100005</span>,<span class="number">1</span>,南京,军哥发财了,<span class="number">1608286200000</span></span><br><span class="line">&gt;<span class="number">100001</span>,<span class="number">1</span>,南京,鸟哥发财了,<span class="number">1608286200002</span></span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">windowEndTime:<span class="number">2020</span>-<span class="number">12</span>-<span class="number">18</span> <span class="number">18</span>:<span class="number">10</span>:<span class="number">00.0</span></span><br><span class="line">No<span class="number">.1</span> 新闻ID:<span class="number">100005</span>	 点击量:<span class="number">2</span></span><br><span class="line">No<span class="number">.2</span> 新闻ID:<span class="number">100001</span>	 点击量:<span class="number">2</span></span><br><span class="line">No<span class="number">.3</span> 新闻ID:<span class="number">100002</span>	 点击量:<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>当时间戳跳变到19:00:00:000时，之前的窗口全部触发计算。因此输出统计结果如下:</p>
<p>输入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">100003</span>,<span class="number">1</span>,南京,衡总发财了,<span class="number">1608286298351</span></span><br><span class="line">&gt;<span class="number">100002</span>,<span class="number">1</span>,南京,李晶发财了,<span class="number">1608289200000</span></span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">windowEndTime:<span class="number">2020</span>-<span class="number">12</span>-<span class="number">18</span> <span class="number">18</span>:<span class="number">15</span>:<span class="number">00.0</span></span><br><span class="line">No<span class="number">.1</span> 新闻ID:<span class="number">100001</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.2</span> 新闻ID:<span class="number">100005</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.3</span> 新闻ID:<span class="number">100002</span>	 点击量:<span class="number">1</span></span><br><span class="line"></span><br><span class="line">windowEndTime:<span class="number">2020</span>-<span class="number">12</span>-<span class="number">18</span> <span class="number">18</span>:<span class="number">20</span>:<span class="number">00.0</span></span><br><span class="line">No<span class="number">.1</span> 新闻ID:<span class="number">100005</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.2</span> 新闻ID:<span class="number">100001</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.3</span> 新闻ID:<span class="number">100002</span>	 点击量:<span class="number">1</span></span><br><span class="line"></span><br><span class="line">windowEndTime:<span class="number">2020</span>-<span class="number">12</span>-<span class="number">18</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">00.0</span></span><br><span class="line">No<span class="number">.1</span> 新闻ID:<span class="number">100005</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.2</span> 新闻ID:<span class="number">100001</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.3</span> 新闻ID:<span class="number">100002</span>	 点击量:<span class="number">1</span></span><br><span class="line"></span><br><span class="line">windowEndTime:<span class="number">2020</span>-<span class="number">12</span>-<span class="number">18</span> <span class="number">18</span>:<span class="number">30</span>:<span class="number">00.0</span></span><br><span class="line">No<span class="number">.1</span> 新闻ID:<span class="number">100001</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.2</span> 新闻ID:<span class="number">100005</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.3</span> 新闻ID:<span class="number">100002</span>	 点击量:<span class="number">1</span></span><br><span class="line"></span><br><span class="line">windowEndTime:<span class="number">2020</span>-<span class="number">12</span>-<span class="number">18</span> <span class="number">18</span>:<span class="number">35</span>:<span class="number">00.0</span></span><br><span class="line">No<span class="number">.1</span> 新闻ID:<span class="number">100001</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.2</span> 新闻ID:<span class="number">100005</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.3</span> 新闻ID:<span class="number">100002</span>	 点击量:<span class="number">1</span></span><br><span class="line"></span><br><span class="line">windowEndTime:<span class="number">2020</span>-<span class="number">12</span>-<span class="number">18</span> <span class="number">18</span>:<span class="number">40</span>:<span class="number">00.0</span></span><br><span class="line">No<span class="number">.1</span> 新闻ID:<span class="number">100005</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.2</span> 新闻ID:<span class="number">100001</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.3</span> 新闻ID:<span class="number">100002</span>	 点击量:<span class="number">1</span></span><br><span class="line"></span><br><span class="line">windowEndTime:<span class="number">2020</span>-<span class="number">12</span>-<span class="number">18</span> <span class="number">18</span>:<span class="number">45</span>:<span class="number">00.0</span></span><br><span class="line">No<span class="number">.1</span> 新闻ID:<span class="number">100001</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.2</span> 新闻ID:<span class="number">100005</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.3</span> 新闻ID:<span class="number">100002</span>	 点击量:<span class="number">1</span></span><br><span class="line"></span><br><span class="line">windowEndTime:<span class="number">2020</span>-<span class="number">12</span>-<span class="number">18</span> <span class="number">18</span>:<span class="number">50</span>:<span class="number">00.0</span></span><br><span class="line">No<span class="number">.1</span> 新闻ID:<span class="number">100001</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.2</span> 新闻ID:<span class="number">100005</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.3</span> 新闻ID:<span class="number">100003</span>	 点击量:<span class="number">1</span></span><br><span class="line"></span><br><span class="line">windowEndTime:<span class="number">2020</span>-<span class="number">12</span>-<span class="number">18</span> <span class="number">18</span>:<span class="number">55</span>:<span class="number">00.0</span></span><br><span class="line">No<span class="number">.1</span> 新闻ID:<span class="number">100001</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.2</span> 新闻ID:<span class="number">100005</span>	 点击量:<span class="number">3</span></span><br><span class="line">No<span class="number">.3</span> 新闻ID:<span class="number">100003</span>	 点击量:<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>输入<code>&gt;100002,1,南京,李晶发财了,1608289200002</code>时，</p>
<p>由于时间戳对应19:00:00:002，触发了window endTime 为19:00:00.0的窗口：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">windowEndTime:2020-12-18 19:00:00.0</span><br><span class="line">No.1 新闻ID:100001	 点击量:3</span><br><span class="line">No.2 新闻ID:100005	 点击量:3</span><br><span class="line">No.3 新闻ID:100003	 点击量:1</span><br></pre></td></tr></table></figure>

<p>输入最后一条数据100002,1,南京,李晶发财了,1608289500002时，输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">windowEndTime:2020-12-18 19:05:00.0</span><br><span class="line">No.1 新闻ID:100005	 点击量:3</span><br><span class="line">No.2 新闻ID:100002	 点击量:2</span><br><span class="line">No.3 新闻ID:100001	 点击量:2</span><br></pre></td></tr></table></figure>

<p>19:05:00.0统计的前1小时的区间为[18:05:00.0,19:05:00.0)</p>
<h3 id="订单超时检测"><a href="#订单超时检测" class="headerlink" title="订单超时检测"></a>订单超时检测</h3><p>在介绍实际案例之前，先补充一下CEP的理论知识。</p>
<h4 id="CEP简介"><a href="#CEP简介" class="headerlink" title="CEP简介"></a>CEP简介</h4><p>CEP是复杂事件处理（Complex Event Processing）的缩写。在Flink中，CEP用于在事件流中检测匹配事件模式，即对一个或多个简单事件构成的事件流进行一定规则地匹配，然后输出满足条件的复杂事件，也就是最终用户想要的结果。</p>
<p>Flink CEP提供了一组Pattern API，对输入流数据进行复杂事件规则定义，用来提取符合规则的事件序列。</p>
<p>Pattern API的使用步骤：</p>
<p>1）定义一个Pattern</p>
<p>2）将创建好的Pattern应用到输入事件流上</p>
<p>3）匹配出满足模式的事件序列，得到结果</p>
<p>Pattern API的分类：</p>
<p>1）个体模式(Individual Patterns)</p>
<p> 组成复杂规则的单个独立的模式定义，比如：start.times(3).where(new SimpleCondition(){…})</p>
<p> 个体模式又分 singleton(单例)模式和looping(循环）模式。单例模式只能接收一个事件而循环模式可以接收多个。</p>
<p> 可以在个体模式后面追加量词，指定循环次数。</p>
<p> 比如：</p>
<p> start.times(4) &#x2F;&#x2F;匹配出现4次</p>
<p> start.times(2，4) &#x2F;&#x2F;匹配出现2,3或者4次</p>
<p> 每个模式都需要指定触发条件，作为事件模式匹配的依据。个体模式可以通过.where() .or()和.until()来指定条件</p>
<p>2）组合模式(Combining Patterns)</p>
<p> 由一个个个体模式组合而成，进而形成一整个模式序列。组合模式必须以一个初始模式开始，比如：</p>
<p> Pattern&lt;Event，Event&gt; start&#x3D;Pattern.begin(“start”)</p>
<p>3）模式组(Groups of patterns)</p>
<p> 将一个模式序列作为条件嵌套在个体模式里构成一组模式</p>
<h4 id="近邻模式"><a href="#近邻模式" class="headerlink" title="近邻模式"></a>近邻模式</h4><p>1）严格近邻(Strict Contigutity)</p>
<p> 要求所有事件按照严格的顺序出现，中间没有任何不匹配的事件，使用.next()指定。例如对于模式“a next b”，事件序列</p>
<p> [a,c,b]并未匹配。</p>
<p>2）宽松近邻(Relaxed Contigutity)</p>
<p> 允许中间出现不匹配的事件，由.followedBy()指定。例如对于模式“a followedBy b”，事件[a,c,b]匹配。</p>
<p>3）不确定性宽松近邻(Non-Deterministic Relaxed Contigutity)</p>
<p> 进一步放宽条件，之前匹配过的条件还可以再次使用。由followedByAny()指定。例如对于模式“a followedByAny b”，事件序列</p>
<p> [a,c,b,b]匹配两次，分别为{a,b},{a,b}。</p>
<p>4）不允许某种近邻关系</p>
<p> .notNext() 不允许某个事件严格紧邻前一个事件发生</p>
<p> .notFollowedBy() 不想允许某个事件在两个事件之间发生</p>
<p>注意：</p>
<p>所有模式必须以.begin()开始</p>
<p>模式序列不能以.notFollowedBy()结束</p>
<p>not模式不允许使用optional修饰</p>
<p>可以为模式指定时间约束，指定多长时间内匹配有效，比如：</p>
<p>next.within(Time.seconds(5))</p>
<h4 id="模式检测"><a href="#模式检测" class="headerlink" title="模式检测"></a>模式检测</h4><p>1）一般模式检测</p>
<p>模式确定后，应用到输入流，用于模式匹配得到一个PatternStream</p>
<p>DataStream input&#x3D;…</p>
<p>Pattern&lt;Event,Event&gt; pattern&#x3D;Pattern.begin(“start”).where(…)…</p>
<p>PatternStream patternStream&#x3D;CEP.pattern(input,pattern);</p>
<p>匹配事件的提取</p>
<p>在得到PatternStream之后，可以使用select或者fastselect方法从检测到的事件序列中提取事件。</p>
<p>select方法使用参数Map,List&gt;来接收匹配到的事件序列，Map的key为模式的名称，value是所有匹配的事件的列表。</p>
<p>2）超时模式检测</p>
<p>select方法和fastselect方法可以指定超时处理程序，超时处理程序会接收到目前为止由模式匹配到的所有事件，可以指定一个OutputTag定义接收到的超时事件序列。</p>
<p>订单超时检测案例</p>
<p>1）导入pom依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">flink.version</span>&gt;</span>1.11.1<span class="tag">&lt;/<span class="name">flink.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scala.version</span>&gt;</span>2.12<span class="tag">&lt;/<span class="name">scala.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">kafka.version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">kafka.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">123456</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-cep_$&#123;scala.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）定义订单事件实体和结果实体</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderEvent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String orderId;</span><br><span class="line">    <span class="keyword">private</span> String eventType;</span><br><span class="line">    <span class="keyword">private</span> String transactId;</span><br><span class="line">    <span class="keyword">private</span> Long timeStamp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderEvent</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderEvent</span><span class="params">(String orderId, String eventType, String transactId, Long timeStamp)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orderId = orderId;</span><br><span class="line">        <span class="built_in">this</span>.eventType = eventType;</span><br><span class="line">        <span class="built_in">this</span>.transactId = transactId;</span><br><span class="line">        <span class="built_in">this</span>.timeStamp = timeStamp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//省略getter/setter方法/toString方法</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456789101112131415161718</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderRes</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String orderId;</span><br><span class="line">    <span class="keyword">private</span> String resultState;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderRes</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderRes</span><span class="params">(String orderId, String resultState)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orderId = orderId;</span><br><span class="line">        <span class="built_in">this</span>.resultState = resultState;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//省略getter/setter方法/toString方法</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">12345678910111213</span></span><br></pre></td></tr></table></figure>

<p>3）flink应用程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderPayTimeOutDetection</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取数据源，转换为实体类</span></span><br><span class="line">        <span class="type">URL</span> <span class="variable">resource</span> <span class="operator">=</span> OrderPayTimeOutDetection.class.getResource(<span class="string">&quot;/orderLog.txt&quot;</span>);</span><br><span class="line">        DataStreamSource&lt;String&gt; dataStreamSource = env.readTextFile(resource.getPath());</span><br><span class="line">        DataStream&lt;OrderEvent&gt; orderEventStream = dataStreamSource.map(line -&gt; &#123;</span><br><span class="line">            String[] split = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OrderEvent</span>(split[<span class="number">0</span>], split[<span class="number">1</span>], split[<span class="number">2</span>], <span class="keyword">new</span> <span class="title class_">Long</span>(split[<span class="number">3</span>]));</span><br><span class="line">        &#125;).assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="title class_">AscendingTimestampExtractor</span>&lt;OrderEvent&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">extractAscendingTimestamp</span><span class="params">(OrderEvent orderEvent)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> orderEvent.getTimeStamp() * <span class="number">1000L</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义模式</span></span><br><span class="line">        Pattern&lt;OrderEvent, OrderEvent&gt; orderPayPattern = Pattern.&lt;OrderEvent&gt;begin(<span class="string">&quot;create&quot;</span>).where(<span class="keyword">new</span> <span class="title class_">SimpleCondition</span>&lt;OrderEvent&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">filter</span><span class="params">(OrderEvent orderEvent)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="keyword">return</span> orderEvent.getEventType().equals(<span class="string">&quot;create&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">                <span class="comment">//宽松近邻，只要下单之后又支付操作即可</span></span><br><span class="line">                .followedBy(<span class="string">&quot;pay&quot;</span>).where(<span class="keyword">new</span> <span class="title class_">SimpleCondition</span>&lt;OrderEvent&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">filter</span><span class="params">(OrderEvent orderEvent)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="keyword">return</span> orderEvent.getEventType().equals(<span class="string">&quot;pay&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">//15分钟之类必须支付完成</span></span><br><span class="line">                .within(Time.minutes(<span class="number">15</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用侧输出流标签表示超时事件</span></span><br><span class="line">        OutputTag&lt;OrderRes&gt; orderTimeoutTag = <span class="keyword">new</span> <span class="title class_">OutputTag</span>&lt;OrderRes&gt;(<span class="string">&quot;order-timeout&quot;</span>) &#123;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将Pattern应用到输入事件流上得到PatternStream</span></span><br><span class="line">        PatternStream&lt;OrderEvent&gt; patternStream = CEP.pattern(orderEventStream.keyBy(OrderEvent::getOrderId), orderPayPattern);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用select方法实现对匹配事件和超时事件的处理</span></span><br><span class="line">        SingleOutputStreamOperator&lt;OrderRes&gt; resStream = patternStream.select(orderTimeoutTag, <span class="keyword">new</span> <span class="title class_">OrderTimeOutSelection</span>(), <span class="keyword">new</span> <span class="title class_">OrderPayedSelection</span>());</span><br><span class="line"></span><br><span class="line">        resStream.print(<span class="string">&quot;payed ok&quot;</span>);</span><br><span class="line">        resStream.getSideOutput(orderTimeoutTag).print(<span class="string">&quot;payed timeout&quot;</span>);</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">&quot;Order payTimeOut dDetection&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//超时事件处理</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OrderTimeOutSelection</span> <span class="keyword">implements</span> <span class="title class_">PatternTimeoutFunction</span>&lt;OrderEvent, OrderRes&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> OrderRes <span class="title function_">timeout</span><span class="params">(Map&lt;String, List&lt;OrderEvent&gt;&gt; pattern, <span class="type">long</span> timeoutTimestamp)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="comment">//由于是单例模式，可以直接取第一个元素</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">orderId</span> <span class="operator">=</span> pattern.get(<span class="string">&quot;create&quot;</span>).get(<span class="number">0</span>).getOrderId();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OrderRes</span>(orderId, <span class="string">&quot;timeout:&quot;</span> + timeoutTimestamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//正常事件匹配</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OrderPayedSelection</span> <span class="keyword">implements</span> <span class="title class_">PatternSelectFunction</span>&lt;OrderEvent, OrderRes&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> OrderRes <span class="title function_">select</span><span class="params">(Map&lt;String, List&lt;OrderEvent&gt;&gt; pattern)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">orderId</span> <span class="operator">=</span> pattern.get(<span class="string">&quot;pay&quot;</span>).get(<span class="number">0</span>).getOrderId();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OrderRes</span>(orderId, <span class="string">&quot;payed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）测试数据orderLog.txt</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">O9850001,create,,1610543460</span><br><span class="line">O9850002,create,,1610543520</span><br><span class="line">O9850003,create,,1610543580</span><br><span class="line">O9850002,pay,3c586d2g8,1610543580</span><br><span class="line">O9850004,create,,1610543760</span><br><span class="line">O9850001,pay,6c18cs3e8,1610544358</span><br><span class="line">O9850005,create,,1610544361</span><br><span class="line">O9850004,pay,fc1gce2g8,1610543760</span><br><span class="line">O9850003,pay,1c18us3e2,1610544580</span><br><span class="line">O9850006,create,,1610544600</span><br><span class="line">O9850005,pay,gc6g3st15,1610544600</span><br></pre></td></tr></table></figure>

<p>上述订单数据中包含订单号、订单状态、支付回码、时间戳，可以发现，订单O9850003、O9850006的支付时间超过15分钟或者未支付。运行程序，验证猜想。</p>
<p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payed ok&gt; OrderRes&#123;orderId=O9850001, resultState=<span class="string">&#x27;payed&#x27;</span>&#125;</span><br><span class="line">payed timeout&gt; OrderRes&#123;orderId=O9850006, resultState=<span class="string">&#x27;timeout:1610545500000&#x27;</span>&#125;</span><br><span class="line">payed ok&gt; OrderRes&#123;orderId=O9850005, resultState=<span class="string">&#x27;payed&#x27;</span>&#125;</span><br><span class="line">payed ok&gt; OrderRes&#123;orderId=O9850004, resultState=<span class="string">&#x27;payed&#x27;</span>&#125;</span><br><span class="line">payed timeout&gt; OrderRes&#123;orderId=O9850003, resultState=<span class="string">&#x27;timeout:1610544480000&#x27;</span>&#125;</span><br><span class="line">payed ok&gt; OrderRes&#123;orderId=O9850002, resultState=<span class="string">&#x27;payed&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="订单系统实时对账"><a href="#订单系统实时对账" class="headerlink" title="订单系统实时对账"></a>订单系统实时对账</h3><p>上一个案例中已经有了订单支付状态事件数据，再结合到账事件数据，两者比对就可以进行对账操作。</p>
<p>只要两个数据的支付码能够匹配就是比对成功</p>
<p>1）准备数据payCallBackLog.txt</p>
<p>和上文案例中的orderLog.txt对比可以发现，payCallBackLog.txt最后两条数据没有匹配的，orderLog.txt最后一条没有匹配的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">3c586d2g8,yqb,1610543460</span><br><span class="line">6c18cs3e8,wechat,1610543520</span><br><span class="line">fc1gce2g8,yqb,1610543580</span><br><span class="line">1c18us3e2,yqb,1610543590</span><br><span class="line">2c53cw938,wechat,1610543760</span><br><span class="line">gc6g3st15,wechat,1610543860</span><br></pre></td></tr></table></figure>

<p>2）OrderPayCallBackEvent实体</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderPayCallBackEvent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String transactId;</span><br><span class="line">    <span class="keyword">private</span> String payChannel;</span><br><span class="line">    <span class="keyword">private</span> Long timeStamp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderPayCallBackEvent</span><span class="params">(String transactId, String payChannel, Long timeStamp)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.transactId = transactId;</span><br><span class="line">        <span class="built_in">this</span>.payChannel = payChannel;</span><br><span class="line">        <span class="built_in">this</span>.timeStamp = timeStamp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//省略getter/setter方法/toString方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）flink对账应用程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 支付对账</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayReconcile</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义侧输出流标签保存对账不匹配的数据</span></span><br><span class="line">    <span class="comment">//订单支付事件</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> OutputTag&lt;OrderEvent&gt; unmatchedOrderPay = <span class="keyword">new</span> <span class="title class_">OutputTag</span>&lt;OrderEvent&gt;(<span class="string">&quot;unmatched_order_pay&quot;</span>) &#123;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//到账事件</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> OutputTag&lt;OrderPayCallBackEvent&gt; unmatchedOrderPayCallBack = <span class="keyword">new</span> <span class="title class_">OutputTag</span>&lt;OrderPayCallBackEvent&gt;(<span class="string">&quot;unmatched_order_pay_callback&quot;</span>) &#123;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取数据源，转换为实体类</span></span><br><span class="line">        <span class="type">URL</span> <span class="variable">orderEventResource</span> <span class="operator">=</span> PayReconcile.class.getResource(<span class="string">&quot;/orderLog.txt&quot;</span>);</span><br><span class="line">        DataStreamSource&lt;String&gt; dataStreamSource1 = env.readTextFile(orderEventResource.getPath());</span><br><span class="line">        DataStream&lt;OrderEvent&gt; orderEventStream = dataStreamSource1.map(line -&gt; &#123;</span><br><span class="line">            String[] split = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OrderEvent</span>(split[<span class="number">0</span>], split[<span class="number">1</span>], split[<span class="number">2</span>], <span class="keyword">new</span> <span class="title class_">Long</span>(split[<span class="number">3</span>]));</span><br><span class="line">        &#125;).assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="title class_">AscendingTimestampExtractor</span>&lt;OrderEvent&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">extractAscendingTimestamp</span><span class="params">(OrderEvent orderEvent)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> orderEvent.getTimeStamp() * <span class="number">1000L</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).filter(data -&gt; !<span class="string">&quot;&quot;</span>.equals(data.getTransactId()));<span class="comment">//过滤得到pay事件</span></span><br><span class="line"></span><br><span class="line">        <span class="type">URL</span> <span class="variable">orderPayResource</span> <span class="operator">=</span> PayReconcile.class.getResource(<span class="string">&quot;/payCallBackLog.txt&quot;</span>);</span><br><span class="line">        DataStreamSource&lt;String&gt; dataStreamSource2 = env.readTextFile(orderPayResource.getPath());</span><br><span class="line">        DataStream&lt;OrderPayCallBackEvent&gt; orderPayEventStream = dataStreamSource2.map(line -&gt; &#123;</span><br><span class="line">            String[] split = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OrderPayCallBackEvent</span>(split[<span class="number">0</span>], split[<span class="number">1</span>], <span class="keyword">new</span> <span class="title class_">Long</span>(split[<span class="number">2</span>]));</span><br><span class="line">        &#125;).assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="title class_">AscendingTimestampExtractor</span>&lt;OrderPayCallBackEvent&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">extractAscendingTimestamp</span><span class="params">(OrderPayCallBackEvent orderPayEvent)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> orderPayEvent.getTimeStamp() * <span class="number">1000L</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将2条流进行合流操作，检查匹配项</span></span><br><span class="line">        SingleOutputStreamOperator&lt;Tuple2&lt;OrderEvent, OrderPayCallBackEvent&gt;&gt; resStream = orderEventStream.keyBy(OrderEvent::getTransactId)</span><br><span class="line">                .connect(orderPayEventStream.keyBy(OrderPayCallBackEvent::getTransactId))</span><br><span class="line">                .process(<span class="keyword">new</span> <span class="title class_">PayMatchDetection</span>());</span><br><span class="line"></span><br><span class="line">        resStream.print(<span class="string">&quot;matched_pays&quot;</span>);</span><br><span class="line">        resStream.getSideOutput(unmatchedOrderPay).print(<span class="string">&quot;unmatched-orders-pay&quot;</span>);</span><br><span class="line">        resStream.getSideOutput(unmatchedOrderPayCallBack).print(<span class="string">&quot;unmatched-order-pays-callback&quot;</span>);</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">&quot;pay reconcile job&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PayMatchDetection</span> <span class="keyword">extends</span> <span class="title class_">CoProcessFunction</span>&lt;OrderEvent, OrderPayCallBackEvent, Tuple2&lt;OrderEvent, OrderPayCallBackEvent&gt;&gt; &#123;</span><br><span class="line">        <span class="comment">//定义状态，保存当前已经到来的订单支付事件和支付到账事件</span></span><br><span class="line">        ValueState&lt;OrderEvent&gt; orderPayState;</span><br><span class="line">        ValueState&lt;OrderPayCallBackEvent&gt; orderPayCallBackState;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            orderPayState = getRuntimeContext().getState(<span class="keyword">new</span> <span class="title class_">ValueStateDescriptor</span>&lt;OrderEvent&gt;(<span class="string">&quot;order_pay&quot;</span>, OrderEvent.class));</span><br><span class="line">            orderPayCallBackState = getRuntimeContext().getState(<span class="keyword">new</span> <span class="title class_">ValueStateDescriptor</span>&lt;OrderPayCallBackEvent&gt;(<span class="string">&quot;order_pay_callBack&quot;</span>, OrderPayCallBackEvent.class));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processElement1</span><span class="params">(OrderEvent orderEvent, Context context, Collector&lt;Tuple2&lt;OrderEvent, OrderPayCallBackEvent&gt;&gt; collector)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="comment">//订单支付事件到来时判断有没有对应的支付回调事件</span></span><br><span class="line">            <span class="type">OrderPayCallBackEvent</span> <span class="variable">orderPayCallBackEvent</span> <span class="operator">=</span> orderPayCallBackState.value();</span><br><span class="line">            <span class="keyword">if</span> (orderPayCallBackEvent != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//如果支付回调不为空，说明支付成功回调事件已经到达，输出匹配结果，清空状态</span></span><br><span class="line">                collector.collect(<span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(orderEvent, orderPayCallBackEvent));</span><br><span class="line">                orderPayCallBackState.clear();</span><br><span class="line">                orderPayState.clear();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//如果支付回调事件没来，注册一个5秒钟的定时器</span></span><br><span class="line">                context.timerService().registerEventTimeTimer((orderEvent.getTimeStamp() + <span class="number">5</span>) * <span class="number">1000L</span>);</span><br><span class="line">                <span class="comment">//更新订单支付事件状态</span></span><br><span class="line">                orderPayState.update(orderEvent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processElement2</span><span class="params">(OrderPayCallBackEvent orderPayCallBackEvent, Context context, Collector&lt;Tuple2&lt;OrderEvent, OrderPayCallBackEvent&gt;&gt; collector)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="comment">//订单支付回调事件到来时判断有没有对应的订单支付事件</span></span><br><span class="line">            <span class="type">OrderEvent</span> <span class="variable">orderEvent</span> <span class="operator">=</span> orderPayState.value();</span><br><span class="line">            <span class="keyword">if</span> (orderEvent != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//如果订单支付事件不为空，说明订单支付事件已经到达，输出匹配结果，清空状态</span></span><br><span class="line">                collector.collect(<span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(orderEvent, orderPayCallBackEvent));</span><br><span class="line">                orderPayCallBackState.clear();</span><br><span class="line">                orderPayState.clear();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//如果订单支付事件没来，注册一个2秒钟的定时器</span></span><br><span class="line">                context.timerService().registerEventTimeTimer((orderPayCallBackEvent.getTimeStamp() + <span class="number">2</span>) * <span class="number">1000L</span>);</span><br><span class="line">                <span class="comment">//更新订单支付事件状态</span></span><br><span class="line">                orderPayCallBackState.update(orderPayCallBackEvent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTimer</span><span class="params">(<span class="type">long</span> timestamp, OnTimerContext ctx, Collector&lt;Tuple2&lt;OrderEvent, OrderPayCallBackEvent&gt;&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="comment">//触发定时器，为了省略删除定时器的操作，可以这样做：</span></span><br><span class="line">            <span class="comment">//如果有一个事件不为空，则另一个对应的事件就还没到达，因为如果两个事件都到达会清空状态，导致两者同时为空</span></span><br><span class="line">            <span class="keyword">if</span> (orderPayState.value() != <span class="literal">null</span>) &#123;</span><br><span class="line">                ctx.output(unmatchedOrderPay, orderPayState.value());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (orderPayCallBackState.value() != <span class="literal">null</span>) &#123;</span><br><span class="line">                ctx.output(unmatchedOrderPayCallBack, orderPayCallBackState.value());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//清空状态</span></span><br><span class="line">            orderPayState.clear();</span><br><span class="line">            orderPayCallBackState.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）运行应用程序，输出对账成功的和对账失败的数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unmatched-order-pays-callback&gt; OrderPayCallBackEvent&#123;transactId=<span class="string">&#x27;2c53cw938&#x27;</span>, payChannel=<span class="string">&#x27;wechat&#x27;</span>, timeStamp=<span class="number">1610543760</span>&#125;</span><br><span class="line">unmatched-order-pays-callback&gt; OrderPayCallBackEvent&#123;transactId=<span class="string">&#x27;gc6g3st15&#x27;</span>, payChannel=<span class="string">&#x27;wechat&#x27;</span>, timeStamp=<span class="number">1610543860</span>&#125;</span><br><span class="line">unmatched-orders-pay&gt; OrderEvent&#123;orderId=O9850005, eventType=<span class="string">&#x27;pay&#x27;</span>, transactId=<span class="string">&#x27;gc6g3st5&#x27;</span>, timeStamp=<span class="number">1610544600</span>&#125;</span><br></pre></td></tr></table></figure>

<p>可见和之前的猜想一致。</p>
<h2 id="面试题集锦"><a href="#面试题集锦" class="headerlink" title="面试题集锦"></a>面试题集锦</h2><p><strong>1.谈谈flink集群中都有哪些角色？它们都有什么作用？</strong></p>
<p>Flink运行时架构由两种类型的进程组成：一个JobManager，以及多个TaskManager以及提交任务的Client。</p>
<p>JobManager进程由3个不同的组件构成：ResourceManager、Dispatcher、JobMaster。</p>
<p>JobManager在集群中充当管理者Master的角色，是整个集群的协调者，负责接收Flink Job，协调检查点，Failover故障恢复等。</p>
<p>TaskManager是具体执行计算的Worker，在其上执行Flink Job的一组Task，每个TaskManager负责管理其所在节点上的资源，比如内存、磁盘、网络，并将资源的状态向JobManager汇报。</p>
<p>Client是用来提交Flink应用程序的。当用户提交Flink应用程序时，会首先创建一个Client，该Client首先会对用户提交的Flink程序进行预处理，并提交到Flink集群中，Client从用户提交的Flink程序配置中获取JobManager的地址，并建立到JobManager的连接，将Flink Job提交给JobManager。</p>
<p><strong>2.slot和parallelism的关系以及并行度是如何设置的？</strong></p>
<p>一个算子(operator)的子任务(subtask)数，称之为该算子的并行度(parallelism)。</p>
<p>Slot指的是TaskManager能够提供的并发执行能力，是静态的并行能力的概念。而Parallelism则是TaskManager 实际会使用的并发能力，是动态的并行能力的概念。动态占用的资源总数必须小于静态能够提供的资源数。</p>
<p>parallelism有多种设置方法。</p>
<p>可以在算子层面设置，即代码中各个算子后面调用api直接设置。</p>
<p>可以在执行层面设置，即在Environment 中全局设置。</p>
<p>也可以在配置文件中设置，在flink-conf.yaml中配置。</p>
<p>还可以在命令行提交任务时 -p 指定。</p>
<p><strong>3.聊聊Flink的反压机制</strong></p>
<p>反压，即backpressure，也称作背压。通常在流计算处理链路中，如果数据输入的速度高于数据处理的速度，就会导致数据堆积。比如在Flink中，sink端处理数据的速度跟不上source端接收数据的速度，那么就会导致数据堆积，慢慢的，sink端的低效反过来给其上游链路造成了压力。如果说系统能感知到消息堆积，并调整消息发送(接收)的速度，使得数据的发送(接收)速度能和处理速度相协调，那么该系统就是具有背压感知机制的系统。Flink无疑就是具有背压应对机制的系统。</p>
<p>在Flink的<a target="_blank" rel="noopener" href="https://www.ververica.com/how-flink-handles-backpressure">官方博客</a>中有这样的实验，将数据接收task的速度调整到其最大速度的60%，数据处理task以同样的速度处理。然后将数据处理task的速度降至其最高速度的30%，此时会产生背压问题，但是在Flink中，此时数据接收task的速度也自然降至其最高速度的30%。最后停止数据接收task的人为降速，数据接收task和数据消费task都达到了其最大速度。这就是flink中的反压处理机制，保证数据接收的速度不会快于数据消费的速度。Flink 使用了高效有界的分布式阻塞队列，类似Java中的通用阻塞队列(BlockingQueue)。下游消费者消费变慢，上游就会受到阻塞。Flink没有使用复杂的机制来处理反压问题， 而是利用自身作为纯数据流引擎的优势来优雅地处理反压问题。</p>
<p><strong>4.端到端的exactly-once保证；如何保证消费kakfa数据不丢失</strong></p>
<p>端到端的一致性指的是贯穿整个流处理应用的每一个组件都保证了其自身的一致性。</p>
<p>端到端的一致性要求数据源（source端）支持可重设数据的读取位置、从故障恢复时数据不会重复写入外设（sink端）。其次flink内部处理器使用checkpoint机制保证一致。</p>
<p>sink端一致性的具体实现有幂等写入和事务写入两种方式。事务性写入又有预写日志（WAL）和两阶段提交（2PC）两种方式。如果外部系统不支持事务，那么可以用预写日志的方式，把结果数据先当成状态保存，然后在收到 checkpoint 完成的通知时，一次性写入 sink 系统。</p>
<p>为了保证端到端的一致性，flink会维护消费kafka的偏移量，内部又有checkpoint机制，因此能够保证消费kafka数据不丢失。</p>
<p><strong>5.说一下flink的状态机制、容错机制</strong></p>
<p>官网对Flink的介绍是：一个用于无界和有界数据流上的有状态计算的分布式处理框架。因此Flink必然有一套状态管理机制来保证其状态的一致性。</p>
<p>在Flink中，状态与特定算子相关联。常用的就是Managed State下的Keyed State。Flink利用checkpoint机制对各个任务的状态进行快照保存，在故障恢复时能够保证状态一致性。Flink通过状态后端来管理状态以及对checkpoint存储，状态后端通常支持内存、分布式文件系统、嵌入式数据库rocksDB。</p>
<p>Flink的容错机制和状态管理是息息相关的。容错本质上就是对状态的容错，就是保证状态不丢失，后续可以重新读取状态恢复现场。</p>
<p><strong>6.谈一下flink的watermark机制</strong></p>
<p>watermark本质上是为了处理乱序或者延迟数据而引入整体的时间延迟机制。主要用来衡量EventTime的进展，能够在一定程度上容忍迟到的数据，能够将迟到的数据纳入正常的处理中。</p>
<p><strong>7.讲讲flink中的几种时间语义</strong></p>
<p>在flink中，有3中不同的时间语义</p>
<ul>
<li>event time：事件创建的时间。比如用户点击按钮触发时。</li>
<li>ingestion time：数据进入flink的时间。即经过一系列的网络传输，进入flink source的时间。</li>
<li>processing time：flink执行operator操作时本地系统时间。从source进来到分配到TaskManager中的slot处理也是耗时的，比如数据重分区，因此存在理论上的时间差。即理论上processing time晚于ingestion time。</li>
</ul>
<p><strong>8.谈谈CEP的应用</strong></p>
<p>CEP是复杂事件处理(Complex Event Processing)的简称。CEP 可以在无界事件流中检测匹配某种模式的事件，输出用户想得到的数据。CEP中的个体模式、组合模式、模式组能够让我们在处理复杂的业务逻辑时游刃有余。具体应用参见本文的订单系统实时对账。全文连载于CSDN博客。请访问个人主页：<a target="_blank" rel="noopener" href="https://blog.csdn.net/hellozpc">https://blog.csdn.net/hellozpc</a></p>
<p><strong>9.讲讲你们公司的flink架构以及你们是如何提交实时任务的</strong></p>
<p>我主要用公司的flink集群做司机车辆位置上报数据的处理，我们用的是腾讯云4核的4G的机器。共10台机器，随业务量的增加动态扩展。每台机器的slot数和cpu核数保持一致。我们使用的是standalone模式，并且配置了HA 高可用。我们通常有两种提交作业的方式。</p>
<p>1）直接将flink应用打成jar包，通过命令行或者页面提交任务</p>
<p>2）在代码中使用createRemoteEnvironment远程提交任务，可以集成到SpringBoot应用中</p>
<p><strong>10.你们在使用flink时有没有使用到关系数据库存储数据，如何做的</strong></p>
<p>我们一般不会直接将flink的数据写入到RDBMS中。一般先将处理结果写入kafka，rabbitmq中，再写入mysql。用消息队列来为关系型数据库降低压力。</p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
		data-enable='false'
        data-ae='false'
        data-ci=''
        data-cs=''
        data-r=''
        data-o=''
        data-a=''
        data-d='false'
    >查看评论</div>


    </div>
    
        <div class='side'>
			<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">文章目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BroadCast-State%E5%92%8CBroadCast-Stream"><span class="toc-number">2.</span> <span class="toc-text">BroadCast State和BroadCast Stream</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RocksDB"><span class="toc-number">3.</span> <span class="toc-text">RocksDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#QueryableState"><span class="toc-number">4.</span> <span class="toc-text">QueryableState</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#QueryableState%E7%BB%84%E4%BB%B6"><span class="toc-number">4.1.</span> <span class="toc-text">QueryableState组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AFQueryable-State"><span class="toc-number">4.2.</span> <span class="toc-text">开启Queryable State</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8Flink%E4%B8%AD%E4%BD%BF%E7%8A%B6%E6%80%81%E5%8F%AF%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.3.</span> <span class="toc-text">在Flink中使状态可查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-number"></span> <span class="toc-text">实战案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E9%A1%B5UV%E7%BB%9F%E8%AE%A1"><span class="toc-number">1.</span> <span class="toc-text">网页UV统计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%95%B0%E6%8D%AE%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="toc-number">1.1.</span> <span class="toc-text">日志数据实体类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Flink%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.2.</span> <span class="toc-text">Flink应用程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAtopic"><span class="toc-number">1.3.</span> <span class="toc-text">创建topic</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0jar%E5%88%B0flink%E9%9B%86%E7%BE%A4%E4%B8%AD%E8%BF%90%E8%A1%8C"><span class="toc-number">1.4.</span> <span class="toc-text">上传jar到flink集群中运行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%8F%90%E4%BA%A4Flink%E5%BA%94%E7%94%A8"><span class="toc-number">1.5.</span> <span class="toc-text">远程提交Flink应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#springboot%E5%90%AF%E5%8A%A8flink%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.6.</span> <span class="toc-text">springboot启动flink任务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#pom-xml"><span class="toc-number">1.6.1.</span> <span class="toc-text">pom.xml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SpringBoot%E5%85%A5%E5%8F%A3%E7%B1%BB"><span class="toc-number">1.6.2.</span> <span class="toc-text">SpringBoot入口类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Flink%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F-1"><span class="toc-number">1.6.3.</span> <span class="toc-text">Flink应用程序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%B4%E6%9D%A1%E5%AE%9E%E6%97%B6%E7%83%AD%E6%A6%9C%E7%BB%9F%E8%AE%A1"><span class="toc-number">2.</span> <span class="toc-text">头条实时热榜统计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E8%B6%85%E6%97%B6%E6%A3%80%E6%B5%8B"><span class="toc-number">3.</span> <span class="toc-text">订单超时检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CEP%E7%AE%80%E4%BB%8B"><span class="toc-number">3.1.</span> <span class="toc-text">CEP简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%91%E9%82%BB%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.2.</span> <span class="toc-text">近邻模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E6%A3%80%E6%B5%8B"><span class="toc-number">3.3.</span> <span class="toc-text">模式检测</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E7%B3%BB%E7%BB%9F%E5%AE%9E%E6%97%B6%E5%AF%B9%E8%B4%A6"><span class="toc-number">4.</span> <span class="toc-text">订单系统实时对账</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98%E9%9B%86%E9%94%A6"><span class="toc-number"></span> <span class="toc-text">面试题集锦</span></a>	
        </div>
    
</div>


    </div>
</div>
</body>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>




</html>
