<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Python 3 利用 Dlib 实现摄像头实时人脸识别 | 君子兰萧宇的博客</title><meta name="keywords" content="Python,人脸识别"><meta name="author" content="萧宇"><meta name="copyright" content="萧宇"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="Python 3 利用 Dlib 实现摄像头实时人脸识别 0. 引言 　　利用 Python 开发，借助 Dlib 库捕获摄像头中的人脸，提取人脸特征，通过计算特征值之间的欧氏距离，来和预存的人脸特征进行对比，判断是否匹配，达到人脸识别的目的； 　　可以从摄像头中抠取人脸图片存储到本地，然后提取构建预设人脸特征； 　　根据抠取的 &amp;#x2F; 已有的同一个人多张人脸图片提取 128D 特征值，然后计算该人的"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://aichn.cn/post/375ec5b6"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/css/APlayer.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2023-11-21 03:20:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">163</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">87</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">36</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 文章</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="http://xiao.aichn.cn"><span> 论坛</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/1152352-20181029164755617-126045850.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">君子兰萧宇的博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 文章</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="http://xiao.aichn.cn"><span> 论坛</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div><div id="aplayer"><script src="/js/APlayer.min.js"></script>            
            <script src="/js/Meting.min.js"></script>            <meting-js id="6771987564" server="netease" type="playlist" order="random" autoplay="true" preload="auto" list-folded="" fixed="true"></meting-js></div></nav><div id="post-info"><h1 class="post-title">Python 3 利用 Dlib 实现摄像头实时人脸识别</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2017-12-23T13:06:36.000Z" title="undefined 2017-12-23 21:06:36">2017-12-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/python/">python</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><strong>Python 3 利用 Dlib 实现摄像头实时人脸识别</strong></p>
<p><strong>0. 引言</strong></p>
<p>　　利用 Python 开发，借助 Dlib 库捕获摄像头中的人脸，提取人脸特征，通过计算特征值之间的欧氏距离，来和预存的人脸特征进行对比，判断是否匹配，达到人脸识别的目的；</p>
<p>　　可以从摄像头中抠取人脸图片存储到本地，然后提取构建预设人脸特征；</p>
<p>　　根据抠取的 / 已有的同一个人多张人脸图片提取 128D 特征值，然后计算该人的 128D 特征均值；</p>
<p>　　然后和摄像头中实时获取到的人脸提取出的特征值，计算欧氏距离，判定是否为同一张人脸；　　</p>
<p>　　Python + OpenCv + Dlib ; 　</p>
<p>　　<strong>Features :</strong></p>
<ul>
<li>支持人脸数据采集，自行建立人脸数据库 / Support face register</li>
<li>调用摄像头实时人脸检测和识别 / Using camera to real-time detect and recognize faces</li>
<li>支持多张人脸 / Support multi-faces</li>
</ul>
<p>　　<strong>人脸识别 / Face Recognition</strong> 的说明：</p>
<p>　　Wikipedia 上关于<strong>人脸识别系统 / Face Recognition System</strong> 的描述：<em>they work by comparing selected facial features from given image with faces within a database.</em></p>
<p>　　本项目中就是比较 <strong>预设的人脸的特征</strong> 和 <strong>摄像头实时获取到的人脸的特征</strong> ；</p>
<p>　　核心就是 <strong>提取 128D 人脸特征，然后计算 摄像头人脸特征 和 预设的特征脸的\</strong>欧式距离，**进行比对；**</p>
<p>　　效果如下：　　</p>
<p><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/1152352-20181005123021947-1880770901.png" alt="img"> </p>
<p><strong>图 1 摄像头多个人脸时识别效果</strong> </p>
<p><strong>1. 总体流程</strong></p>
<p>　　先说下 <strong>人脸检测 ( Face detection )</strong> 和 <strong>人脸识别 ( Face Recognition )</strong> ，前者是达到检测出场景中人脸的目的就可以了，而后者不仅需要检测出人脸，还要和<strong>已有人脸数据进行比对</strong>，识别出是否在数据库中，或者进行身份标注之类处理，人脸检测和人脸识别两者有时候可能会被理解混淆；</p>
<p>　　我的之前一些项目都是用 Dlib 做人脸检测这块，这个项目想要实现的功能是人脸识别功能，借助的是 Dlib 官网中 face_recognition.py 这个例程 （ Link：<a target="_blank" rel="noopener" href="http://dlib.net/face_recognition.py.html">http://dlib.net/face_recognition.py.html</a> ）；</p>
<p>　　核心在于 利用“dlib_face_recognition_resnet_model_v1.dat” 这个 model，提取<strong>人脸图像的 128D 特征</strong>，然后比对不同人脸图片的 128D 特征，设定阈值 <strong>计算欧氏距离</strong> 来判断是否为同一张脸；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 # face recognition model, the object maps human faces into 128D vectors2 facerec = dlib.face_recognition_model_v1(&quot;dlib_face_recognition_resnet_model_v1.dat&quot;)3 4 shape = predictor(img, dets[0])5 face_descriptor = facerec.compute_face_descriptor(img, shape)</span><br></pre></td></tr></table></figure>


<p>　　 </p>
<p><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/1152352-20181005123055901-1748654455.png" alt="img"> </p>
<p><strong>图 2 总体设计流程</strong></p>
<p><strong>2.源码介绍</strong></p>
<p>　　主要有</p>
<p>　　　　<strong><em>get_face_from_camera.py\</em> ,</strong> </p>
<p>　　　　<strong><em>get_features_into_CSV.py\</em></strong> ，</p>
<p>　　　　<strong><em>face_reco_from_camera.py</em></strong></p>
<p>　　这三个 Python 文件，接下来会分别介绍实现功能；</p>
<p><strong>2.1 get_face_from_camera.py / 人脸注册录入</strong></p>
<p>　　人脸识别需要将 <strong>提取到的图像数据</strong> 和 <strong>已有图像数据</strong> 进行比对分析，所以这部分代码实现的功能就是 <strong>人脸录入</strong>；</p>
<p>　　程序会生成一个窗口，显示调用的摄像头实时获取的图像；</p>
<p>　　<em>（关于摄像头的调用方式可以参考这里： <a target="_blank" rel="noopener" href="http://www.cnblogs.com/AdaminXie/p/8472743.html">Python 3 利用 Dlib 19.7 实现摄像头人脸检测特征点标定</a>）；</em></p>
<p>　　</p>
<p>　　然后根据键盘输入进行人脸捕获：</p>
<ul>
<li>“N” 新录入人脸，新建文件夹 person_X/ 用来存储某人的人脸图像</li>
<li> “S” 开始捕获人脸，将捕获到的人脸放到 person_X/ 路径下</li>
<li>“Q” 退出窗口</li>
</ul>
<p>　　</p>
<p>　　摄像头的调用是利用 opencv 库的 <em>cv2.VideoCapture(0),</em> 此处参数为 0 代表调用的是笔记本的默认摄像头，你也可以让它调用传入已有视频文件；</p>
<p>　<img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/1152352-20181029163456334-85351276.png" alt="img"></p>
<p><strong>图 3 get_face_from_camera.py 的界面</strong></p>
<p> 　</p>
<p>　　捕获到的一组人脸示例；</p>
<p><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/1152352-20181002221712503-768390199.png" alt="img"></p>
<p><strong>图 4 捕获到的一组人脸</strong></p>
<p>　　<strong>get_face_from_camera.py 源码</strong></p>
<p><a href="http:"><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">  </span><br></pre></td></tr></table></figure>
<p># 进行人脸录入 / face register</p>
<p># 录入多张人脸 / support multi-faces</p>
<p># Author:  coneypo</p>
<p># Blog:   <a target="_blank" rel="noopener" href="http://www.cnblogs.com/AdaminXie">http://www.cnblogs.com/AdaminXie</a></p>
<p># GitHub:  <a target="_blank" rel="noopener" href="https://github.com/coneypo/Dlib_face_recognition_from_camera">https://github.com/coneypo/Dlib_face_recognition_from_camera</a></p>
<p># Mail:   <a href="mailto:&#x63;&#111;&#110;&#101;&#121;&#112;&#111;&#x40;&#x66;&#x6f;&#x78;&#109;&#x61;&#x69;&#108;&#x2e;&#99;&#x6f;&#x6d;">&#x63;&#111;&#110;&#101;&#121;&#112;&#111;&#x40;&#x66;&#x6f;&#x78;&#109;&#x61;&#x69;&#108;&#x2e;&#99;&#x6f;&#x6d;</a></p>
<p># Created at 2018-05-11</p>
<p># Updated at 2018-10-29</p>
<p>import dlib     # 人脸处理的库 Dlib</p>
<p>import numpy as np # 数据处理的库 Numpy</p>
<p>import cv2     # 图像处理的库 OpenCv</p>
<p>import os      # 读写文件</p>
<p>import shutil    # 读写文件</p>
<p># Dlib 正向人脸检测器</p>
<p>detector = dlib.get_frontal_face_detector()</p>
<p># Dlib 68 点特征预测器</p>
<p>predictor = dlib.shape_predictor(‘data/data_dlib/shape_predictor_68_face_landmarks.dat’)</p>
<p># OpenCv 调用摄像头</p>
<p>cap = cv2.VideoCapture(0)</p>
<p># 设置视频参数</p>
<p>cap.set(3, 480)</p>
<p># 人脸截图的计数器</p>
<p>cnt_ss = 0</p>
<p># 存储人脸的文件夹</p>
<p>current_face_dir = 0</p>
<p># 保存的路径</p>
<p>path_make_dir = “data/data_faces_from_camera/“</p>
<p>path_csv = “data/data_csvs_from_camera/“</p>
<p># (optional) 删除之前存的人脸数据文件夹</p>
<p>def pre_clear():</p>
<p>  folders_rd = os.listdir(path_make_dir)</p>
<p>  for i in range(len(folders_rd)):</p>
<p>​    shutil.rmtree(path_make_dir+folders_rd[i])</p>
<p>  csv_rd = os.listdir(path_csv)</p>
<p>  for i in range(len(csv_rd)):</p>
<p>​    os.remove(path_csv+csv_rd[i])</p>
<p># 每次程序录入之前，删掉之前存的人脸数据</p>
<p>pre_clear()</p>
<p># 人脸种类数目的计数器</p>
<p>person_cnt = 0</p>
<p>while cap.isOpened():</p>
<p>  # 480 height * 640 width</p>
<p>  flag, img_rd = cap.read()</p>
<p>  kk = cv2.waitKey(1)</p>
<p>  img_gray = cv2.cvtColor(img_rd, cv2.COLOR_RGB2GRAY)</p>
<p>  # 人脸数 faces</p>
<p>  faces = detector(img_gray, 0)</p>
<p>  # 待会要写的字体</p>
<p>  font = cv2.FONT_HERSHEY_COMPLEX</p>
<p>  # 按下 ‘n’ 新建存储人脸的文件夹</p>
<p>  if kk == ord(‘n’):</p>
<p>​    person_cnt += 1</p>
<p>​    current_face_dir = path_make_dir + “person_” + str(person_cnt)</p>
<p>​    print(‘\n’)</p>
<p>​    for dirs in (os.listdir(path_make_dir)):</p>
<p>​      if current_face_dir == path_make_dir + dirs:</p>
<p>​        shutil.rmtree(current_face_dir)</p>
<p>​        print(“删除旧的文件夹:”, current_face_dir)</p>
<p>​    os.makedirs(current_face_dir)</p>
<p>​    print(“新建的人脸文件夹: “, current_face_dir)</p>
<p>​    # 将人脸计数器清零</p>
<p>​    cnt_ss = 0</p>
<p>  if len(faces) != 0:</p>
<p>​    # 检测到人脸</p>
<p>​    # 矩形框</p>
<p>​    for k, d in enumerate(faces):</p>
<p>​      # 计算矩形大小</p>
<p>​      # (x,y), (宽度width, 高度height)</p>
<p>​      pos_start = tuple([d.left(), d.top()])</p>
<p>​      pos_end = tuple([d.right(), d.bottom()])</p>
<p>​      # 计算矩形框大小</p>
<p>​      height = (d.bottom() - d.top())</p>
<p>​      width = (d.right() - d.left())</p>
<p>​      hh = int(height/2)</p>
<p>​      ww = int(width/2)</p>
<p>​      # 设置颜色 / The color of rectangle of faces detected</p>
<p>​      color_rectangle = (255, 255, 255)</p>
<p>​      if (d.right()+ww) &gt; 640 or (d.bottom()+hh&gt;480) or (d.left()-ww &lt; 0) or ( d.top()-hh &lt; 0):</p>
<p>​        cv2.putText(img_rd, “OUT OF RANGE”, (20, 300), font, 0.8, (0, 0, 255), 1, cv2.LINE_AA)</p>
<p>​        color_rectangle = (0, 0, 255)</p>
<p>​      else:</p>
<p>​        color_rectangle = (255, 255, 255)</p>
<p>​      cv2.rectangle(img_rd,</p>
<p>​             tuple([d.left() - ww, d.top() - hh]),</p>
<p>​             tuple([d.right() + ww, d.bottom() + hh]),</p>
<p>​             color_rectangle, 2)</p>
<p>​      # 根据人脸大小生成空的图像</p>
<p>​      im_blank = np.zeros((int(height<em>2), width</em>2, 3), np.uint8)</p>
<p>​      # 按下 ‘s’ 保存摄像头中的人脸到本地</p>
<p>​      if kk == ord(‘s’):</p>
<p>​        cnt_ss += 1</p>
<p>​        for ii in range(height*2):</p>
<p>​          for jj in range(width*2):</p>
<p>​            im_blank[ii][jj] = img_rd[d.top()-hh + ii][d.left()-ww + jj]</p>
<p>​        cv2.imwrite(current_face_dir + “/img_face_” + str(cnt_ss) + “.jpg”, im_blank)</p>
<p>​        print(“写入本地：”, str(current_face_dir) + “/img_face_” + str(cnt_ss) + “.jpg”)</p>
<p>​    # 显示人脸数</p>
<p>  cv2.putText(img_rd, “Faces: “ + str(len(faces)), (20, 100), font, 0.8, (0, 255, 0), 1, cv2.LINE_AA)</p>
<p>  # 添加说明</p>
<p>  cv2.putText(img_rd, “Face Register”, (20, 40), font, 1, (0, 0, 0), 1, cv2.LINE_AA)</p>
<p>  cv2.putText(img_rd, “N: New face folder”, (20, 350), font, 0.8, (0, 0, 0), 1, cv2.LINE_AA)</p>
<p>  cv2.putText(img_rd, “S: Save face”, (20, 400), font, 0.8, (0, 0, 0), 1, cv2.LINE_AA)</p>
<p>  cv2.putText(img_rd, “Q: Quit”, (20, 450), font, 0.8, (0, 0, 0), 1, cv2.LINE_AA)</p>
<p>  # 按下 ‘q’ 键退出</p>
<p>  if kk == ord(‘q’):</p>
<p>​    break</p>
<p>  # 窗口显示</p>
<p>  # cv2.namedWindow(“camera”, 0) # 如果需要摄像头窗口大小可调</p>
<p>  cv2.imshow(“camera”, img_rd)</p>
<p># 释放摄像头</p>
<p>cap.release()</p>
<p># 删除建立的窗口</p>
<p>cv2.destroyAllWindows()</p>
<p><a href="http:"><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/copycode.gif" alt="复制代码"></a></p>
<p>考虑到有可能需要保存的矩形框超出摄像头范围，对于这种异常，如果矩形框超出范围，矩形框会从白变红，然后提示 “OUT OF RANGE”;</p>
<p><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/1152352-20181029163559597-1249215749.png" alt="img"></p>
<p><strong>图 5 人脸录入异常处理</strong></p>
<p>　　<strong>get_face_from_camera.py 的输出 log</strong></p>
<p><a href="http:"><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">删除旧的文件夹: F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_1</span><br><span class="line">新建的人脸文件夹:  F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_1</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_1/img_face_1.jpg</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_1/img_face_2.jpg</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_1/img_face_3.jpg</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_1/img_face_4.jpg</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_1/img_face_5.jpg</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_1/img_face_6.jpg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">删除旧的文件夹: F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_2</span><br><span class="line">新建的人脸文件夹:  F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_2</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_2/img_face_1.jpg</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_2/img_face_2.jpg</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_2/img_face_3.jpg</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_2/img_face_4.jpg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">删除旧的文件夹: F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_3</span><br><span class="line">新建的人脸文件夹:  F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_3</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_3/img_face_1.jpg</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_3/img_face_2.jpg</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_3/img_face_3.jpg</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_3/img_face_4.jpg</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_3/img_face_5.jpg</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_3/img_face_6.jpg</span><br><span class="line">写入本地： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_3/img_face_7.jpg</span><br></pre></td></tr></table></figure>
<p><a href="http:"><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/copycode.gif" alt="复制代码"></a></p>
<p><strong>2.2</strong> <strong>get_features_into_CSV.py / 将图像文件中人脸数据提取出来存入 CSV</strong></p>
<p>　　这部分代码实现的功能是将之前捕获到的人脸图像文件，提取出 128D 特征，然后计算出某人人脸数据的特征均值存入 CSV 中，方便之后识别时候进行比对；</p>
<p>　　利用 numpy.mean() 计算特征均值；</p>
<p>　　<strong>get_features_into_CSV.py 源码：</strong></p>
<p><a href="http:"><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<p># 从人脸图像文件中提取人脸特征存入 CSV</p>
<p># Author:  coneypo</p>
<p># Blog:   <a target="_blank" rel="noopener" href="http://www.cnblogs.com/AdaminXie">http://www.cnblogs.com/AdaminXie</a></p>
<p># GitHub:  <a target="_blank" rel="noopener" href="https://github.com/coneypo/Dlib_face_recognition_from_camera">https://github.com/coneypo/Dlib_face_recognition_from_camera</a></p>
<p># Mail:   <a href="mailto:&#99;&#x6f;&#110;&#101;&#121;&#112;&#111;&#x40;&#102;&#111;&#x78;&#x6d;&#x61;&#105;&#108;&#46;&#99;&#111;&#x6d;">&#99;&#x6f;&#110;&#101;&#121;&#112;&#111;&#x40;&#102;&#111;&#x78;&#x6d;&#x61;&#105;&#108;&#46;&#99;&#111;&#x6d;</a></p>
<p># Created at 2018-05-11</p>
<p># Updated at 2018-10-29</p>
<p># 增加录入多张人脸到 CSV 的功能</p>
<p># return_128d_features()     获取某张图像的 128D 特征</p>
<p># write_into_csv()        获取某个路径下所有图像的特征，并写入 CSV</p>
<p># compute_the_mean()       从 CSV　中读取　128D 特征，并计算特征均值</p>
<p>import cv2</p>
<p>import os</p>
<p>import dlib</p>
<p>from skimage import io</p>
<p>import csv</p>
<p>import numpy as np</p>
<p>import pandas as pd</p>
<p>path_faces_rd = “data/data_faces_from_camera/“</p>
<p>path_csv = “data/data_csvs_from_camera/“</p>
<p># Dlib 正向人脸检测器</p>
<p>detector = dlib.get_frontal_face_detector()</p>
<p># Dlib 人脸预测器</p>
<p>predictor = dlib.shape_predictor(“data/data_dlib/shape_predictor_5_face_landmarks.dat”)</p>
<p># Dlib 人脸识别模型</p>
<p># Face recognition model, the object maps human faces into 128D vectors</p>
<p>facerec = dlib.face_recognition_model_v1(“data/data_dlib/dlib_face_recognition_resnet_model_v1.dat”)</p>
<p># 返回单张图像的 128D 特征</p>
<p>def return_128d_features(path_img):</p>
<p>  img = io.imread(path_img)</p>
<p>  img_gray = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)</p>
<p>  faces = detector(img_gray, 1)</p>
<p>  print(“检测的人脸图像：”, path_img, “\n”)</p>
<p>  # 因为有可能截下来的人脸再去检测，检测不出来人脸了</p>
<p>  # 所以要确保是 检测到人脸的人脸图像 拿去算特征</p>
<p>  if len(faces) != 0:</p>
<p>​    shape = predictor(img_gray, faces[0])</p>
<p>​    face_descriptor = facerec.compute_face_descriptor(img_gray, shape)</p>
<p>  else:</p>
<p>​    face_descriptor = 0</p>
<p>​    print(“no face”)</p>
<p>  # print(face_descriptor)</p>
<p>  return face_descriptor</p>
<p># 将文件夹中照片特征提取出来，写入 CSV</p>
<p>#  path_faces_personX:   图像文件夹的路径</p>
<p>#  path_csv:        要生成的 CSV 路径</p>
<p>def write_into_csv(path_faces_personX, path_csv):</p>
<p>  dir_pics = os.listdir(path_faces_personX)</p>
<p>  with open(path_csv, “w”, newline=””) as csvfile:</p>
<p>​    writer = csv.writer(csvfile)</p>
<p>​    for i in range(len(dir_pics)):</p>
<p>​      # 调用return_128d_features()得到128d特征</p>
<p>​      print(“正在读的人脸图像：”, path_faces_personX + “/“ + dir_pics[i])</p>
<p>​      features_128d = return_128d_features(path_faces_personX + “/“ + dir_pics[i])</p>
<p>​      # print(features_128d)</p>
<p>​      # 遇到没有检测出人脸的图片跳过</p>
<p>​      if features_128d == 0:</p>
<p>​        i += 1</p>
<p>​      else:</p>
<p>​        writer.writerow(features_128d)</p>
<p># 读取某人所有的人脸图像的数据，写入 person_X.csv</p>
<p>faces = os.listdir(path_faces_rd)</p>
<p>for person in faces:</p>
<p>  print(path_csv + person + “.csv”)</p>
<p>  write_into_csv(path_faces_rd + person, path_csv + person + “.csv”)</p>
<p># 从 CSV 中读取数据，计算 128D 特征的均值</p>
<p>def compute_the_mean(path_csv_rd):</p>
<p>  column_names = []</p>
<p>  # 128列特征</p>
<p>  for feature_num in range(128):</p>
<p>​    column_names.append(“features_” + str(feature_num + 1))</p>
<p>  # 利用pandas读取csv</p>
<p>  rd = pd.read_csv(path_csv_rd, names=column_names)</p>
<p>  # 存放128维特征的均值</p>
<p>  feature_mean = []</p>
<p>  for feature_num in range(128):</p>
<p>​    tmp_arr = rd[“features_” + str(feature_num + 1)]</p>
<p>​    tmp_arr = np.array(tmp_arr)</p>
<p>​    # 计算某一个特征的均值</p>
<p>​    tmp_mean = np.mean(tmp_arr)</p>
<p>​    feature_mean.append(tmp_mean)</p>
<p>  return feature_mean</p>
<p># 存放所有特征均值的 CSV 的路径</p>
<p>path_csv_feature_all = “data/features_all.csv”</p>
<p># 存放人脸特征的 CSV 的路径</p>
<p>path_csv_rd = “data/data_csvs_from_camera/“</p>
<p>with open(path_csv_feature_all, “w”, newline=””) as csvfile:</p>
<p>  writer = csv.writer(csvfile)</p>
<p>  csv_rd = os.listdir(path_csv_rd)</p>
<p>  print(“得到的特征均值 / The generated average values of features stored in: “)</p>
<p>  for i in range(len(csv_rd)):</p>
<p>​    feature_mean = compute_the_mean(path_csv_rd + csv_rd[i])</p>
<p>​    # print(feature_mean)</p>
<p>​    print(path_csv_rd + csv_rd[i])</p>
<p>​    writer.writerow(feature_mean)</p>
<p><a href="http:"><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/copycode.gif" alt="复制代码"></a></p>
<p>　　我们可以看下对于某张图片，<strong>face_descriptor</strong> 这个 <strong>128D vectors</strong> 的输出结果：</p>
<p>　　绿色框内是我们的返回 128D 特征的函数；</p>
<p>　　在红色框内调用该函数来计算 img_face_13.jpg；</p>
<p>　　可以看到黄色框中的输出为 128D 的向量；</p>
<p><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/1152352-20180511120053065-1934983472.png" alt="img"></p>
<p><strong>图 6 返回单张图像的 128D 特征的计算结果</strong></p>
<p>　　之后就需要人脸图像进行批量化操作，提取出 128D 的特征，然后计算特征均值，存入 features_all.csv；</p>
<p>　　features_all.csv 是一个 n 行 128 列的 CSV， n 是录入的人脸数，128 列是某人的 128D 特征；</p>
<p>　　这存储的就是 <strong>录入的人脸数据，</strong>之后 <strong>摄像头捕获的人脸</strong> 将要拿过来和 <strong>这些特征值 进行比对，如果欧式距离比较近的话，就可以认为是同一张人脸</strong>；</p>
<p> 　<strong>get_features_into_CSV.py 的输出 log：</strong></p>
<p><a href="http:"><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">F:/code/python/P_dlib_face_reco/data/csvs_from_camera/person_1.csv</span><br><span class="line">正在读的人脸图像： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_1/img_face_1.jpg</span><br><span class="line">检测的人脸图像： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_1/img_face_1.jpg </span><br><span class="line">...正在读的人脸图像： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_5/img_face_3.jpg</span><br><span class="line">检测的人脸图像： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_5/img_face_3.jpg </span><br><span class="line"></span><br><span class="line">正在读的人脸图像： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_5/img_face_4.jpg</span><br><span class="line">检测的人脸图像： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_5/img_face_4.jpg </span><br><span class="line"></span><br><span class="line">正在读的人脸图像： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_5/img_face_5.jpg</span><br><span class="line">检测的人脸图像： F:/code/python/P_dlib_face_reco/data/faces_from_camera/person_5/img_face_5.jpg </span><br><span class="line"></span><br><span class="line">特征均值: </span><br><span class="line">F:/code/python/P_dlib_face_reco/data/csvs_from_camera/person_1.csv</span><br><span class="line">F:/code/python/P_dlib_face_reco/data/csvs_from_camera/person_2.csv</span><br><span class="line">F:/code/python/P_dlib_face_reco/data/csvs_from_camera/person_3.csv</span><br><span class="line">F:/code/python/P_dlib_face_reco/data/csvs_from_camera/person_4.csv</span><br><span class="line">F:/code/python/P_dlib_face_reco/data/csvs_from_camera/person_5.csv</span><br></pre></td></tr></table></figure>
<p><a href="http:"><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/copycode.gif" alt="复制代码"></a></p>
<p><strong>2.3 face_reco_from_camera.py / 实时人脸识别对比分析</strong></p>
<p>　　这部分源码实现的功能：调用摄像头，捕获摄像头中的人脸，然后如果检测到人脸，将 <strong>摄像头中的人脸提取出 128D 的特征</strong>，然后和 <strong>之前录入人脸的 128D 特征</strong> 进行计算欧式距离，如果比较小，可以判定为一个人，否则不是一个人；</p>
<p>　　欧氏距离对比的阈值设定，是在 <em>return_euclidean_distance</em> 函数的 <em>dist</em> 变量；</p>
<p>　　我这里程序里面指定的 <strong>欧氏距离判断阈值是 0.4</strong>，具体阈值可以根据实际情况或者测得结果进行修改；</p>
<p>　　</p>
<p>　　这边做了一个，让人名跟随显示在头像下方，如果想要在人脸矩形框下方显示人名，首先需要知道 Dlib 生成的矩形框的尺寸怎么读取；</p>
<p>　　Dlib 返回的 dets 变量是一系列人脸的数据，此处对单张人脸处理，所以取 dets[0] 的参数；</p>
<p>　　可以通过 <strong>dets[0].top()</strong>, <strong>dets[0].bottom()</strong>, <strong>dets[0].left()</strong> 和 <strong>dets[0].right()</strong> 来确定要显示的人名的坐标；</p>
<p><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/1152352-20181029164755617-126045850.png" alt="img"></p>
<p><strong>图 7 dets[0].top() 等参数说明</strong> </p>
<p>　　</p>
<p>　　得到矩形框的坐标，就可以获取人名的相对位置；</p>
<p>　　这是我这边取的坐标：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pos_text_1 = tuple([dets[0].left(), int(dets[0].bottom()+(dets[0].bottom()-dets[0].top())/4)])</span><br></pre></td></tr></table></figure>


<p>　　<img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/1152352-20181004111207854-1934282753.png" alt="img"> </p>
<p><strong>图 8 face_reco_from_camera.py 生成的人脸识别窗口界面</strong></p>
<p>　<strong>face_reco_from_camera.py</strong> 源码：</p>
<p><a href="http:"><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">  </span><br></pre></td></tr></table></figure>
<p># created at 2018-05-11</p>
<p># updated at 2018-09-08</p>
<p># support multi-faces now</p>
<p># Author:  coneypo</p>
<p># Blog:   <a target="_blank" rel="noopener" href="http://www.cnblogs.com/AdaminXie">http://www.cnblogs.com/AdaminXie</a></p>
<p># GitHub:  <a target="_blank" rel="noopener" href="https://github.com/coneypo/Dlib_face_recogqnition_from_camera">https://github.com/coneypo/Dlib_face_recogqnition_from_camera</a></p>
<p>import dlib     # 人脸识别的库dlib</p>
<p>import numpy as np # 数据处理的库numpy</p>
<p>import cv2     # 图像处理的库OpenCv</p>
<p>import pandas as pd # 数据处理的库Pandas</p>
<p># face recognition model, the object maps human faces into 128D vectors</p>
<p>facerec = dlib.face_recognition_model_v1(“dlib_face_recognition_resnet_model_v1.dat”)</p>
<p># 计算两个向量间的欧式距离</p>
<p>def return_euclidean_distance(feature_1, feature_2):</p>
<p>  feature_1 = np.array(feature_1)</p>
<p>  feature_2 = np.array(feature_2)</p>
<p>  dist = np.sqrt(np.sum(np.square(feature_1 - feature_2)))</p>
<p>  print(“e_distance: “, dist)</p>
<p>  if dist &gt; 0.4:</p>
<p>​    return “diff”</p>
<p>  else:</p>
<p>​    return “same”</p>
<p># 处理存放所有人脸特征的 CSV</p>
<p>path_features_known_csv = “data/features_all.csv”</p>
<p>csv_rd = pd.read_csv(path_features_known_csv, header=None)</p>
<p># 存储的特征人脸个数</p>
<p># print(csv_rd.shape[0])</p>
<p># 用来存放所有录入人脸特征的数组</p>
<p>features_known_arr = []</p>
<p># known faces</p>
<p>for i in range(csv_rd.shape[0]):</p>
<p>  features_someone_arr = []</p>
<p>  for j in range(0, len(csv_rd.ix[i, :])):</p>
<p>​    features_someone_arr.append(csv_rd.ix[i, :][j])</p>
<p>  #  print(features_someone_arr)</p>
<p>  features_known_arr.append(features_someone_arr)</p>
<p>print(“Faces in Database：”, len(features_known_arr))</p>
<p># Dlib 预测器</p>
<p>detector = dlib.get_frontal_face_detector()</p>
<p>predictor = dlib.shape_predictor(‘shape_predictor_68_face_landmarks.dat’)</p>
<p># 创建 cv2 摄像头对象</p>
<p>cap = cv2.VideoCapture(0)</p>
<p># cap.set(propId, value)</p>
<p># 设置视频参数，propId 设置的视频参数，value 设置的参数值</p>
<p>cap.set(3, 480)</p>
<p># 返回一张图像多张人脸的 128D 特征</p>
<p>def get_128d_features(img_gray):</p>
<p>  dets = detector(img_gray, 1)</p>
<p>  if len(dets) != 0:</p>
<p>​    face_des = []</p>
<p>​    for i in range(len(dets)):</p>
<p>​      shape = predictor(img_gray, dets[i])</p>
<p>​      face_des.append(facerec.compute_face_descriptor(img_gray, shape))</p>
<p>  else:</p>
<p>​    face_des = []</p>
<p>  return face_des</p>
<p># cap.isOpened（） 返回true/false 检查初始化是否成功</p>
<p>while cap.isOpened():</p>
<p>  flag, img_rd = cap.read()</p>
<p>  kk = cv2.waitKey(1)</p>
<p>  # 取灰度</p>
<p>  img_gray = cv2.cvtColor(img_rd, cv2.COLOR_RGB2GRAY)</p>
<p>  # 人脸数 dets</p>
<p>  faces = detector(img_gray, 0)</p>
<p>  # 待会要写的字体</p>
<p>  font = cv2.FONT_HERSHEY_COMPLEX</p>
<p>  cv2.putText(img_rd, “Press ‘q’: Quit”, (20, 400), font, 0.8, (84, 255, 159), 1, cv2.LINE_AA)</p>
<p>  # 存储人脸名字和位置的两个 list</p>
<p>  # list 1 (faces): store the name of faces        Jack  unknown unknown Mary</p>
<p>  # list 2 (pos_namelist): store the positions of faces  12,1  1,21  1,13  31,1</p>
<p>  # 存储所有人脸的名字</p>
<p>  pos_namelist = []</p>
<p>  name_namelist = []</p>
<p>  # 检测到人脸</p>
<p>  if len(faces) != 0:</p>
<p>​    # 获取当前捕获到的图像的所有人脸的特征，存储到 features_cap_arr</p>
<p>​    features_cap_arr = []</p>
<p>​    for i in range(len(faces)):</p>
<p>​      shape = predictor(img_rd, faces[i])</p>
<p>​      features_cap_arr.append(facerec.compute_face_descriptor(img_rd, shape))</p>
<p>​    # 遍历捕获到的图像中所有的人脸</p>
<p>​    for k in range(len(faces)):</p>
<p>​      # 让人名跟随在矩形框的下方</p>
<p>​      # 确定人名的位置坐标</p>
<p>​      # 先默认所有人不认识，是 unknown</p>
<p>​      name_namelist.append(“unknown”)</p>
<p>​      # 每个捕获人脸的名字坐标</p>
<p>​      pos_namelist.append(tuple([faces[k].left(), int(faces[k].bottom() + (faces[k].bottom() - faces[k].top()) / 4)]))</p>
<p>​      # 对于某张人脸，遍历所有存储的人脸特征</p>
<p>​      for i in range(len(features_known_arr)):</p>
<p>​        print(“with person_”, str(i+1), “the “, end=’’)</p>
<p>​        # 将某张人脸与存储的所有人脸数据进行比对</p>
<p>​        compare = return_euclidean_distance(features_cap_arr[k], features_known_arr[i])</p>
<p>​        if compare == “same”: # 找到了相似脸</p>
<p>​          name_namelist[k] = “person_” + str(i+1)</p>
<p>​      # 矩形框</p>
<p>​      for kk, d in enumerate(faces):</p>
<p>​        # 绘制矩形框</p>
<p>​        cv2.rectangle(img_rd, tuple([d.left(), d.top()]), tuple([d.right(), d.bottom()]), (0, 255, 255), 2)</p>
<p>​    # 写人脸名字</p>
<p>​    for i in range(len(faces)):</p>
<p>​      cv2.putText(img_rd, name_namelist[i], pos_namelist[i], font, 0.8, (0, 255, 255), 1, cv2.LINE_AA)</p>
<p>  print(“Name list now:”, name_namelist, “\n”)</p>
<p>  cv2.putText(img_rd, “Face Register”, (20, 40), font, 1, (255, 255, 255), 1, cv2.LINE_AA)</p>
<p>  cv2.putText(img_rd, “Faces: “ + str(len(faces)), (20, 100), font, 1, (0, 0, 255), 1, cv2.LINE_AA)</p>
<p>  # 按下 q 键退出</p>
<p>  if kk == ord(‘q’):</p>
<p>​    break</p>
<p>  # 窗口显示</p>
<p>  cv2.imshow(“camera”, img_rd)</p>
<p># 释放摄像头</p>
<p>cap.release()</p>
<p># 删除建立的窗口</p>
<p>cv2.destroyAllWindows()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<p><a href="http:"><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/copycode.gif" alt="复制代码"></a></p>
<p>　<strong>face_reco_from_camera.py</strong> 输出 log：</p>
<p><a href="http:"><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Faces in Database： 5Name list now: [] </span><br><span class="line"></span><br><span class="line">Name list now: [] </span><br><span class="line"></span><br><span class="line">Name list now: [] </span><br><span class="line"></span><br><span class="line">Name list now: [] </span><br><span class="line"></span><br><span class="line">Name list now: [] </span><br><span class="line"></span><br><span class="line">with person_ 1 the e_distance:  0.40770022710364756with person_ 2 the e_distance:  0.41082186674421134with person_ 3 the e_distance:  0.3961545573801463with person_ 4 the e_distance:  0.3881850644563972with person_ 5 the e_distance:  0.3495735780870818Name list now: [&#x27;person_4&#x27;] </span><br><span class="line"></span><br><span class="line">with person_ 1 the e_distance:  0.4314467101915446with person_ 2 the e_distance:  0.4299990464683071with person_ 3 the e_distance:  0.4182695008637471with person_ 4 the e_distance:  0.4173694262729763with person_ 5 the e_distance:  0.38357217732017734Name list now: [&#x27;person_4&#x27;] </span><br><span class="line"></span><br><span class="line">with person_ 1 the e_distance:  0.4262991040992263with person_ 2 the e_distance:  0.43254966504500664with person_ 3 the e_distance:  0.41576433114841965with person_ 4 the e_distance:  0.4122140311433292with person_ 5 the e_distance:  0.38073570942005236Name list now: [&#x27;person_4&#x27;] </span><br><span class="line"></span><br><span class="line">with person_ 1 the e_distance:  0.42088261541728456with person_ 2 the e_distance:  0.42064499551908163with person_ 3 the e_distance:  0.404443147870785with person_ 4 the e_distance:  0.4043774203639022with person_ 5 the e_distance:  0.37271089160417986Name list now: [&#x27;person_4&#x27;] </span><br></pre></td></tr></table></figure>
<p><a href="http:"><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/copycode.gif" alt="复制代码"></a></p>
<p>　　实时输出结果：</p>
<p><img src="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/1152352-20180511181802460-722994837.png" alt="img"></p>
<p><strong>图 9 实时输出的欧氏距离结果</strong></p>
<p>　　通过实时的输出结果，看的比较明显；</p>
<p>　　输出绿色部分：当是我自己时，计算出来的欧式距离基本都在 <strong>0.2 左右</strong>；</p>
<p>　　输出红色部分：而换一张图片上去比如特朗普，明显看到欧式距离计算结果 <strong>达到了 0.8</strong>，此时就可以判定，后来这张人脸不是一张人脸；</p>
<p>　　所以之前提到的欧式距离计算对比的阈值可以由此设定，本项目中取的是 <strong>dist=0.4；</strong></p>
<p>　　 <strong>dist 的确切取值自己权衡，<a target="_blank" rel="noopener" href="http://dlib.net/face_recognition.py.html">http://dlib.net/face_recognition.py.html</a> 的说明：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#   When using a distance threshold of 0.6, the dlib model obtains an accuracy#   of 99.38% on the standard LFW face recognition benchmark, which is#   comparable to other state-of-the-art methods for face recognition as of#   February 2017. This accuracy means that, when presented with a pair of face#   images, the tool will correctly identify if the pair belongs to the same#   person or is from different people 99.38% of the time.</span><br></pre></td></tr></table></figure>
<p><strong>3. 总结</strong></p>
<p>　　核心就是 <strong>提取人脸特征，然后计算欧式距离和预设的特征脸进行比对；</strong></p>
<p>　　不过这个实时获取摄像头人脸进行比对，要实时的进行计算摄像头脸的特征值，然后还要计算欧氏距离，所以计算量比较大，可能摄像头视频流会出现卡顿；</p>
<p>　　此项目仅个人学习爱好研究，开源供大家一起学习；</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">萧宇</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://aichn.cn/post/375ec5b6.html">http://aichn.cn/post/375ec5b6.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://aichn.cn" target="_blank">君子兰萧宇的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Python/">-Python</a></div><div class="post_share"><div class="social-share" data-image="/../images/Python%203%20%E5%88%A9%E7%94%A8%20Dlib%20%E5%AE%9E%E7%8E%B0%E6%91%84%E5%83%8F%E5%A4%B4%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/1152352-20181029164755617-126045850.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/ac5db05f.html"><img class="prev-cover" src="/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Python实现简单的API接口</div></div></a></div><div class="next-post pull-right"><a href="/post/f16a9029.html"><img class="next-cover" src="/../images/Python%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98-%E5%9B%9E%E5%BD%92%E5%88%86%E6%9E%90/20180101170859622" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Python数据挖掘-回归分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/ac5db05f.html" title="Python实现简单的API接口"><img class="cover" src="/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-12-23</div><div class="title">Python实现简单的API接口</div></div></a></div><div><a href="/post/f16a9029.html" title="Python数据挖掘-回归分析"><img class="cover" src="/../images/Python%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98-%E5%9B%9E%E5%BD%92%E5%88%86%E6%9E%90/20180101170859622" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-12-23</div><div class="title">Python数据挖掘-回归分析</div></div></a></div><div><a href="/post/830562ef.html" title="Python爬虫的N种姿势"><img class="cover" src="/../images/Python%E7%88%AC%E8%99%AB%E7%9A%84N%E7%A7%8D%E5%A7%BF%E5%8A%BF/2019061709510421.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-12-23</div><div class="title">Python爬虫的N种姿势</div></div></a></div><div><a href="/post/e86121cf.html" title="python三步实现人脸识别"><img class="cover" src="/../images/python%E4%B8%89%E6%AD%A5%E5%AE%9E%E7%8E%B0%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/2C5ibeGc6h6RE3NWwi7njZj3Bh6bEXYB.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-12-23</div><div class="title">python三步实现人脸识别</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">萧宇</div><div class="author-info__description">学而不思则罔，思而不学则殆</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">163</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">87</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">36</div></a></div></div><a class="button--animated" id="card-info-btn" href="mailto:rennyshaw@163.com"><i class="fab fa-github"></i><span>联系我</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">姓名：萧宇 - 座右铭：读万卷书，行万里路 - QQ：164840753 - 手机号：13651208086</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/15292.html" title="Zerotier 搭建私有根服务器及创建虚拟局域网完整教程"><img src="/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Zerotier 搭建私有根服务器及创建虚拟局域网完整教程"/></a><div class="content"><a class="title" href="/post/15292.html" title="Zerotier 搭建私有根服务器及创建虚拟局域网完整教程">Zerotier 搭建私有根服务器及创建虚拟局域网完整教程</a><time datetime="2023-08-18T10:08:18.000Z" title="发表于 2023-08-18 18:08:18">2023-08-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/f7788cdd.html" title="在pve上直接安装macos13 Ventura 初步优化并直通显卡 蓝牙 wifi 声卡给macos"><img src="/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="在pve上直接安装macos13 Ventura 初步优化并直通显卡 蓝牙 wifi 声卡给macos"/></a><div class="content"><a class="title" href="/post/f7788cdd.html" title="在pve上直接安装macos13 Ventura 初步优化并直通显卡 蓝牙 wifi 声卡给macos">在pve上直接安装macos13 Ventura 初步优化并直通显卡 蓝牙 wifi 声卡给macos</a><time datetime="2023-02-15T09:27:36.000Z" title="发表于 2023-02-15 17:27:36">2023-02-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/49be3a04.html" title="dockerkubeadm安装"><img src="/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="dockerkubeadm安装"/></a><div class="content"><a class="title" href="/post/49be3a04.html" title="dockerkubeadm安装">dockerkubeadm安装</a><time datetime="2022-12-02T13:06:36.000Z" title="发表于 2022-12-02 21:06:36">2022-12-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/e0cfee7a.html" title="群晖NAS搭建GitServer并配置权限与SSH秘钥免密登陆"><img src="/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="群晖NAS搭建GitServer并配置权限与SSH秘钥免密登陆"/></a><div class="content"><a class="title" href="/post/e0cfee7a.html" title="群晖NAS搭建GitServer并配置权限与SSH秘钥免密登陆">群晖NAS搭建GitServer并配置权限与SSH秘钥免密登陆</a><time datetime="2021-12-23T13:06:36.000Z" title="发表于 2021-12-23 21:06:36">2021-12-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/7d9f7df6.html" title="Axhub Charts Pro 帮助文档"><img src="/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Axhub Charts Pro 帮助文档"/></a><div class="content"><a class="title" href="/post/7d9f7df6.html" title="Axhub Charts Pro 帮助文档">Axhub Charts Pro 帮助文档</a><time datetime="2019-12-23T13:06:36.000Z" title="发表于 2019-12-23 21:06:36">2019-12-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">Copyright &copy; 1993 - 2025 By 萧宇</div><div class="framework-info"><span>框架 By </span><a href="http://aichn.cn">Aichn.cn</a><span class="footer-separator">|</span><span>主题 By </span><a href="http://aichn.cn">萧宇的博客</a></div><div class="icp"><a href="https://beian.miit.gov.cn" target="_blank"><img class="lozad" data-src="/img/beian.png" onerror="onerror=null;src='/img/beian.png'" style="padding:0px;vertical-align: text-bottom;"/><span>沪ICP备18015875号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>